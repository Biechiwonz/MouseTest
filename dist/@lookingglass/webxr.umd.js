(function(m,P){typeof exports=="object"&&typeof module<"u"?P(exports,require("@lookingglass/webxr-polyfill/src/api/index"),require("@lookingglass/webxr-polyfill/src/api/XRSystem"),require("@lookingglass/webxr-polyfill/src/WebXRPolyfill"),require("holoplay-core"),require("@lookingglass/webxr-polyfill/src/devices/XRDevice"),require("@lookingglass/webxr-polyfill/src/api/XRSpace"),require("gl-matrix"),require("@lookingglass/webxr-polyfill/src/api/XRWebGLLayer")):typeof define=="function"&&define.amd?define(["exports","@lookingglass/webxr-polyfill/src/api/index","@lookingglass/webxr-polyfill/src/api/XRSystem","@lookingglass/webxr-polyfill/src/WebXRPolyfill","holoplay-core","@lookingglass/webxr-polyfill/src/devices/XRDevice","@lookingglass/webxr-polyfill/src/api/XRSpace","gl-matrix","@lookingglass/webxr-polyfill/src/api/XRWebGLLayer"],P):(m=typeof globalThis<"u"?globalThis:m||self,P(m["Looking Glass WebXR"]={},m["@lookingglass/webxr-polyfill/src/api/index"],m["@lookingglass/webxr-polyfill/src/api/XRSystem"],m["@lookingglass/webxr-polyfill/src/WebXRPolyfill"],m.holoPlayCore,m["@lookingglass/webxr-polyfill/src/devices/XRDevice"],m["@lookingglass/webxr-polyfill/src/api/XRSpace"],m.glMatrix,m["@lookingglass/webxr-polyfill/src/api/XRWebGLLayer"]))})(this,function(m,P,G,ee,z,te,ne,w,K){"use strict";var Ae=Object.defineProperty;var Ie=(m,P,G)=>P in m?Ae(m,P,{enumerable:!0,configurable:!0,writable:!0,value:G}):m[P]=G;var S=(m,P,G)=>(Ie(m,typeof P!="symbol"?P+"":P,G),G);const N=r=>r&&typeof r=="object"&&"default"in r?r:{default:r};function ie(r){if(r&&r.__esModule)return r;const n=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(r){for(const e in r)if(e!=="default"){const o=Object.getOwnPropertyDescriptor(r,e);Object.defineProperty(n,e,o.get?o:{enumerable:!0,get:()=>r[e]})}}return n.default=r,Object.freeze(n)}const Z=N(P),oe=N(G),re=N(ee),ae=ie(z),se=N(te),ce=N(ne),le=N(K),Y=1.6;let H=3360;var j;(function(r){r[r.Swizzled=0]="Swizzled",r[r.Center=1]="Center",r[r.Quilt=2]="Quilt"})(j||(j={}));class de extends EventTarget{constructor(e){super();S(this,"_calibration",{configVersion:"1.0",pitch:{value:45},slope:{value:-5},center:{value:-.5},viewCone:{value:40},invView:{value:1},verticalAngle:{value:0},DPI:{value:338},screenW:{value:250},screenH:{value:250},flipImageX:{value:0},flipImageY:{value:0},flipSubp:{value:0}});S(this,"_viewControls",{tileHeight:512,numViews:45,trackballX:0,trackballY:0,targetX:0,targetY:Y,targetZ:-.5,targetDiam:2,fovy:13/180*Math.PI,depthiness:1.25,inlineView:j.Center});this._viewControls={...this._viewControls,...e},this.syncCalibration()}syncCalibration(){new ae.Client(e=>{if(e.devices.length<1){console.error("No Looking Glass devices found!");return}e.devices.length>1&&console.warn("More than one Looking Glass device found... using the first one"),this.calibration=e.devices[0].calibration,this.calibration.screenH.value=3360,this.calibration.screenW.value=3360},e=>{console.error("Error creating Looking Glass client:",e)})}addEventListener(e,o,t){super.addEventListener(e,o,t)}onConfigChange(){this.dispatchEvent(new Event("on-config-changed"))}get calibration(){return this._calibration}set calibration(e){this._calibration={...this._calibration,...e},this.onConfigChange()}updateViewControls(e){e!=null&&(this._viewControls={...this._viewControls,...e},this.onConfigChange())}get tileHeight(){return H/6}set tileHeight(e){}get numViews(){return 48}get targetX(){return this._viewControls.targetX}set targetX(e){this.updateViewControls({targetX:e})}get targetY(){return this._viewControls.targetY}set targetY(e){this.updateViewControls({targetY:e})}get targetZ(){return this._viewControls.targetZ}set targetZ(e){this.updateViewControls({targetZ:e})}get trackballX(){return this._viewControls.trackballX}set trackballX(e){this.updateViewControls({trackballX:e})}get trackballY(){return this._viewControls.trackballY}set trackballY(e){this.updateViewControls({trackballY:e})}get targetDiam(){return this._viewControls.targetDiam}set targetDiam(e){this.updateViewControls({targetDiam:e})}get fovy(){return this._viewControls.fovy}set fovy(e){this.updateViewControls({fovy:e})}get depthiness(){return this._viewControls.depthiness}set depthiness(e){this.updateViewControls({depthiness:e})}get inlineView(){return this._viewControls.inlineView}set inlineView(e){this.updateViewControls({inlineView:e})}get aspect(){return .75}get tileWidth(){return H/8}get framebufferWidth(){return this._calibration.screenW.value<8e3?H:8192}get quiltWidth(){return 8}get quiltHeight(){return 6}get framebufferHeight(){return this._calibration.screenW.value<8e3?H:8192}get viewCone(){return this._calibration.viewCone.value*this.depthiness/180*Math.PI}get tilt(){return this._calibration.screenH.value/(this._calibration.screenW.value*this._calibration.slope.value)*(this._calibration.flipImageX.value?-1:1)}get subp(){return 1/(this._calibration.screenW.value*3)}get pitch(){const e=this._calibration.screenW.value/this._calibration.DPI.value;return this._calibration.pitch.value*e*Math.cos(Math.atan(1/this._calibration.slope.value))}}let q=null;function I(){return q==null&&(q=new de),q}function $(r){const n=I();r!=null&&n.updateViewControls(r)}function ue(r){const n=new MediaSource;n.addEventListener("sourceopen",E,!1);let e,o,t,a;const d=document.getElementById("video"),f=document.getElementById("recordbutton"),l=document.getElementById("playbutton"),v=document.getElementById("downloadbutton");f.onclick=V,l.onclick=_,v.onclick=B;function E(i){console.log("MediaSource opened"),t=n.addSourceBuffer('video/webm; codecs="h264"'),console.log("Source buffer: ",t)}function T(i){i.data&&i.data.size>0&&o.push(i.data)}function y(i){console.log("Recorder stopped: ",i);const c=new Blob(o,{type:"video/webm"});d.src=window.URL.createObjectURL(c)}function V(){a=r.captureStream(),console.log("Started stream capture from canvas element: ",a),f.textContent==="Record"?C():(u(),f.textContent="Record",l.disabled=!1,v.disabled=!1)}function C(){let i={mimeType:"video/webm"};o=[];try{e=new MediaRecorder(a,i)}catch(c){console.log("Unable to create MediaRecorder with options Object: ",c);try{i={mimeType:"video/webm,codecs=h264"},e=new MediaRecorder(a,i)}catch(s){console.log("Unable to create MediaRecorder with options Object: ",s);try{i={mimeType:"video/h264"},e=new MediaRecorder(a,i)}catch(h){alert(`MediaRecorder is not supported by this browser.

Try Firefox 29 or later, or Chrome 47 or later, with Enable experimental Web Platform features enabled from chrome://flags.`),console.error("Exception while creating MediaRecorder:",h);return}}}console.log("Created MediaRecorder",e,"with options",i),f.textContent="Stop Recording",l.disabled=!0,v.disabled=!0,e.onstop=y,e.ondataavailable=T,e.start(100),console.log("MediaRecorder started",e)}function u(){e.stop(),console.log("Recorded Blobs: ",o),d.controls=!0}function _(){d.play()}function B(){const i=new Blob(o,{type:"video/webm"}),c=window.URL.createObjectURL(i),s=document.createElement("a");s.style.display="none",s.href=c,s.download="hologram_qs8x6a0.75.webm",document.body.appendChild(s),s.click(),setTimeout(()=>{document.body.removeChild(s),window.URL.revokeObjectURL(c)},100)}}function he(r,n){var B;const e=I(),o=document.createElement("style");document.head.appendChild(o),(B=o.sheet)==null||B.insertRule("#LookingGlassWebXRControls * { all: revert; font-family: sans-serif }");const t=document.createElement("div");t.id="LookingGlassWebXRControls",t.style.position="fixed",t.style.zIndex="1000",t.style.padding="15px",t.style.width="320px",t.style.maxWidth="calc(100vw - 18px)",t.style.maxHeight="calc(100vh - 18px)",t.style.whiteSpace="nowrap",t.style.background="rgba(0, 0, 0, 0.6)",t.style.color="white",t.style.borderRadius="10px",t.style.right="15px",t.style.bottom="15px",t.style.flex="row";const a=document.createElement("div");t.appendChild(a),a.style.width="100%",a.style.textAlign="center",a.style.fontWeight="bold",a.innerText="Looking Glass Controls";const d=document.createElement("button");d.innerText="Record",t.appendChild(d),d.id="recordbutton";const f=document.createElement("button");f.innerText="Play",t.appendChild(f),f.id="playbutton";const l=document.createElement("button");l.innerText="Download Video",t.appendChild(l),l.id="downloadbutton";const v=document.createElement("video");t.appendChild(v),v.id="video",v.width=240,v.height=320,v.style.backgroundColor="black",v.style.display="none";const E=document.createElement("button");t.appendChild(E),E.innerText="Take Screenshot",E.onclick=()=>{const c=document.getElementById("renderCanvas").toDataURL("image/png");let s=document.createElement("a");s.download="screenshot.png",s.href=c,t.appendChild(s),s.click(),t.removeChild(s)};const T=document.createElement("div");t.appendChild(T),T.style.width="100%",T.style.whiteSpace="normal",T.style.color="rgba(255,255,255,0.7)",T.style.fontSize="14px",T.style.margin="5px 0",T.innerHTML="Click the popup and use WASD, mouse left/right drag, and scroll.";const y=document.createElement("input");a.appendChild(y),y.type="button",y.value="\u2190",y.dataset.otherValue="\u2192",y.onclick=()=>{[t.style.right,t.style.left]=[t.style.left,t.style.right],[y.value,y.dataset.otherValue]=[y.dataset.otherValue||"",y.value]};const V=document.createElement("div");t.appendChild(V);const C=(i,c,s)=>{const h=s.stringify,p=document.createElement("div");p.style.marginBottom="8px",V.appendChild(p);const L=i,M=e[i],x=document.createElement("label");p.appendChild(x),x.innerText=s.label,x.setAttribute("for",L),x.style.width="100px",x.style.display="inline-block",x.style.textDecoration="dotted underline 1px",x.style.fontFamily='"Courier New"',x.style.fontSize="13px",x.style.fontWeight="bold",x.title=s.title;const b=document.createElement("input");p.appendChild(b),Object.assign(b,c),b.id=L,b.title=s.title,b.value=c.value!==void 0?c.value:M;const U=g=>{e[i]=g,O(g)};b.oninput=()=>{const g=c.type==="range"?parseFloat(b.value):c.type==="checkbox"?b.checked:b.value;U(g)};const W=g=>{let k=g(e[i]);s.fixRange&&(k=s.fixRange(k),b.max=Math.max(parseFloat(b.max),k).toString(),b.min=Math.min(parseFloat(b.min),k).toString()),b.value=k,U(k)};c.type==="range"&&(b.style.width="110px",b.style.height="8px",b.onwheel=g=>{W(k=>k+Math.sign(g.deltaX-g.deltaY)*c.step)});let O=g=>{};if(h){const g=document.createElement("span");g.style.fontFamily='"Courier New"',g.style.fontSize="13px",g.style.marginLeft="3px",p.appendChild(g),O=k=>{g.innerHTML=h(k)},O(M)}return W};C("fovy",{type:"range",min:1/180*Math.PI,max:120.1/180*Math.PI,step:1/180*Math.PI},{label:"fov",title:"perspective fov (degrades stereo effect)",fixRange:i=>Math.max(1/180*Math.PI,Math.min(i,120.1/180*Math.PI)),stringify:i=>{const c=i/Math.PI*180,s=Math.atan(Math.tan(i/2)*e.aspect)*2/Math.PI*180;return`${c.toFixed()}&deg;&times;${s.toFixed()}&deg;`}}),C("depthiness",{type:"range",min:0,max:2,step:.01},{label:"depthiness",title:'exaggerates depth by multiplying the width of the view cone (as reported by the firmware) - can somewhat compensate for depthiness lost using higher fov. 1.25 seems to be most physically accurate on Looking Glass 8.9".',fixRange:i=>Math.max(0,i),stringify:i=>`${i.toFixed(2)}x`}),r.oncontextmenu=i=>{i.preventDefault()},r.addEventListener("wheel",i=>{const c=e.targetDiam,s=1.1,h=Math.log(c)/Math.log(s);return e.targetDiam=Math.pow(s,h+i.deltaY*.01)}),r.addEventListener("mousemove",i=>{const c=i.movementX,s=-i.movementY;if(i.buttons&2||i.buttons&1&&(i.shiftKey||i.ctrlKey)){const h=e.trackballX,p=e.trackballY,L=-Math.cos(h)*c+Math.sin(h)*Math.sin(p)*s,M=-Math.cos(p)*s,x=Math.sin(h)*c+Math.cos(h)*Math.sin(p)*s;e.targetX=e.targetX+L*e.targetDiam*.001,e.targetY=e.targetY+M*e.targetDiam*.001,e.targetZ=e.targetZ+x*e.targetDiam*.001}else i.buttons&1&&(e.trackballX=e.trackballX-c*.01,e.trackballY=e.trackballY-s*.01)});const u={w:0,a:0,s:0,d:0};r.addEventListener("keydown",i=>{switch(i.code){case"KeyW":u.w=1;break;case"KeyA":u.a=1;break;case"KeyS":u.s=1;break;case"KeyD":u.d=1;break}}),r.addEventListener("keyup",i=>{switch(i.code){case"KeyW":u.w=0;break;case"KeyA":u.a=0;break;case"KeyS":u.s=0;break;case"KeyD":u.d=0;break}}),requestAnimationFrame(_);function _(){let i=u.d-u.a,c=u.w-u.s;i&&c&&(i*=Math.sqrt(.5),c*=Math.sqrt(.5));const s=e.trackballX,h=e.trackballY,p=Math.cos(s)*i-Math.sin(s)*Math.cos(h)*c,L=-Math.sin(h)*c,M=-Math.sin(s)*i-Math.cos(s)*Math.cos(h)*c;e.targetX=e.targetX+p*e.targetDiam*.03,e.targetY=e.targetY+L*e.targetDiam*.03,e.targetZ=e.targetZ+M*e.targetDiam*.03,requestAnimationFrame(_)}return setTimeout(()=>{ue(n)},1e3),t}const D=Symbol("LookingGlassXRWebGLLayer");class fe extends le.default{constructor(n,e,o){super(n,e,o);const t=e.canvas,a=document.createElement("canvas");a.tabIndex=0;const d=a.getContext("2d",{alpha:!1});a.addEventListener("dblclick",function(){a.width=1536,a.height=2048,this.requestFullscreen()});const f=he(a,t),l=I(),v=this[K.PRIVATE].config,E=e.createTexture();let T,y;const V=e.createFramebuffer(),C=e.enable.bind(e),u=e.disable.bind(e),_=e.getExtension("OES_vertex_array_object"),B=34229,i=_?_.bindVertexArrayOES.bind(_):e.bindVertexArray.bind(e);(v.depth||v.stencil)&&(v.depth&&v.stencil?y={format:e.DEPTH_STENCIL,attachment:e.DEPTH_STENCIL_ATTACHMENT}:v.depth?y={format:e.DEPTH_COMPONENT16,attachment:e.DEPTH_ATTACHMENT}:v.stencil&&(y={format:e.STENCIL_INDEX8,attachment:e.STENCIL_ATTACHMENT}),T=e.createRenderbuffer());const c=()=>{const R=e.getParameter(e.TEXTURE_BINDING_2D);if(e.bindTexture(e.TEXTURE_2D,E),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,l.framebufferWidth,l.framebufferHeight,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.bindTexture(e.TEXTURE_2D,R),T){const A=e.getParameter(e.RENDERBUFFER_BINDING);e.bindRenderbuffer(e.RENDERBUFFER,T),e.renderbufferStorage(e.RENDERBUFFER,y.format,l.framebufferWidth,l.framebufferHeight),e.bindRenderbuffer(e.RENDERBUFFER,A)}};c(),l.addEventListener("on-config-changed",c);const s=e.getParameter(e.FRAMEBUFFER_BINDING);e.bindFramebuffer(e.FRAMEBUFFER,V),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,E,0),(v.depth||v.stencil)&&e.framebufferRenderbuffer(e.FRAMEBUFFER,y.attachment,e.RENDERBUFFER,T),e.bindFramebuffer(e.FRAMEBUFFER,s);const h=e.createProgram(),p=e.createShader(e.VERTEX_SHADER);e.attachShader(h,p);const L=e.createShader(e.FRAGMENT_SHADER);e.attachShader(h,L);{const R=`
       attribute vec2 a_position;
       varying vec2 v_texcoord;
       void main() {
         gl_Position = vec4(a_position * 2.0 - 1.0, 0.0, 1.0);
         v_texcoord = a_position;
       }
     `;e.shaderSource(p,R),e.compileShader(p),e.getShaderParameter(p,e.COMPILE_STATUS)||console.warn(e.getShaderInfoLog(p))}let M,x,b;const U=()=>{const R=z.Shader(l);if(R===M)return;if(M=R,e.shaderSource(L,R),e.compileShader(L),!e.getShaderParameter(L,e.COMPILE_STATUS)){console.warn(e.getShaderInfoLog(L));return}if(e.linkProgram(h),!e.getProgramParameter(h,e.LINK_STATUS)){console.warn(e.getProgramInfoLog(h));return}x=e.getAttribLocation(h,"a_position"),b=e.getUniformLocation(h,"u_viewType");const A=e.getUniformLocation(h,"u_texture"),X=e.getParameter(e.CURRENT_PROGRAM);e.useProgram(h),e.uniform1i(A,0),e.useProgram(X)};l.addEventListener("on-config-changed",U);const W=_?_.createVertexArrayOES():e.createVertexArray(),O=e.createBuffer(),g=e.getParameter(e.ARRAY_BUFFER_BINDING),k=e.getParameter(B);i(W),e.bindBuffer(e.ARRAY_BUFFER,O),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW),e.enableVertexAttribArray(x),e.vertexAttribPointer(x,2,e.FLOAT,!1,0,0),i(k),e.bindBuffer(e.ARRAY_BUFFER,g);const Re=()=>{console.assert(this[D].LookingGlassEnabled),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer);const R=e.getParameter(e.COLOR_CLEAR_VALUE),A=e.getParameter(e.DEPTH_CLEAR_VALUE),X=e.getParameter(e.STENCIL_CLEAR_VALUE);e.clearColor(0,0,0,0),e.clearDepth(1),e.clearStencil(0),e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT|e.STENCIL_BUFFER_BIT),e.clearColor(R[0],R[1],R[2],R[3]),e.clearDepth(A),e.clearStencil(X)};let Q,J;const Te=()=>{if(!this[D].LookingGlassEnabled)return;(t.width!==l.calibration.screenW.value||t.height!==l.calibration.screenH.value)&&(console.log("warning, the canvas is not the correct size!"),console.log("app",t.width,"width",t.height,"height"),console.log("looking glass",a.width,"width",a.height,"height"),Q=t.width,J=t.height,t.width=l.calibration.screenW.value,t.height=l.calibration.screenH.value,console.log("new width and height",t.width,"width",t.height,"height"));const R=e.getParameter(B),A=e.getParameter(e.CULL_FACE),X=e.getParameter(e.BLEND),xe=e.getParameter(e.DEPTH_TEST),_e=e.getParameter(e.STENCIL_TEST),Ce=e.getParameter(e.SCISSOR_TEST),Se=e.getParameter(e.VIEWPORT),Pe=e.getParameter(e.FRAMEBUFFER_BINDING),ke=e.getParameter(e.RENDERBUFFER_BINDING),Fe=e.getParameter(e.CURRENT_PROGRAM),Be=e.getParameter(e.ACTIVE_TEXTURE);{const Me=e.getParameter(e.TEXTURE_BINDING_2D);e.bindFramebuffer(e.FRAMEBUFFER,null),e.useProgram(h),i(W),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,E),e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.STENCIL_TEST),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),e.uniform1i(b,0),e.drawArrays(e.TRIANGLES,0,6),d==null||d.clearRect(0,0,a.width,a.height),d==null||d.drawImage(t,0,0),l.inlineView!==0&&(e.uniform1i(b,l.inlineView),e.drawArrays(e.TRIANGLES,0,6)),e.bindTexture(e.TEXTURE_2D,Me)}e.activeTexture(Be),e.useProgram(Fe),e.bindRenderbuffer(e.RENDERBUFFER,ke),e.bindFramebuffer(e.FRAMEBUFFER,Pe),e.viewport(...Se),(Ce?C:u)(e.SCISSOR_TEST),(_e?C:u)(e.STENCIL_TEST),(xe?C:u)(e.DEPTH_TEST),(X?C:u)(e.BLEND),(A?C:u)(e.CULL_FACE),i(R)};let F;window.addEventListener("unload",()=>{F&&F.close(),F=void 0});const Le=(R,A)=>{var X;!!F!=R&&(R?(U(),a.style.position="fixed",a.style.bottom="0",a.style.left="0",a.style.width="1536",a.style.height="2048",a.width=l.calibration.screenW.value,a.height=l.calibration.screenH.value,document.body.appendChild(f),F=window.open("",void 0,"width=640,height=360"),F.document.title="Looking Glass Window (fullscreen me on Looking Glass!)",F.document.body.style.background="black",F.document.body.appendChild(a),console.assert(A),F.onbeforeunload=A):((X=f.parentElement)==null||X.removeChild(f),t.width=Q,t.height=J,F.onbeforeunload=void 0,F.close(),F=void 0))};this[D]={LookingGlassEnabled:!1,framebuffer:V,clearFramebuffer:Re,blitTextureToDefaultFramebufferIfNeeded:Te,moveCanvasToWindow:Le}}get framebuffer(){return this[D].LookingGlassEnabled?this[D].framebuffer:null}get framebufferWidth(){return I().framebufferWidth}get framebufferHeight(){return I().framebufferHeight}}class me extends se.default{constructor(n){super(n),this.sessions=new Map,this.viewSpaces=[],this.basePoseMatrix=w.mat4.create(),this.inlineProjectionMatrix=w.mat4.create(),this.inlineInverseViewMatrix=w.mat4.create(),this.LookingGlassProjectionMatrices=[],this.LookingGlassInverseViewMatrices=[]}onBaseLayerSet(n,e){const o=this.sessions.get(n);o.baseLayer=e;const t=e[D];t.LookingGlassEnabled=o.immersive,o.immersive&&t.moveCanvasToWindow(!0,()=>{this.endSession(n)})}isSessionSupported(n){return n==="inline"||n==="immersive-vr"}isFeatureSupported(n){switch(n){case"viewer":return!0;case"local":return!0;case"local-floor":return!0;case"bounded-floor":return!1;case"unbounded":return!1;default:return console.warn("LookingGlassXRDevice.isFeatureSupported: feature not understood:",n),!1}}async requestSession(n,e){if(!this.isSessionSupported(n))return Promise.reject();const o=n!=="inline",t=new be(n,e);return this.sessions.set(t.id,t),o&&this.dispatchEvent("@@webxr-polyfill/vr-present-start",t.id),Promise.resolve(t.id)}requestAnimationFrame(n){return this.global.requestAnimationFrame(n)}cancelAnimationFrame(n){this.global.cancelAnimationFrame(n)}onFrameStart(n,e){const o=this.sessions.get(n),t=I();if(o.immersive){const a=Math.tan(.5*t.fovy),d=.5*t.targetDiam/a,f=d-t.targetDiam,l=this.basePoseMatrix;w.mat4.fromTranslation(l,[t.targetX,t.targetY,t.targetZ]),w.mat4.rotate(l,l,t.trackballX,[0,1,0]),w.mat4.rotate(l,l,-t.trackballY,[1,0,0]),w.mat4.translate(l,l,[0,0,d]);for(let E=0;E<t.numViews;++E){const T=(E+.5)/t.numViews-.5,y=Math.tan(t.viewCone*T),V=d*y,C=this.LookingGlassInverseViewMatrices[E]=this.LookingGlassInverseViewMatrices[E]||w.mat4.create();w.mat4.translate(C,l,[V,0,0]),w.mat4.invert(C,C);const u=Math.max(f+e.depthNear,.01),_=f+e.depthFar,B=u*a,i=B,c=-B,s=u*-y,h=t.aspect*B,p=s+h,L=s-h,M=this.LookingGlassProjectionMatrices[E]=this.LookingGlassProjectionMatrices[E]||w.mat4.create();w.mat4.set(M,2*u/(p-L),0,0,0,0,2*u/(i-c),0,0,(p+L)/(p-L),(i+c)/(i-c),-(_+u)/(_-u),-1,0,0,-2*_*u/(_-u),0)}o.baseLayer[D].clearFramebuffer()}else{const a=o.baseLayer.context,d=a.drawingBufferWidth/a.drawingBufferHeight;w.mat4.perspective(this.inlineProjectionMatrix,e.inlineVerticalFieldOfView,d,e.depthNear,e.depthFar),w.mat4.fromTranslation(this.basePoseMatrix,[0,Y,0]),w.mat4.invert(this.inlineInverseViewMatrix,this.basePoseMatrix)}}onFrameEnd(n){this.sessions.get(n).baseLayer[D].blitTextureToDefaultFramebufferIfNeeded()}async requestFrameOfReferenceTransform(n,e){const o=w.mat4.create();switch(n){case"viewer":case"local":return w.mat4.fromTranslation(o,[0,-Y,0]),o;case"local-floor":return o;default:throw new Error("XRReferenceSpaceType not understood")}}endSession(n){const e=this.sessions.get(n);e.immersive&&e.baseLayer&&(e.baseLayer[D].moveCanvasToWindow(!1),this.dispatchEvent("@@webxr-polyfill/vr-present-end",n)),e.ended=!0}doesSessionSupportReferenceSpace(n,e){const o=this.sessions.get(n);return o.ended?!1:o.enabledFeatures.has(e)}getViewSpaces(n){if(n==="immersive-vr"){const e=I();for(let o=this.viewSpaces.length;o<e.numViews;++o)this.viewSpaces[o]=new ve(o);return this.viewSpaces.length=e.numViews,this.viewSpaces}}getViewport(n,e,o,t,a){if(a===void 0){const f=this.sessions.get(n).baseLayer.context;t.x=0,t.y=0,t.width=f.drawingBufferWidth,t.height=f.drawingBufferHeight}else{const d=I(),f=a%d.quiltWidth,l=Math.floor(a/d.quiltWidth);t.x=d.tileWidth*f,t.y=d.tileHeight*l,t.width=d.tileWidth,t.height=d.tileHeight}return!0}getProjectionMatrix(n,e){return e===void 0?this.inlineProjectionMatrix:this.LookingGlassProjectionMatrices[e]||w.mat4.create()}getBasePoseMatrix(){return this.basePoseMatrix}getBaseViewMatrix(){return this.inlineInverseViewMatrix}_getViewMatrixByIndex(n){return this.LookingGlassInverseViewMatrices[n]=this.LookingGlassInverseViewMatrices[n]||w.mat4.create()}getInputSources(){return[]}getInputPose(n,e,o){return null}onWindowResize(){}}let pe=0;class be{constructor(n,e){S(this,"mode");S(this,"immersive");S(this,"id");S(this,"baseLayer");S(this,"inlineVerticalFieldOfView");S(this,"ended");S(this,"enabledFeatures");this.mode=n,this.immersive=n==="immersive-vr"||n==="immersive-ar",this.id=++pe,this.baseLayer=null,this.inlineVerticalFieldOfView=Math.PI*.5,this.ended=!1,this.enabledFeatures=e}}class ve extends ce.default{constructor(e){super();S(this,"viewIndex");this.viewIndex=e}get eye(){return"none"}_onPoseUpdate(e){this._inverseBaseMatrix=e._getViewMatrixByIndex(this.viewIndex)}}class ye extends re.default{constructor(e){super();S(this,"vrButton");S(this,"device");S(this,"isPresenting",!1);$(e),this.overrideDefaultVRButton(),console.warn('Looking Glass WebXR "polyfill" overriding native WebXR API.');for(const o in Z.default)this.global[o]=Z.default[o];this.global.XRWebGLLayer=fe,this.injected=!0,this.device=new me(this.global),this.xr=new oe.default(Promise.resolve(this.device)),Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})}async overrideDefaultVRButton(){this.vrButton=await we("VRButton"),this.vrButton&&(this.device.addEventListener("@@webxr-polyfill/vr-present-start",()=>{this.isPresenting=!0,this.updateVRButtonUI()}),this.device.addEventListener("@@webxr-polyfill/vr-present-end",()=>{this.isPresenting=!1,this.updateVRButtonUI()}),this.vrButton.addEventListener("click",e=>{this.updateVRButtonUI()}),this.updateVRButtonUI())}async updateVRButtonUI(){if(this.vrButton){await ge(100),this.isPresenting?this.vrButton.innerHTML="EXIT LOOKING GLASS":this.vrButton.innerHTML="ENTER LOOKING GLASS";const e=220;this.vrButton.style.width=`${e}px`,this.vrButton.style.left=`calc(50% - ${e/2}px)`}}update(e){$(e)}}async function we(r){return new Promise((n,e)=>{const o=new MutationObserver(function(t){t.forEach(function(a){a.addedNodes.forEach(function(d){const f=d;f.id==r&&(n(f),o.disconnect())})})});o.observe(document.body,{subtree:!1,childList:!0}),setTimeout(()=>{o.disconnect(),e(`id:${r} not found`)},5e3)})}function ge(r){return new Promise(n=>setTimeout(n,r))}const Ee=I();m.LookingGlassConfig=Ee,m.LookingGlassWebXRPolyfill=ye,Object.defineProperties(m,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
