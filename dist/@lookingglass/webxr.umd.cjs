(function(x,B){typeof exports=="object"&&typeof module<"u"?B(exports,require("@lookingglass/webxr-polyfill/src/WebXRPolyfill"),require("@lookingglass/webxr-polyfill/src/api/XRSystem"),require("@lookingglass/webxr-polyfill/src/api/index"),require("@lookingglass/webxr-polyfill/src/devices/XRDevice"),require("@lookingglass/webxr-polyfill/src/api/XRSpace"),require("gl-matrix"),require("@lookingglass/webxr-polyfill/src/api/XRWebGLLayer"),require("holoplay-core/dist/holoplaycore.module.js"),require("holoplay-core")):typeof define=="function"&&define.amd?define(["exports","@lookingglass/webxr-polyfill/src/WebXRPolyfill","@lookingglass/webxr-polyfill/src/api/XRSystem","@lookingglass/webxr-polyfill/src/api/index","@lookingglass/webxr-polyfill/src/devices/XRDevice","@lookingglass/webxr-polyfill/src/api/XRSpace","gl-matrix","@lookingglass/webxr-polyfill/src/api/XRWebGLLayer","holoplay-core/dist/holoplaycore.module.js","holoplay-core"],B):(x=typeof globalThis<"u"?globalThis:x||self,B(x["Looking Glass WebXR"]={},x["@lookingglass/webxr-polyfill/src/WebXRPolyfill"],x["@lookingglass/webxr-polyfill/src/api/XRSystem"],x["@lookingglass/webxr-polyfill/src/api/index"],x["@lookingglass/webxr-polyfill/src/devices/XRDevice"],x["@lookingglass/webxr-polyfill/src/api/XRSpace"],x.glMatrix,x["@lookingglass/webxr-polyfill/src/api/XRWebGLLayer"],x.holoPlayCore,x.holoPlayCore))})(this,function(x,B,K,Z,$,J,p,O,Q,ee){"use strict";const D=n=>n&&typeof n=="object"&&"default"in n?n:{default:n};function te(n){if(n&&n.__esModule)return n;const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(n){for(const e in n)if(e!=="default"){const a=Object.getOwnPropertyDescriptor(n,e);Object.defineProperty(t,e,a.get?a:{enumerable:!0,get:()=>n[e]})}}return t.default=n,Object.freeze(t)}const ie=D(B),ne=D(K),Y=D(Z),ae=D($),se=D(J),re=D(O),oe=te(Q),U=1.6;let H;function I(){return H===void 0&&(H=le()),H}const ce={configVersion:"1.0",pitch:{value:45},slope:{value:-5},center:{value:-.5},viewCone:{value:40},invView:{value:1},verticalAngle:{value:0},DPI:{value:338},screenW:{value:250},screenH:{value:250},flipImageX:{value:0},flipImageY:{value:0},flipSubp:{value:0}},le=()=>new class extends EventTarget{constructor(){super();const n=t=>{t&&this.dispatchEvent(new Event("on-config-changed")),new Promise(a=>{this._ensureConfigChangeEvent=a}).then(()=>n(!0))};n(!1),this.calibration=ce,new oe.Client(t=>{if(t.devices.length<1){console.error("No Looking Glass devices found!");return}t.devices.length>1&&console.warn("More than one Looking Glass device found... using the first one"),this.calibration=t.devices[0].calibration},t=>{console.error("Error creating Looking Glass client:",t)}),this.tileHeight=512,this.numViews=45,this.trackballX=0,this.trackballY=0,this.targetX=0,this.targetY=U,this.targetZ=-.5,this.targetDiam=2,this.fovy=13/180*Math.PI,this.depthiness=1.25,this.inlineView=1}get calibration(){return this._calibration}set calibration(n){this._calibration=j(n),this._ensureConfigChangeEvent()}get tileHeight(){return this._tileHeight}set tileHeight(n){this._tileHeight=n,this._ensureConfigChangeEvent()}get numViews(){return this._numViews}set numViews(n){this._numViews=n,this._ensureConfigChangeEvent()}get targetX(){return this._targetX}set targetX(n){this._targetX=n,this._ensureConfigChangeEvent()}get targetY(){return this._targetY}set targetY(n){this._targetY=n,this._ensureConfigChangeEvent()}get targetZ(){return this._targetZ}set targetZ(n){this._targetZ=n,this._ensureConfigChangeEvent()}get trackballX(){return this._trackballX}set trackballX(n){this._trackballX=n,this._ensureConfigChangeEvent()}get trackballY(){return this._trackballY}set trackballY(n){this._trackballY=n,this._ensureConfigChangeEvent()}get targetDiam(){return this._targetDiam}set targetDiam(n){this._targetDiam=n,this._ensureConfigChangeEvent()}get fovy(){return this._fovy}set fovy(n){this._fovy=n,this._ensureConfigChangeEvent()}get depthiness(){return this._depthiness}set depthiness(n){this._depthiness=n,this._ensureConfigChangeEvent()}get inlineView(){return this._inlineView}set inlineView(n){this._inlineView=n,this._ensureConfigChangeEvent()}get aspect(){return this.calibration.screenW.value/this.calibration.screenH.value}get tileWidth(){return Math.round(this.tileHeight*this.aspect)}get framebufferWidth(){const n=this.tileWidth*this.tileHeight*this.numViews;return 2**Math.ceil(Math.log2(Math.max(Math.sqrt(n),this.tileWidth)))}get quiltWidth(){return Math.floor(this.framebufferWidth/this.tileWidth)}get quiltHeight(){return Math.ceil(this.numViews/this.quiltWidth)}get framebufferHeight(){return 2**Math.ceil(Math.log2(this.quiltHeight*this.tileHeight))}get viewCone(){return this.calibration.viewCone.value*this.depthiness/180*Math.PI}get tilt(){return this.calibration.screenH.value/(this.calibration.screenW.value*this.calibration.slope.value)*(this.calibration.flipImageX.value?-1:1)}get subp(){return 1/(this.calibration.screenW.value*3)}get pitch(){const n=this.calibration.screenW.value/this.calibration.DPI.value;return this.calibration.pitch.value*n*Math.cos(Math.atan(1/this.calibration.slope.value))}};function j(n){return Object.freeze(n),n===void 0||Object.getOwnPropertyNames(n).forEach(function(t){n[t]!==null&&(typeof n[t]=="object"||typeof n[t]=="function")&&!Object.isFrozen(n[t])&&j(n[t])}),n}function he(n){const t=I(),e=document.createElement("style");document.head.appendChild(e),e.sheet.insertRule("#LookingGlassWebXRControls * { all: revert; font-family: sans-serif }");const a=document.createElement("div");a.id="LookingGlassWebXRControls",a.style.position="fixed",a.style.zIndex=1e3,a.style.padding="4px",a.style.width="315px",a.style.height="360px",a.style.maxWidth="calc(100vw - 18px)",a.style.maxHeight="calc(100vh - 18px)",a.style.whiteSpace="nowrap",a.style.overflowY="scroll",a.style.scrollbarWidth="thin",a.style.scrollbarColor="thistle transparent",a.style.background="rgba(0, 0, 0, 0.6)",a.style.color="white",a.style.padding="2px",a.style.border="3px solid black",a.style.right="6px",a.style.bottom="6px";const s=document.createElement("div");a.appendChild(s),s.style.width="100%",s.style.textAlign="center",s.style.fontWeight="bold",s.innerText="LookingGlass View Controls ";const y=document.createElement("div");a.appendChild(y),y.style.width="100%",y.style.whiteSpace="normal",y.style.textAlign="center",y.innerHTML="Camera: click popup and use WASD, mouse left/right drag, and scroll.";const l=document.createElement("input");s.appendChild(l),l.type="button",l.value="\u2190",l._otherValue="\u2192",l.onclick=()=>{[a.style.right,a.style.left]=[a.style.left,a.style.right],[l.value,l._otherValue]=[l._otherValue,l.value]};const h=document.createElement("div");a.appendChild(h);const o=(i,r,c,b)=>{const f=c.stringify,E=document.createElement("div");h.appendChild(E);const _=i,v=t[i],g=document.createElement("label");if(E.appendChild(g),g.innerText=c.label,g.setAttribute("for",_),g.style.width="80px",g.style.display="inline-block",g.style.textDecoration="dotted underline 1px",g.title=c.title,r.type!=="checkbox"){const m=document.createElement("input");E.appendChild(m),m.type="button",m.value="\u238C",m.alt="reset",m.title="Reset value to default",m.style.padding="0 4px",m.onclick=()=>{d.value=v,d.oninput()}}const d=document.createElement("input");E.appendChild(d),Object.assign(d,r),d.id=_,d.title=c.title,d.value=r.value!==void 0?r.value:v;const V=m=>{t[i]=m,G(m)};d.oninput=()=>{const m=r.type==="range"?parseFloat(d.value):r.type==="checkbox"?d.checked:d.value;V(m)};const N=m=>{let P=m(t[i]);c.fixRange&&(P=c.fixRange(P),d.max=Math.max(parseFloat(d.max),P),d.min=Math.min(parseFloat(d.min),P)),d.value=P,V(P)};r.type==="range"&&(d.style.width="110px",d.style.height="16px",d.onwheel=m=>{N(P=>P+Math.sign(m.deltaX-m.deltaY)*r.step)});let G=()=>{};if(f){const m=document.createElement("span");E.appendChild(m),G=P=>{m.innerHTML=f(P)},G(v)}return N};o("tileHeight",{type:"range",min:160,max:455,step:1},{label:"resolution",title:"resolution of each view",stringify:i=>`${(i*t.aspect).toFixed()}&times;${i.toFixed()}`}),o("numViews",{type:"range",min:1,max:145,step:1},{label:"# views",title:"number of different viewing angles to render",stringify:i=>i.toFixed()});const X=o("trackballX",{type:"range",min:-Math.PI,max:1.0001*Math.PI,step:.5/180*Math.PI},{label:"trackball x",title:"camera trackball x",fixRange:i=>(i+Math.PI*3)%(Math.PI*2)-Math.PI,stringify:i=>`${(i/Math.PI*180).toFixed()}&deg;`}),T=o("trackballY",{type:"range",min:-.5*Math.PI,max:.5001*Math.PI,step:1/180*Math.PI},{label:"trackball y",title:"camera trackball y",fixRange:i=>Math.max(-.5*Math.PI,Math.min(i,.5*Math.PI)),stringify:i=>`${(i/Math.PI*180).toFixed()}&deg;`}),F=o("targetX",{type:"range",min:-20,max:20,step:.1},{label:"target x",title:"target position x",fixRange:i=>i,stringify:i=>i.toFixed(2)+" m"}),A=o("targetY",{type:"range",min:-20,max:20,step:.1},{label:"target y",title:"target position y",fixRange:i=>i,stringify:i=>i.toFixed(2)+" m"}),C=o("targetZ",{type:"range",min:-20,max:20,step:.1},{label:"target z",title:"target position z",fixRange:i=>i,stringify:i=>i.toFixed(2)+" m"});o("fovy",{type:"range",min:1/180*Math.PI,max:120.1/180*Math.PI,step:1/180*Math.PI},{label:"fov",title:"perspective fov (degrades stereo effect)",fixRange:i=>Math.max(1/180*Math.PI,Math.min(i,120.1/180*Math.PI)),stringify:i=>{const r=i/Math.PI*180,c=Math.atan(Math.tan(i/2)*t.aspect)*2/Math.PI*180;return`${r.toFixed()}&deg;&times;${c.toFixed()}&deg;`}}),o("depthiness",{type:"range",min:0,max:2,step:.01},{label:"depthiness",title:'exaggerates depth by multiplying the width of the view cone (as reported by the firmware) - can somewhat compensate for depthiness lost using higher fov. 1.25 seems to be most physically accurate on Looking Glass 8.9".',fixRange:i=>Math.max(0,i),stringify:i=>`${i.toFixed(2)}x`}),o("inlineView",{type:"range",min:0,max:2,step:1},{label:"inline view",title:"what to show inline on the original canvas (swizzled = no overwrite)",fixRange:i=>Math.max(0,Math.min(i,2)),stringify:i=>i===0?"swizzled":i===1?"center":i===2?"quilt":"?"}),n.oncontextmenu=i=>{i.preventDefault()},n.addEventListener("wheel",i=>{const r=t.targetDiam,c=1.1,b=Math.log(r)/Math.log(c);return t.targetDiam=Math.pow(c,b+i.deltaY*.01)}),n.addEventListener("mousemove",i=>{const r=i.movementX,c=-i.movementY;if(i.buttons&2||i.buttons&1&&(i.shiftKey||i.ctrlKey)){const b=t.trackballX,f=t.trackballY,E=-Math.cos(b)*r+Math.sin(b)*Math.sin(f)*c,_=-Math.cos(f)*c,v=Math.sin(b)*r+Math.cos(b)*Math.sin(f)*c;F(g=>g+E*t.targetDiam*.001),A(g=>g+_*t.targetDiam*.001),C(g=>g+v*t.targetDiam*.001)}else i.buttons&1&&(X(b=>b-r*.01),T(b=>b-c*.01))});const u={w:0,a:0,s:0,d:0};n.addEventListener("keydown",i=>{switch(i.code){case"KeyW":u.w=1;break;case"KeyA":u.a=1;break;case"KeyS":u.s=1;break;case"KeyD":u.d=1;break}}),n.addEventListener("keyup",i=>{switch(i.code){case"KeyW":u.w=0;break;case"KeyA":u.a=0;break;case"KeyS":u.s=0;break;case"KeyD":u.d=0;break}}),requestAnimationFrame(w);function w(){let i=u.d-u.a,r=u.w-u.s;i&&r&&(i*=Math.sqrt(.5),r*=Math.sqrt(.5));const c=t.trackballX,b=t.trackballY,f=Math.cos(c)*i-Math.sin(c)*Math.cos(b)*r,E=-Math.sin(b)*r,_=-Math.sin(c)*i-Math.cos(c)*Math.cos(b)*r;F(v=>v+f*t.targetDiam*.03),A(v=>v+E*t.targetDiam*.03),C(v=>v+_*t.targetDiam*.03),requestAnimationFrame(w)}return a}const k=Symbol("LookingGlassXRWebGLLayer");class de extends re.default{constructor(t,e,a){super(t,e,a);const s=document.createElement("canvas");s.tabIndex=0;const y=s.getContext("2d",{alpha:!1});s.addEventListener("dblclick",function(){this.requestFullscreen()});const l=he(s),h=I(),o=this[O.PRIVATE].config,X=e.createTexture();let T,F;const A=e.createFramebuffer(),C=e.enable.bind(e),u=e.disable.bind(e),w=e.getExtension("OES_vertex_array_object"),i=34229,r=w?w.bindVertexArrayOES.bind(w):e.bindVertexArray.bind(e),c=()=>{const R=e.getParameter(e.TEXTURE_BINDING_2D);if(e.bindTexture(e.TEXTURE_2D,X),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,h.framebufferWidth,h.framebufferHeight,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.bindTexture(e.TEXTURE_2D,R),T){const M=e.getParameter(e.RENDERBUFFER_BINDING);e.bindRenderbuffer(e.RENDERBUFFER,T),e.renderbufferStorage(e.RENDERBUFFER,F.format,h.framebufferWidth,h.framebufferHeight),e.bindRenderbuffer(e.RENDERBUFFER,M)}};(o.depth||o.stencil)&&(o.depth&&o.stencil?F={format:e.DEPTH_STENCIL,attachment:e.DEPTH_STENCIL_ATTACHMENT}:o.depth?F={format:e.DEPTH_COMPONENT16,attachment:e.DEPTH_ATTACHMENT}:o.stencil&&(F={format:e.STENCIL_INDEX8,attachment:e.STENCIL_ATTACHMENT}),T=e.createRenderbuffer()),c(),h.addEventListener("on-config-changed",c);const b=e.getParameter(e.FRAMEBUFFER_BINDING);e.bindFramebuffer(e.FRAMEBUFFER,A),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,X,0),(o.depth||o.stencil)&&e.framebufferRenderbuffer(e.FRAMEBUFFER,F.attachment,e.RENDERBUFFER,T),e.bindFramebuffer(e.FRAMEBUFFER,b);const f=e.createProgram(),E=e.createShader(e.VERTEX_SHADER);e.attachShader(f,E);const _=e.createShader(e.FRAGMENT_SHADER);e.attachShader(f,_);{const R=`
       attribute vec2 a_position;
       varying vec2 v_texcoord;
       void main() {
         gl_Position = vec4(a_position * 2.0 - 1.0, 0.0, 1.0);
         v_texcoord = a_position;
       }
     `;e.shaderSource(E,R),e.compileShader(E),e.getShaderParameter(E,e.COMPILE_STATUS)||console.warn(e.getShaderInfoLog(E))}let v,g,d;const V=()=>{const R=ee.Shader(h);if(R===v)return;if(v=R,e.shaderSource(_,R),e.compileShader(_),!e.getShaderParameter(_,e.COMPILE_STATUS)){console.warn(e.getShaderInfoLog(_));return}if(e.linkProgram(f),!e.getProgramParameter(f,e.LINK_STATUS)){console.warn(e.getProgramInfoLog(f));return}g=e.getAttribLocation(f,"a_position"),d=e.getUniformLocation(f,"u_viewType");const M=e.getUniformLocation(f,"u_texture"),W=e.getParameter(e.CURRENT_PROGRAM);e.useProgram(f),e.uniform1i(M,0),e.useProgram(W)};h.addEventListener("on-config-changed",V);const N=w?w.createVertexArrayOES():e.createVertexArray(),G=e.createBuffer(),m=e.getParameter(e.ARRAY_BUFFER_BINDING),P=e.getParameter(i);r(N),e.bindBuffer(e.ARRAY_BUFFER,G),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW),e.enableVertexAttribArray(g),e.vertexAttribPointer(g,2,e.FLOAT,!1,0,0),r(P),e.bindBuffer(e.ARRAY_BUFFER,m);const ye=()=>{console.assert(this[k].LookingGlassEnabled),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer);const R=e.getParameter(e.COLOR_CLEAR_VALUE),M=e.getParameter(e.DEPTH_CLEAR_VALUE),W=e.getParameter(e.STENCIL_CLEAR_VALUE);e.clearColor(0,0,0,0),e.clearDepth(1),e.clearStencil(0),e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT|e.STENCIL_BUFFER_BIT),e.clearColor(R[0],R[1],R[2],R[3]),e.clearDepth(M),e.clearStencil(W)},S=e.canvas;let q,z;const Ee=()=>{if(!this[k].LookingGlassEnabled)return;(S.width!==h.calibration.screenW.value||S.height!==h.calibration.screenH.value)&&(q=S.width,z=S.height,S.width=h.calibration.screenW.value,S.height=h.calibration.screenH.value);const R=e.getParameter(i),M=e.getParameter(e.CULL_FACE),W=e.getParameter(e.BLEND),we=e.getParameter(e.DEPTH_TEST),Re=e.getParameter(e.STENCIL_TEST),xe=e.getParameter(e.SCISSOR_TEST),_e=e.getParameter(e.VIEWPORT),Te=e.getParameter(e.FRAMEBUFFER_BINDING),Pe=e.getParameter(e.RENDERBUFFER_BINDING),Le=e.getParameter(e.CURRENT_PROGRAM),Fe=e.getParameter(e.ACTIVE_TEXTURE);{const Ce=e.getParameter(e.TEXTURE_BINDING_2D);e.bindFramebuffer(e.FRAMEBUFFER,null),e.useProgram(f),r(N),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,X),e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.STENCIL_TEST),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),e.uniform1i(d,0),e.drawArrays(e.TRIANGLES,0,6),y.clearRect(0,0,s.width,s.height),y.drawImage(S,0,0),h.inlineView!==0&&(e.uniform1i(d,h.inlineView),e.drawArrays(e.TRIANGLES,0,6)),e.bindTexture(e.TEXTURE_2D,Ce)}e.activeTexture(Fe),e.useProgram(Le),e.bindRenderbuffer(e.RENDERBUFFER,Pe),e.bindFramebuffer(e.FRAMEBUFFER,Te),e.viewport(..._e),(xe?C:u)(e.SCISSOR_TEST),(Re?C:u)(e.STENCIL_TEST),(we?C:u)(e.DEPTH_TEST),(W?C:u)(e.BLEND),(M?C:u)(e.CULL_FACE),r(R)};let L;window.addEventListener("unload",()=>{L&&L.close(),L=void 0});const ve=(R,M)=>{!!L!=R&&(R?(V(),s.style.position="fixed",s.style.top="0",s.style.left="0",s.style.width="100%",s.style.height="100%",s.width=h.calibration.screenW.value,s.height=h.calibration.screenH.value,document.body.appendChild(l),L=window.open("",void 0,"width=640,height=360"),L.document.title="Looking Glass Window (fullscreen me on Looking Glass!)",L.document.body.style.background="black",L.document.body.appendChild(s),console.assert(M),L.onbeforeunload=M):(l.parentElement.removeChild(l),S.width=q,S.height=z,L.onbeforeunload=void 0,L.close(),L=void 0))};this[k]={LookingGlassEnabled:!1,framebuffer:A,clearFramebuffer:ye,blitTextureToDefaultFramebufferIfNeeded:Ee,moveCanvasToWindow:ve}}get framebuffer(){return this[k].LookingGlassEnabled?this[k].framebuffer:null}get framebufferWidth(){return I().framebufferWidth}get framebufferHeight(){return I().framebufferHeight}}class ue extends ae.default{constructor(t){super(t),this.sessions=new Map,this.viewSpaces=[],this.basePoseMatrix=p.mat4.create(),this.inlineProjectionMatrix=p.mat4.create(),this.inlineInverseViewMatrix=p.mat4.create(),this.LookingGlassProjectionMatrices=[],this.LookingGlassInverseViewMatrices=[]}onBaseLayerSet(t,e){const a=this.sessions.get(t);a.baseLayer=e;const s=e[k];s.LookingGlassEnabled=a.immersive,a.immersive&&s.moveCanvasToWindow(!0,()=>{this.endSession(t)})}isSessionSupported(t){return t==="inline"||t==="immersive-vr"}isFeatureSupported(t){switch(t){case"viewer":return!0;case"local":return!0;case"local-floor":return!0;case"bounded-floor":return!1;case"unbounded":return!1;default:return console.warn("LookingGlassXRDevice.isFeatureSupported: feature not understood:",t),!1}}async requestSession(t,e){if(!this.isSessionSupported(t))return Promise.reject();const a=t!=="inline",s=new me(t,e);return this.sessions.set(s.id,s),a&&this.dispatchEvent("@@webxr-polyfill/vr-present-start",s.id),Promise.resolve(s.id)}requestAnimationFrame(t){return this.global.requestAnimationFrame(t)}cancelAnimationFrame(t){this.global.cancelAnimationFrame(t)}onFrameStart(t,e){const a=this.sessions.get(t),s=I();if(a.immersive){const y=Math.tan(.5*s.fovy),l=.5*s.targetDiam/y,h=l-s.targetDiam,o=this.basePoseMatrix;p.mat4.fromTranslation(o,[s.targetX,s.targetY,s.targetZ]),p.mat4.rotate(o,o,s.trackballX,[0,1,0]),p.mat4.rotate(o,o,-s.trackballY,[1,0,0]),p.mat4.translate(o,o,[0,0,l]);for(let T=0;T<s.numViews;++T){const F=(T+.5)/s.numViews-.5,A=Math.tan(s.viewCone*F),C=l*A,u=this.LookingGlassInverseViewMatrices[T]=this.LookingGlassInverseViewMatrices[T]||p.mat4.create();p.mat4.translate(u,o,[C,0,0]),p.mat4.invert(u,u);const w=Math.max(h+e.depthNear,.01),i=h+e.depthFar,r=w*y,c=r,b=-r,f=w*-A,E=s.aspect*r,_=f+E,v=f-E,g=this.LookingGlassProjectionMatrices[T]=this.LookingGlassProjectionMatrices[T]||p.mat4.create();p.mat4.set(g,2*w/(_-v),0,0,0,0,2*w/(c-b),0,0,(_+v)/(_-v),(c+b)/(c-b),-(i+w)/(i-w),-1,0,0,-2*i*w/(i-w),0)}a.baseLayer[k].clearFramebuffer()}else{const y=a.baseLayer.context,l=y.drawingBufferWidth/y.drawingBufferHeight;p.mat4.perspective(this.inlineProjectionMatrix,e.inlineVerticalFieldOfView,l,e.depthNear,e.depthFar),p.mat4.fromTranslation(this.basePoseMatrix,[0,U,0]),p.mat4.invert(this.inlineInverseViewMatrix,this.basePoseMatrix)}}onFrameEnd(t){this.sessions.get(t).baseLayer[k].blitTextureToDefaultFramebufferIfNeeded()}async requestFrameOfReferenceTransform(t,e){const a=p.mat4.create();switch(t){case"viewer":case"local":return p.mat4.fromTranslation(a,[0,-U,0]),a;case"local-floor":return a;default:throw new Error("XRReferenceSpaceType not understood")}}endSession(t){const e=this.sessions.get(t);e.immersive&&e.baseLayer&&(e.baseLayer[k].moveCanvasToWindow(!1),this.dispatchEvent("@@webxr-polyfill/vr-present-end",t)),e.ended=!0}doesSessionSupportReferenceSpace(t,e){const a=this.sessions.get(t);return a.ended?!1:a.enabledFeatures.has(e)}getViewSpaces(t){if(t==="immersive-vr"){const e=I();for(let a=this.viewSpaces.length;a<e.numViews;++a)this.viewSpaces[a]=new be(a);return this.viewSpaces.length=e.numViews,this.viewSpaces}}getViewport(t,e,a,s,y){if(y===void 0){const h=this.sessions.get(t).baseLayer.context;s.x=0,s.y=0,s.width=h.drawingBufferWidth,s.height=h.drawingBufferHeight}else{const l=I(),h=y%l.quiltWidth,o=Math.floor(y/l.quiltWidth);s.x=l.tileWidth*h,s.y=l.tileHeight*o,s.width=l.tileWidth,s.height=l.tileHeight}return!0}getProjectionMatrix(t,e){return e===void 0?this.inlineProjectionMatrix:this.LookingGlassProjectionMatrices[e]||p.mat4.create()}getBasePoseMatrix(){return this.basePoseMatrix}getBaseViewMatrix(){return this.inlineInverseViewMatrix}_getViewMatrixByIndex(t){return this.LookingGlassInverseViewMatrices[t]=this.LookingGlassInverseViewMatrices[t]||p.mat4.create()}getInputSources(){return[]}getInputPose(t,e,a){return null}onWindowResize(){}}let fe=0;class me{constructor(t,e){this.mode=t,this.immersive=t==="immersive-vr"||t==="immersive-ar",this.id=++fe,this.baseLayer=null,this.inlineVerticalFieldOfView=Math.PI*.5,this.ended=!1,this.enabledFeatures=e}}class be extends se.default{constructor(t){super(),this.viewIndex=t}get eye(){return"none"}_onPoseUpdate(t){this._inverseBaseMatrix=t._getViewMatrixByIndex(this.viewIndex)}}class pe extends ie.default{constructor(t){super(),console.warn(t||'Looking Glass WebXR "polyfill" overriding native WebXR API.');for(const a in Y.default)this.global[a]=Y.default[a];this.global.XRWebGLLayer=de,this.injected=!0;const e=Promise.resolve(new ue(this.global));this.xr=new ne.default(e),Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})}}const ge=I();x.LookingGlassConfig=ge,x.LookingGlassWebXRPolyfill=pe,Object.defineProperties(x,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
