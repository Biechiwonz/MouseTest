(function(g,P){typeof exports=="object"&&typeof module<"u"?P(exports,require("@lookingglass/webxr-polyfill/src/WebXRPolyfill"),require("@lookingglass/webxr-polyfill/src/api/XRSystem"),require("@lookingglass/webxr-polyfill/src/api/index"),require("@lookingglass/webxr-polyfill/src/devices/XRDevice"),require("@lookingglass/webxr-polyfill/src/api/XRSpace"),require("gl-matrix"),require("@lookingglass/webxr-polyfill/src/api/XRWebGLLayer"),require("holoplay-core")):typeof define=="function"&&define.amd?define(["exports","@lookingglass/webxr-polyfill/src/WebXRPolyfill","@lookingglass/webxr-polyfill/src/api/XRSystem","@lookingglass/webxr-polyfill/src/api/index","@lookingglass/webxr-polyfill/src/devices/XRDevice","@lookingglass/webxr-polyfill/src/api/XRSpace","gl-matrix","@lookingglass/webxr-polyfill/src/api/XRWebGLLayer","holoplay-core"],P):(g=typeof globalThis<"u"?globalThis:g||self,P(g["Looking Glass WebXR"]={},g.WebXRPolyfill,g["@lookingglass/webxr-polyfill/src/api/XRSystem"],g["@lookingglass/webxr-polyfill/src/api/index"],g["@lookingglass/webxr-polyfill/src/devices/XRDevice"],g["@lookingglass/webxr-polyfill/src/api/XRSpace"],g.glMatrix,g["@lookingglass/webxr-polyfill/src/api/XRWebGLLayer"],g.holoPlayCore))})(this,function(g,P,B,Q,ee,te,v,q,z){"use strict";var Ce=Object.defineProperty;var ke=(g,P,B)=>P in g?Ce(g,P,{enumerable:!0,configurable:!0,writable:!0,value:B}):g[P]=B;var F=(g,P,B)=>(ke(g,typeof P!="symbol"?P+"":P,B),B);const N=r=>r&&typeof r=="object"&&"default"in r?r:{default:r};function ie(r){if(r&&r.__esModule)return r;const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(r){for(const e in r)if(e!=="default"){const n=Object.getOwnPropertyDescriptor(r,e);Object.defineProperty(t,e,n.get?n:{enumerable:!0,get:()=>r[e]})}}return t.default=r,Object.freeze(t)}const ne=N(P),ae=N(B),K=N(Q),re=N(ee),se=N(te),oe=N(q),ce=ie(z),le={configVersion:"1.0",pitch:{value:45},slope:{value:-5},center:{value:-.5},viewCone:{value:40},invView:{value:1},verticalAngle:{value:0},DPI:{value:338},screenW:{value:250},screenH:{value:250},flipImageX:{value:0},flipImageY:{value:0},flipSubp:{value:0}},Y=1.6,he={tileHeight:512,numViews:45,trackballX:0,trackballY:0,targetX:0,targetY:Y,targetZ:-.5,targetDiam:2,fovy:13/180*Math.PI,depthiness:1.25,inlineView:1};class fe extends EventTarget{constructor(e){super();F(this,"_calibration",j(le));F(this,"_config",j(he));this._config={...this._config,...e},this.syncCalibration()}syncCalibration(){new ce.Client(e=>{if(e.devices.length<1){console.error("No Looking Glass devices found!");return}e.devices.length>1&&console.warn("More than one Looking Glass device found... using the first one"),this.calibration=e.devices[0].calibration},e=>{console.error("Error creating Looking Glass client:",e)})}onConfigChange(){this.dispatchEvent(new Event("on-config-changed"))}get calibration(){return this._calibration}set calibration(e){this._calibration={...this._calibration,...e},this.onConfigChange()}get config(){return this._config}set config(e){e!=null&&(this._config={...this._config,...e},this.onConfigChange())}get tileHeight(){return this._config.tileHeight}set tileHeight(e){this._config.tileHeight=e,this.onConfigChange()}get numViews(){return this._config.numViews}set numViews(e){this._config.numViews=e,this.onConfigChange()}get targetX(){return this._config.targetX}set targetX(e){this._config.targetX=e,this.onConfigChange()}get targetY(){return this._config.targetY}set targetY(e){this._config.targetY=e,this.onConfigChange()}get targetZ(){return this._config.targetZ}set targetZ(e){this._config.targetZ=e,this.onConfigChange()}get trackballX(){return this._config.trackballX}set trackballX(e){this._config.trackballX=e,this.onConfigChange()}get trackballY(){return this._config.trackballY}set trackballY(e){this._config.trackballY=e,this.onConfigChange()}get targetDiam(){return this._config.targetDiam}set targetDiam(e){this._config.targetDiam=e,this.onConfigChange()}get fovy(){return this._config.fovy}set fovy(e){this._config.fovy=e,this.onConfigChange()}get depthiness(){return this._config.depthiness}set depthiness(e){this._config.depthiness=e,this.onConfigChange()}get inlineView(){return this._config.inlineView}set inlineView(e){this._config.inlineView=e,this.onConfigChange()}get aspect(){return this._calibration.screenW.value/this._calibration.screenH.value}get tileWidth(){return Math.round(this.tileHeight*this.aspect)}get framebufferWidth(){const e=this.tileWidth*this.tileHeight*this.numViews;return 2**Math.ceil(Math.log2(Math.max(Math.sqrt(e),this.tileWidth)))}get quiltWidth(){return Math.floor(this.framebufferWidth/this.tileWidth)}get quiltHeight(){return Math.ceil(this.numViews/this.quiltWidth)}get framebufferHeight(){return 2**Math.ceil(Math.log2(this.quiltHeight*this.tileHeight))}get viewCone(){return this._calibration.viewCone.value*this.depthiness/180*Math.PI}get tilt(){return this._calibration.screenH.value/(this._calibration.screenW.value*this._calibration.slope.value)*(this._calibration.flipImageX.value?-1:1)}get subp(){return 1/(this._calibration.screenW.value*3)}get pitch(){const e=this._calibration.screenW.value/this._calibration.DPI.value;return this._calibration.pitch.value*e*Math.cos(Math.atan(1/this._calibration.slope.value))}}let O=null;function S(r){return O==null?O=new fe(r):O.config=r,O}function j(r){return Object.freeze(r),r===void 0||Object.getOwnPropertyNames(r).forEach(function(t){r[t]!==null&&(typeof r[t]=="object"||typeof r[t]=="function")&&!Object.isFrozen(r[t])&&j(r[t])}),r}function de(r){var k;const t=S(),e=document.createElement("style");document.head.appendChild(e),(k=e.sheet)==null||k.insertRule("#LookingGlassWebXRControls * { all: revert; font-family: sans-serif }");const n=document.createElement("div");n.id="LookingGlassWebXRControls",n.style.position="fixed",n.style.zIndex="1000",n.style.padding="4px",n.style.width="315px",n.style.height="360px",n.style.maxWidth="calc(100vw - 18px)",n.style.maxHeight="calc(100vh - 18px)",n.style.whiteSpace="nowrap",n.style.overflowY="scroll",n.style.background="rgba(0, 0, 0, 0.6)",n.style.color="white",n.style.padding="2px",n.style.border="3px solid black",n.style.right="6px",n.style.bottom="6px";const a=document.createElement("div");n.appendChild(a),a.style.width="100%",a.style.textAlign="center",a.style.fontWeight="bold",a.innerText="LookingGlass View Controls ";const m=document.createElement("div");n.appendChild(m),m.style.width="100%",m.style.whiteSpace="normal",m.style.textAlign="center",m.innerHTML="Camera: click popup and use WASD, mouse left/right drag, and scroll.";const h=document.createElement("input");a.appendChild(h),h.type="button",h.value="\u2190",h.dataset.otherValue="\u2192",h.onclick=()=>{[n.style.right,n.style.left]=[n.style.left,n.style.right],[h.value,h.dataset.otherValue]=[h.dataset.otherValue||"",h.value]};const d=document.createElement("div");n.appendChild(d);const o=(i,c,f)=>{const s=f.stringify,y=document.createElement("div");d.appendChild(y);const R=i,_=t[i],p=document.createElement("label");if(y.appendChild(p),p.innerText=f.label,p.setAttribute("for",R),p.style.width="80px",p.style.display="inline-block",p.style.textDecoration="dotted underline 1px",p.title=f.title,c.type!=="checkbox"){const u=document.createElement("input");y.appendChild(u),u.type="button",u.value="\u238C",u.alt="reset",u.title="Reset value to default",u.style.padding="0 4px",u.onclick=T=>{l.value=_,l.oninput(T)}}const l=document.createElement("input");y.appendChild(l),Object.assign(l,c),l.id=R,l.title=f.title,l.value=c.value!==void 0?c.value:_;const W=u=>{t[i]=u,H(u)};l.oninput=()=>{const u=c.type==="range"?parseFloat(l.value):c.type==="checkbox"?l.checked:l.value;W(u)};const U=u=>{let T=u(t[i]);f.fixRange&&(T=f.fixRange(T),l.max=Math.max(parseFloat(l.max),T).toString(),l.min=Math.min(parseFloat(l.min),T).toString()),l.value=T,W(T)};c.type==="range"&&(l.style.width="110px",l.style.height="16px",l.onwheel=u=>{U(T=>T+Math.sign(u.deltaX-u.deltaY)*c.step)});let H=u=>{};if(s){const u=document.createElement("span");y.appendChild(u),H=T=>{u.innerHTML=s(T)},H(_)}return U};o("tileHeight",{type:"range",min:160,max:455,step:1},{label:"resolution",title:"resolution of each view",stringify:i=>`${(i*t.aspect).toFixed()}&times;${i.toFixed()}`}),o("numViews",{type:"range",min:1,max:145,step:1},{label:"# views",title:"number of different viewing angles to render",stringify:i=>i.toFixed()});const G=o("trackballX",{type:"range",min:-Math.PI,max:1.0001*Math.PI,step:.5/180*Math.PI},{label:"trackball x",title:"camera trackball x",fixRange:i=>(i+Math.PI*3)%(Math.PI*2)-Math.PI,stringify:i=>`${(i/Math.PI*180).toFixed()}&deg;`}),x=o("trackballY",{type:"range",min:-.5*Math.PI,max:.5001*Math.PI,step:1/180*Math.PI},{label:"trackball y",title:"camera trackball y",fixRange:i=>Math.max(-.5*Math.PI,Math.min(i,.5*Math.PI)),stringify:i=>`${(i/Math.PI*180).toFixed()}&deg;`}),M=o("targetX",{type:"range",min:-20,max:20,step:.1},{label:"target x",title:"target position x",fixRange:i=>i,stringify:i=>i.toFixed(2)+" m"}),X=o("targetY",{type:"range",min:-20,max:20,step:.1},{label:"target y",title:"target position y",fixRange:i=>i,stringify:i=>i.toFixed(2)+" m"}),C=o("targetZ",{type:"range",min:-20,max:20,step:.1},{label:"target z",title:"target position z",fixRange:i=>i,stringify:i=>i.toFixed(2)+" m"});o("fovy",{type:"range",min:1/180*Math.PI,max:120.1/180*Math.PI,step:1/180*Math.PI},{label:"fov",title:"perspective fov (degrades stereo effect)",fixRange:i=>Math.max(1/180*Math.PI,Math.min(i,120.1/180*Math.PI)),stringify:i=>{const c=i/Math.PI*180,f=Math.atan(Math.tan(i/2)*t.aspect)*2/Math.PI*180;return`${c.toFixed()}&deg;&times;${f.toFixed()}&deg;`}}),o("depthiness",{type:"range",min:0,max:2,step:.01},{label:"depthiness",title:'exaggerates depth by multiplying the width of the view cone (as reported by the firmware) - can somewhat compensate for depthiness lost using higher fov. 1.25 seems to be most physically accurate on Looking Glass 8.9".',fixRange:i=>Math.max(0,i),stringify:i=>`${i.toFixed(2)}x`}),o("inlineView",{type:"range",min:0,max:2,step:1},{label:"inline view",title:"what to show inline on the original canvas (swizzled = no overwrite)",fixRange:i=>Math.max(0,Math.min(i,2)),stringify:i=>i===0?"swizzled":i===1?"center":i===2?"quilt":"?"}),r.oncontextmenu=i=>{i.preventDefault()},r.addEventListener("wheel",i=>{const c=t.targetDiam,f=1.1,s=Math.log(c)/Math.log(f);return t.targetDiam=Math.pow(f,s+i.deltaY*.01)}),r.addEventListener("mousemove",i=>{const c=i.movementX,f=-i.movementY;if(i.buttons&2||i.buttons&1&&(i.shiftKey||i.ctrlKey)){const s=t.trackballX,y=t.trackballY,R=-Math.cos(s)*c+Math.sin(s)*Math.sin(y)*f,_=-Math.cos(y)*f,p=Math.sin(s)*c+Math.cos(s)*Math.sin(y)*f;M(l=>l+R*t.targetDiam*.001),X(l=>l+_*t.targetDiam*.001),C(l=>l+p*t.targetDiam*.001)}else i.buttons&1&&(G(s=>s-c*.01),x(s=>s-f*.01))});const b={w:0,a:0,s:0,d:0};r.addEventListener("keydown",i=>{switch(i.code){case"KeyW":b.w=1;break;case"KeyA":b.a=1;break;case"KeyS":b.s=1;break;case"KeyD":b.d=1;break}}),r.addEventListener("keyup",i=>{switch(i.code){case"KeyW":b.w=0;break;case"KeyA":b.a=0;break;case"KeyS":b.s=0;break;case"KeyD":b.d=0;break}}),requestAnimationFrame(E);function E(){let i=b.d-b.a,c=b.w-b.s;i&&c&&(i*=Math.sqrt(.5),c*=Math.sqrt(.5));const f=t.trackballX,s=t.trackballY,y=Math.cos(f)*i-Math.sin(f)*Math.cos(s)*c,R=-Math.sin(s)*c,_=-Math.sin(f)*i-Math.cos(f)*Math.cos(s)*c;M(p=>p+y*t.targetDiam*.03),X(p=>p+R*t.targetDiam*.03),C(p=>p+_*t.targetDiam*.03),requestAnimationFrame(E)}return n}const A=Symbol("LookingGlassXRWebGLLayer");class ue extends oe.default{constructor(t,e,n){super(t,e,n);const a=document.createElement("canvas");a.tabIndex=0;const m=a.getContext("2d",{alpha:!1});a.addEventListener("dblclick",function(){this.requestFullscreen()});const h=de(a),d=S(),o=this[q.PRIVATE].config,G=e.createTexture();let x,M;const X=e.createFramebuffer(),C=e.enable.bind(e),b=e.disable.bind(e),E=e.getExtension("OES_vertex_array_object"),k=34229,i=E?E.bindVertexArrayOES.bind(E):e.bindVertexArray.bind(e),c=()=>{const w=e.getParameter(e.TEXTURE_BINDING_2D);if(e.bindTexture(e.TEXTURE_2D,G),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,d.framebufferWidth,d.framebufferHeight,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.bindTexture(e.TEXTURE_2D,w),x){const I=e.getParameter(e.RENDERBUFFER_BINDING);e.bindRenderbuffer(e.RENDERBUFFER,x),e.renderbufferStorage(e.RENDERBUFFER,M.format,d.framebufferWidth,d.framebufferHeight),e.bindRenderbuffer(e.RENDERBUFFER,I)}};(o.depth||o.stencil)&&(o.depth&&o.stencil?M={format:e.DEPTH_STENCIL,attachment:e.DEPTH_STENCIL_ATTACHMENT}:o.depth?M={format:e.DEPTH_COMPONENT16,attachment:e.DEPTH_ATTACHMENT}:o.stencil&&(M={format:e.STENCIL_INDEX8,attachment:e.STENCIL_ATTACHMENT}),x=e.createRenderbuffer()),c(),d.addEventListener("on-config-changed",c);const f=e.getParameter(e.FRAMEBUFFER_BINDING);e.bindFramebuffer(e.FRAMEBUFFER,X),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,G,0),(o.depth||o.stencil)&&e.framebufferRenderbuffer(e.FRAMEBUFFER,M.attachment,e.RENDERBUFFER,x),e.bindFramebuffer(e.FRAMEBUFFER,f);const s=e.createProgram(),y=e.createShader(e.VERTEX_SHADER);e.attachShader(s,y);const R=e.createShader(e.FRAGMENT_SHADER);e.attachShader(s,R);{const w=`
       attribute vec2 a_position;
       varying vec2 v_texcoord;
       void main() {
         gl_Position = vec4(a_position * 2.0 - 1.0, 0.0, 1.0);
         v_texcoord = a_position;
       }
     `;e.shaderSource(y,w),e.compileShader(y),e.getShaderParameter(y,e.COMPILE_STATUS)||console.warn(e.getShaderInfoLog(y))}let _,p,l;const W=()=>{const w=z.Shader(d);if(w===_)return;if(_=w,e.shaderSource(R,w),e.compileShader(R),!e.getShaderParameter(R,e.COMPILE_STATUS)){console.warn(e.getShaderInfoLog(R));return}if(e.linkProgram(s),!e.getProgramParameter(s,e.LINK_STATUS)){console.warn(e.getProgramInfoLog(s));return}p=e.getAttribLocation(s,"a_position"),l=e.getUniformLocation(s,"u_viewType");const I=e.getUniformLocation(s,"u_texture"),V=e.getParameter(e.CURRENT_PROGRAM);e.useProgram(s),e.uniform1i(I,0),e.useProgram(V)};d.addEventListener("on-config-changed",W);const U=E?E.createVertexArrayOES():e.createVertexArray(),H=e.createBuffer(),u=e.getParameter(e.ARRAY_BUFFER_BINDING),T=e.getParameter(k);i(U),e.bindBuffer(e.ARRAY_BUFFER,H),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW),e.enableVertexAttribArray(p),e.vertexAttribPointer(p,2,e.FLOAT,!1,0,0),i(T),e.bindBuffer(e.ARRAY_BUFFER,u);const ve=()=>{console.assert(this[A].LookingGlassEnabled),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer);const w=e.getParameter(e.COLOR_CLEAR_VALUE),I=e.getParameter(e.DEPTH_CLEAR_VALUE),V=e.getParameter(e.STENCIL_CLEAR_VALUE);e.clearColor(0,0,0,0),e.clearDepth(1),e.clearStencil(0),e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT|e.STENCIL_BUFFER_BIT),e.clearColor(w[0],w[1],w[2],w[3]),e.clearDepth(I),e.clearStencil(V)},D=e.canvas;let $,J;const Ee=()=>{if(!this[A].LookingGlassEnabled)return;(D.width!==d.calibration.screenW.value||D.height!==d.calibration.screenH.value)&&($=D.width,J=D.height,D.width=d.calibration.screenW.value,D.height=d.calibration.screenH.value);const w=e.getParameter(k),I=e.getParameter(e.CULL_FACE),V=e.getParameter(e.BLEND),Re=e.getParameter(e.DEPTH_TEST),xe=e.getParameter(e.STENCIL_TEST),_e=e.getParameter(e.SCISSOR_TEST),Te=e.getParameter(e.VIEWPORT),Pe=e.getParameter(e.FRAMEBUFFER_BINDING),Le=e.getParameter(e.RENDERBUFFER_BINDING),Fe=e.getParameter(e.CURRENT_PROGRAM),Se=e.getParameter(e.ACTIVE_TEXTURE);{const Me=e.getParameter(e.TEXTURE_BINDING_2D);e.bindFramebuffer(e.FRAMEBUFFER,null),e.useProgram(s),i(U),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,G),e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.STENCIL_TEST),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),e.uniform1i(l,0),e.drawArrays(e.TRIANGLES,0,6),m==null||m.clearRect(0,0,a.width,a.height),m==null||m.drawImage(D,0,0),d.inlineView!==0&&(e.uniform1i(l,d.inlineView),e.drawArrays(e.TRIANGLES,0,6)),e.bindTexture(e.TEXTURE_2D,Me)}e.activeTexture(Se),e.useProgram(Fe),e.bindRenderbuffer(e.RENDERBUFFER,Le),e.bindFramebuffer(e.FRAMEBUFFER,Pe),e.viewport(...Te),(_e?C:b)(e.SCISSOR_TEST),(xe?C:b)(e.STENCIL_TEST),(Re?C:b)(e.DEPTH_TEST),(V?C:b)(e.BLEND),(I?C:b)(e.CULL_FACE),i(w)};let L;window.addEventListener("unload",()=>{L&&L.close(),L=void 0});const we=(w,I)=>{var V;!!L!=w&&(w?(W(),a.style.position="fixed",a.style.top="0",a.style.left="0",a.style.width="100%",a.style.height="100%",a.width=d.calibration.screenW.value,a.height=d.calibration.screenH.value,document.body.appendChild(h),L=window.open("",void 0,"width=640,height=360"),L.document.title="Looking Glass Window (fullscreen me on Looking Glass!)",L.document.body.style.background="black",L.document.body.appendChild(a),console.assert(I),L.onbeforeunload=I):((V=h.parentElement)==null||V.removeChild(h),D.width=$,D.height=J,L.onbeforeunload=void 0,L.close(),L=void 0))};this[A]={LookingGlassEnabled:!1,framebuffer:X,clearFramebuffer:ve,blitTextureToDefaultFramebufferIfNeeded:Ee,moveCanvasToWindow:we}}get framebuffer(){return this[A].LookingGlassEnabled?this[A].framebuffer:null}get framebufferWidth(){return S().framebufferWidth}get framebufferHeight(){return S().framebufferHeight}}class me extends re.default{constructor(t){super(t),this.sessions=new Map,this.viewSpaces=[],this.basePoseMatrix=v.mat4.create(),this.inlineProjectionMatrix=v.mat4.create(),this.inlineInverseViewMatrix=v.mat4.create(),this.LookingGlassProjectionMatrices=[],this.LookingGlassInverseViewMatrices=[]}onBaseLayerSet(t,e){const n=this.sessions.get(t);n.baseLayer=e;const a=e[A];a.LookingGlassEnabled=n.immersive,n.immersive&&a.moveCanvasToWindow(!0,()=>{this.endSession(t)})}isSessionSupported(t){return t==="inline"||t==="immersive-vr"}isFeatureSupported(t){switch(t){case"viewer":return!0;case"local":return!0;case"local-floor":return!0;case"bounded-floor":return!1;case"unbounded":return!1;default:return console.warn("LookingGlassXRDevice.isFeatureSupported: feature not understood:",t),!1}}async requestSession(t,e){if(!this.isSessionSupported(t))return Promise.reject();const n=t!=="inline",a=new pe(t,e);return this.sessions.set(a.id,a),n&&this.dispatchEvent("@@webxr-polyfill/vr-present-start",a.id),Promise.resolve(a.id)}requestAnimationFrame(t){return this.global.requestAnimationFrame(t)}cancelAnimationFrame(t){this.global.cancelAnimationFrame(t)}onFrameStart(t,e){const n=this.sessions.get(t),a=S();if(n.immersive){const m=Math.tan(.5*a.fovy),h=.5*a.targetDiam/m,d=h-a.targetDiam,o=this.basePoseMatrix;v.mat4.fromTranslation(o,[a.targetX,a.targetY,a.targetZ]),v.mat4.rotate(o,o,a.trackballX,[0,1,0]),v.mat4.rotate(o,o,-a.trackballY,[1,0,0]),v.mat4.translate(o,o,[0,0,h]);for(let x=0;x<a.numViews;++x){const M=(x+.5)/a.numViews-.5,X=Math.tan(a.viewCone*M),C=h*X,b=this.LookingGlassInverseViewMatrices[x]=this.LookingGlassInverseViewMatrices[x]||v.mat4.create();v.mat4.translate(b,o,[C,0,0]),v.mat4.invert(b,b);const E=Math.max(d+e.depthNear,.01),k=d+e.depthFar,i=E*m,c=i,f=-i,s=E*-X,y=a.aspect*i,R=s+y,_=s-y,p=this.LookingGlassProjectionMatrices[x]=this.LookingGlassProjectionMatrices[x]||v.mat4.create();v.mat4.set(p,2*E/(R-_),0,0,0,0,2*E/(c-f),0,0,(R+_)/(R-_),(c+f)/(c-f),-(k+E)/(k-E),-1,0,0,-2*k*E/(k-E),0)}n.baseLayer[A].clearFramebuffer()}else{const m=n.baseLayer.context,h=m.drawingBufferWidth/m.drawingBufferHeight;v.mat4.perspective(this.inlineProjectionMatrix,e.inlineVerticalFieldOfView,h,e.depthNear,e.depthFar),v.mat4.fromTranslation(this.basePoseMatrix,[0,Y,0]),v.mat4.invert(this.inlineInverseViewMatrix,this.basePoseMatrix)}}onFrameEnd(t){this.sessions.get(t).baseLayer[A].blitTextureToDefaultFramebufferIfNeeded()}async requestFrameOfReferenceTransform(t,e){const n=v.mat4.create();switch(t){case"viewer":case"local":return v.mat4.fromTranslation(n,[0,-Y,0]),n;case"local-floor":return n;default:throw new Error("XRReferenceSpaceType not understood")}}endSession(t){const e=this.sessions.get(t);e.immersive&&e.baseLayer&&(e.baseLayer[A].moveCanvasToWindow(!1),this.dispatchEvent("@@webxr-polyfill/vr-present-end",t)),e.ended=!0}doesSessionSupportReferenceSpace(t,e){const n=this.sessions.get(t);return n.ended?!1:n.enabledFeatures.has(e)}getViewSpaces(t){if(t==="immersive-vr"){const e=S();for(let n=this.viewSpaces.length;n<e.numViews;++n)this.viewSpaces[n]=new ge(n);return this.viewSpaces.length=e.numViews,this.viewSpaces}}getViewport(t,e,n,a,m){if(m===void 0){const d=this.sessions.get(t).baseLayer.context;a.x=0,a.y=0,a.width=d.drawingBufferWidth,a.height=d.drawingBufferHeight}else{const h=S(),d=m%h.quiltWidth,o=Math.floor(m/h.quiltWidth);a.x=h.tileWidth*d,a.y=h.tileHeight*o,a.width=h.tileWidth,a.height=h.tileHeight}return!0}getProjectionMatrix(t,e){return e===void 0?this.inlineProjectionMatrix:this.LookingGlassProjectionMatrices[e]||v.mat4.create()}getBasePoseMatrix(){return this.basePoseMatrix}getBaseViewMatrix(){return this.inlineInverseViewMatrix}_getViewMatrixByIndex(t){return this.LookingGlassInverseViewMatrices[t]=this.LookingGlassInverseViewMatrices[t]||v.mat4.create()}getInputSources(){return[]}getInputPose(t,e,n){return null}onWindowResize(){}}let be=0;class pe{constructor(t,e){F(this,"mode");F(this,"immersive");F(this,"id");F(this,"baseLayer");F(this,"inlineVerticalFieldOfView");F(this,"ended");F(this,"enabledFeatures");this.mode=t,this.immersive=t==="immersive-vr"||t==="immersive-ar",this.id=++be,this.baseLayer=null,this.inlineVerticalFieldOfView=Math.PI*.5,this.ended=!1,this.enabledFeatures=e}}class ge extends se.default{constructor(e){super();F(this,"viewIndex");this.viewIndex=e}get eye(){return"none"}_onPoseUpdate(e){this._inverseBaseMatrix=e._getViewMatrixByIndex(this.viewIndex)}}class Z extends ne.default{constructor(t){super(),S(t),console.warn('Looking Glass WebXR "polyfill" overriding native WebXR API.');for(const n in K.default)this.global[n]=K.default[n];this.global.XRWebGLLayer=ue,this.injected=!0;const e=Promise.resolve(new me(this.global));this.xr=new ae.default(e),Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})}get config(){return S()}set config(t){S(t)}}const ye=new Z;ye.config={tileHeight:3},g.LookingGlassWebXRPolyfill=Z,Object.defineProperties(g,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
