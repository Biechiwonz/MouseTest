(function(w,S){typeof exports=="object"&&typeof module<"u"?S(exports,require("@lookingglass/webxr-polyfill/src/api/index"),require("@lookingglass/webxr-polyfill/src/api/XRSystem"),require("@lookingglass/webxr-polyfill/src/WebXRPolyfill"),require("holoplay-core"),require("@lookingglass/webxr-polyfill/src/devices/XRDevice"),require("@lookingglass/webxr-polyfill/src/api/XRSpace"),require("gl-matrix"),require("@lookingglass/webxr-polyfill/src/api/XRWebGLLayer")):typeof define=="function"&&define.amd?define(["exports","@lookingglass/webxr-polyfill/src/api/index","@lookingglass/webxr-polyfill/src/api/XRSystem","@lookingglass/webxr-polyfill/src/WebXRPolyfill","holoplay-core","@lookingglass/webxr-polyfill/src/devices/XRDevice","@lookingglass/webxr-polyfill/src/api/XRSpace","gl-matrix","@lookingglass/webxr-polyfill/src/api/XRWebGLLayer"],S):(w=typeof globalThis<"u"?globalThis:w||self,S(w["Looking Glass WebXR"]={},w["@lookingglass/webxr-polyfill/src/api/index"],w["@lookingglass/webxr-polyfill/src/api/XRSystem"],w["@lookingglass/webxr-polyfill/src/WebXRPolyfill"],w.holoPlayCore,w["@lookingglass/webxr-polyfill/src/devices/XRDevice"],w["@lookingglass/webxr-polyfill/src/api/XRSpace"],w.glMatrix,w["@lookingglass/webxr-polyfill/src/api/XRWebGLLayer"]))})(this,function(w,S,I,te,q,ie,ne,E,Y){"use strict";var Be=Object.defineProperty;var Ie=(w,S,I)=>S in w?Be(w,S,{enumerable:!0,configurable:!0,writable:!0,value:I}):w[S]=I;var x=(w,S,I)=>(Ie(w,typeof S!="symbol"?S+"":S,I),I);const V=o=>o&&typeof o=="object"&&"default"in o?o:{default:o};function oe(o){if(o&&o.__esModule)return o;const i=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(o){for(const e in o)if(e!=="default"){const n=Object.getOwnPropertyDescriptor(o,e);Object.defineProperty(i,e,n.get?n:{enumerable:!0,get:()=>o[e]})}}return i.default=o,Object.freeze(i)}const j=V(S),re=V(I),se=V(te),z=oe(q),ae=V(ie),le=V(ne),ce=V(Y),U=1.6;let X=3840;var N;(function(o){o[o.Swizzled=0]="Swizzled",o[o.Center=1]="Center",o[o.Quilt=2]="Quilt"})(N||(N={}));class de extends EventTarget{constructor(e){super();x(this,"_calibration",{configVersion:"1.0",pitch:{value:45},slope:{value:-5},center:{value:-.5},viewCone:{value:40},invView:{value:1},verticalAngle:{value:0},DPI:{value:338},screenW:{value:250},screenH:{value:250},flipImageX:{value:0},flipImageY:{value:0},flipSubp:{value:0},serial:"LKG-DEFAULT-#####"});x(this,"_viewControls",{tileHeight:512,numViews:45,trackballX:0,trackballY:0,targetX:0,targetY:U,targetZ:-.5,targetDiam:2,fovy:13/180*Math.PI,depthiness:1.25,inlineView:N.Center,capturing:!1,popup:null,XRSession:null});x(this,"LookingGlassDetected");this._viewControls={...this._viewControls,...e},this.syncCalibration()}syncCalibration(){new z.Client(e=>{if(e.devices.length<1){console.log("No Looking Glass devices found");return}e.devices.length>1&&console.log("More than one Looking Glass device found... using the first one"),this.calibration=e.devices[0].calibration})}addEventListener(e,n,t){super.addEventListener(e,n,t)}onConfigChange(){this.dispatchEvent(new Event("on-config-changed"))}get calibration(){return this._calibration}set calibration(e){this._calibration={...this._calibration,...e},this.onConfigChange()}updateViewControls(e){e!=null&&(this._viewControls={...this._viewControls,...e},this.onConfigChange())}get tileHeight(){return Math.round(X/this.quiltHeight)}set tileHeight(e){this.updateViewControls({tileHeight:e})}get numViews(){return this.quiltWidth*this.quiltHeight}get targetX(){return this._viewControls.targetX}set targetX(e){this.updateViewControls({targetX:e})}get targetY(){return this._viewControls.targetY}set targetY(e){this.updateViewControls({targetY:e})}get targetZ(){return this._viewControls.targetZ}set targetZ(e){this.updateViewControls({targetZ:e})}get trackballX(){return this._viewControls.trackballX}set trackballX(e){this.updateViewControls({trackballX:e})}get trackballY(){return this._viewControls.trackballY}set trackballY(e){this.updateViewControls({trackballY:e})}get targetDiam(){return this._viewControls.targetDiam}set targetDiam(e){this.updateViewControls({targetDiam:e})}get fovy(){return this._viewControls.fovy}set fovy(e){this.updateViewControls({fovy:e})}get depthiness(){return this._viewControls.depthiness}set depthiness(e){this.updateViewControls({depthiness:e})}get inlineView(){return this._viewControls.inlineView}set inlineView(e){this.updateViewControls({inlineView:e})}get capturing(){return this._viewControls.capturing}set capturing(e){this.updateViewControls({capturing:e})}get popup(){return this._viewControls.popup}set popup(e){this.updateViewControls({popup:e})}get XRSession(){return this._viewControls.XRSession}set XRSession(e){this.updateViewControls({XRSession:e})}get aspect(){return this._calibration.screenW.value/this._calibration.screenH.value}get tileWidth(){return Math.round(X/this.quiltWidth)}get framebufferWidth(){return this._calibration.screenW.value<7e3?X:8192}get quiltWidth(){return this.calibration.screenW.value==1536?8:this.calibration.screenW.value==3840||this.calibration.screenW.value==8192?5:8}get quiltHeight(){return this.calibration.screenW.value==1536?6:this.calibration.screenW.value==3840||this.calibration.screenW.value==8192?9:6}get framebufferHeight(){return this._calibration.screenW.value<7e3?X:8192}get viewCone(){return this._calibration.viewCone.value*this.depthiness/180*Math.PI}get tilt(){return this._calibration.screenH.value/(this._calibration.screenW.value*this._calibration.slope.value)*(this._calibration.flipImageX.value?-1:1)}set tilt(e){}get subp(){return 1/(this._calibration.screenW.value*3)}get pitch(){const e=this._calibration.screenW.value/this._calibration.DPI.value;return this._calibration.pitch.value*e*Math.cos(Math.atan(1/this._calibration.slope.value))}}let H=null;function k(){return H==null&&(H=new de),H}function $(o){const i=k();o!=null&&i.updateViewControls(o)}function ue(o,i){const e=new MediaSource;e.addEventListener("sourceopen",F,!1);let n,t,a,r;const f=document.getElementById("looking-glass-video"),b=document.getElementById("recordbutton"),v=document.getElementById("downloadbutton"),p=document.getElementById("screenshotbutton");b==null||b.addEventListener("click",d),v==null||v.addEventListener("click",y),p==null||p.addEventListener("click",T);function F(u){console.log("MediaSource opened"),a=e.addSourceBuffer('video/webm; codecs="h264"'),console.log("Source buffer: ",a)}function C(u){u.data&&u.data.size>0&&t.push(u.data)}function s(u){console.log("Recorder stopped: ",u);const h=new Blob(t,{type:"video/webm"});f&&(f.src=window.URL.createObjectURL(h))}function d(){r==null?(r=o.captureStream(),console.log("Started stream capture from canvas element: ",r)):(r=null,console.log("theoretically set stream to null and stop capture",r)),i.capturing===!1?(i.capturing=!0,i.inlineView!=2&&(i.inlineView=2),c()):(m(),i.capturing=!1,b&&v&&(b.textContent="Record",v.disabled=!1))}function c(){let u={mimeType:"video/webm"};t=[];try{n=new MediaRecorder(r,u)}catch(h){console.log("Unable to create MediaRecorder with options Object: ",h);try{u={mimeType:"video/webm,codecs=h264"},n=new MediaRecorder(r,u)}catch(l){console.log("Unable to create MediaRecorder with options Object: ",l);try{u={mimeType:"video/h264"},n=new MediaRecorder(r,u)}catch(L){alert(`MediaRecorder is not supported by this browser.

Try Firefox 29 or later, or Chrome 47 or later, with Enable experimental Web Platform features enabled from chrome://flags.`),console.error("Exception while creating MediaRecorder:",L);return}}}console.log("Created MediaRecorder",n,"with options",u),b&&v&&(b.textContent="Stop Recording",v.disabled=!0),n.onstop=s,n.ondataavailable=C,n.start(100),console.log("MediaRecorder started",n)}function m(){n.stop(),console.log("Recorded Blobs: ",t)}function y(){const u=new Blob(t,{type:"video/webm"}),h=window.URL.createObjectURL(u),l=document.createElement("a");l.style.display="none",l.href=h,l.download=`hologram_qs${i.quiltWidth}x${i.quiltHeight}a${i.aspect}.webm`,document.body.appendChild(l),l.click(),setTimeout(()=>{document.body.removeChild(l),window.URL.revokeObjectURL(h)},100)}function T(){let u=o.toDataURL();const h=document.createElement("a");h.style.display="none",h.href=u,h.download=`hologram_qs${i.quiltWidth}x${i.quiltHeight}a${i.aspect}.png`,document.body.appendChild(h),h.click(),document.body.removeChild(h),window.URL.revokeObjectURL(u)}}function he(o,i){var C;const e=k(),n=document.createElement("style");document.head.appendChild(n),(C=n.sheet)==null||C.insertRule("#LookingGlassWebXRControls * { all: revert; font-family: sans-serif }");const t=document.createElement("div");t.id="LookingGlassWebXRControls",t.style.position="fixed",t.style.zIndex="1000",t.style.padding="15px",t.style.width="320px",t.style.maxWidth="calc(100vw - 18px)",t.style.maxHeight="calc(100vh - 18px)",t.style.whiteSpace="nowrap",t.style.background="rgba(0, 0, 0, 0.6)",t.style.color="white",t.style.borderRadius="10px",t.style.right="15px",t.style.bottom="15px",t.style.flex="row";const a=document.createElement("div");t.appendChild(a),a.style.width="100%",a.style.textAlign="center",a.style.fontWeight="bold",a.style.marginBottom="8px",a.innerText="Looking Glass Controls";const r=document.createElement("button");r.style.display="block",r.style.margin="auto",r.style.width="100%",r.style.height="35px",r.style.padding="4px",r.style.marginBottom="8px",r.style.borderRadius="8px",r.id="screenshotbutton",t.appendChild(r),r.innerText="Save Hologram";const f=document.createElement("div");t.appendChild(f),f.style.width="290px",f.style.whiteSpace="normal",f.style.color="rgba(255,255,255,0.7)",f.style.fontSize="14px",f.style.margin="5px 0",f.innerHTML="Click the popup and use WASD, mouse left/right drag, and scroll.";const b=document.createElement("div");t.appendChild(b);const v=(s,d,c)=>{const m=c.stringify,y=document.createElement("div");y.style.marginBottom="8px",b.appendChild(y);const T=s,u=e[s],h=document.createElement("label");y.appendChild(h),h.innerText=c.label,h.setAttribute("for",T),h.style.width="100px",h.style.display="inline-block",h.style.textDecoration="dotted underline 1px",h.style.fontFamily='"Courier New"',h.style.fontSize="13px",h.style.fontWeight="bold",h.title=c.title;const l=document.createElement("input");y.appendChild(l),Object.assign(l,d),l.id=T,l.title=c.title,l.value=d.value!==void 0?d.value:u;const L=g=>{e[s]=g,A(g)};l.oninput=()=>{const g=d.type==="range"?parseFloat(l.value):d.type==="checkbox"?l.checked:l.value;L(g)};const P=g=>{let _=g(e[s]);c.fixRange&&(_=c.fixRange(_),l.max=Math.max(parseFloat(l.max),_).toString(),l.min=Math.min(parseFloat(l.min),_).toString()),l.value=_,L(_)};d.type==="range"&&(l.style.width="110px",l.style.height="8px",l.onwheel=g=>{P(_=>_+Math.sign(g.deltaX-g.deltaY)*d.step)});let A=g=>{};if(m){const g=document.createElement("span");g.style.fontFamily='"Courier New"',g.style.fontSize="13px",g.style.marginLeft="3px",y.appendChild(g),A=_=>{g.innerHTML=m(_)},A(u)}return P};v("fovy",{type:"range",min:1/180*Math.PI,max:120.1/180*Math.PI,step:1/180*Math.PI},{label:"fov",title:"perspective fov (degrades stereo effect)",fixRange:s=>Math.max(1/180*Math.PI,Math.min(s,120.1/180*Math.PI)),stringify:s=>{const d=s/Math.PI*180,c=Math.atan(Math.tan(s/2)*e.aspect)*2/Math.PI*180;return`${d.toFixed()}&deg;&times;${c.toFixed()}&deg;`}}),v("depthiness",{type:"range",min:0,max:2,step:.01},{label:"depthiness",title:'exaggerates depth by multiplying the width of the view cone (as reported by the firmware) - can somewhat compensate for depthiness lost using higher fov. 1.25 seems to be most physically accurate on Looking Glass 8.9".',fixRange:s=>Math.max(0,s),stringify:s=>`${s.toFixed(2)}x`}),v("inlineView",{type:"range",min:0,max:2,step:1},{label:"inline view",title:"what to show inline on the original canvas (swizzled = no overwrite)",fixRange:s=>Math.max(0,Math.min(s,2)),stringify:s=>s===0?"swizzled":s===1?"center":s===2?"quilt":"?"}),o.oncontextmenu=s=>{s.preventDefault()},o.addEventListener("wheel",s=>{const d=e.targetDiam,c=1.1,m=Math.log(d)/Math.log(c);return e.targetDiam=Math.pow(c,m+s.deltaY*.01)}),o.addEventListener("mousemove",s=>{const d=s.movementX,c=-s.movementY;if(s.buttons&2||s.buttons&1&&(s.shiftKey||s.ctrlKey)){const m=e.trackballX,y=e.trackballY,T=-Math.cos(m)*d+Math.sin(m)*Math.sin(y)*c,u=-Math.cos(y)*c,h=Math.sin(m)*d+Math.cos(m)*Math.sin(y)*c;e.targetX=e.targetX+T*e.targetDiam*.001,e.targetY=e.targetY+u*e.targetDiam*.001,e.targetZ=e.targetZ+h*e.targetDiam*.001}else s.buttons&1&&(e.trackballX=e.trackballX-d*.01,e.trackballY=e.trackballY-c*.01)});const p={w:0,a:0,s:0,d:0};o.addEventListener("keydown",s=>{switch(s.code){case"KeyW":p.w=1;break;case"KeyA":p.a=1;break;case"KeyS":p.s=1;break;case"KeyD":p.d=1;break}}),o.addEventListener("keyup",s=>{switch(s.code){case"KeyW":p.w=0;break;case"KeyA":p.a=0;break;case"KeyS":p.s=0;break;case"KeyD":p.d=0;break}}),requestAnimationFrame(F);function F(){let s=p.d-p.a,d=p.w-p.s;s&&d&&(s*=Math.sqrt(.5),d*=Math.sqrt(.5));const c=e.trackballX,m=e.trackballY,y=Math.cos(c)*s-Math.sin(c)*Math.cos(m)*d,T=-Math.sin(m)*d,u=-Math.sin(c)*s-Math.cos(c)*Math.cos(m)*d;e.targetX=e.targetX+y*e.targetDiam*.03,e.targetY=e.targetY+T*e.targetDiam*.03,e.targetZ=e.targetZ+u*e.targetDiam*.03,requestAnimationFrame(F)}return setTimeout(()=>{ue(i,e)},1e3),t}async function fe(o,i,e,n){const t=await window.getScreenDetails();console.log(t);const a=t.screens.filter(r=>r.label.includes("LKG"))[0];if(console.log(a,"monitors"),a===void 0){console.log("no Looking Glass monitor detected - manually opening popup window"),K(i,o,n);return}else{console.log("monitor ID",a.label,"serial number",i.calibration);const r=[`left=${a.left}`,`top=${a.top}`,`width=${a.width}`,`height=${a.height}`,"menubar=no","toolbar=no","location=no","status=no","resizable=yes","scrollbars=no","fullscreenEnabled=true"].join(",");i.popup=window.open("","new",r),i.popup&&(i.popup.document.body.style.background="black",i.popup.document.body.appendChild(o),console.assert(n),i.popup.onbeforeunload=n)}}async function K(o,i,e){o.popup=window.open("",void 0,"width=640,height=360"),o.popup&&(o.popup.document.title="Looking Glass Window (fullscreen me on Looking Glass!)",o.popup.document.body.style.background="black",o.popup.document.body.appendChild(i),console.assert(e),o.popup.onbeforeunload=e)}const D=Symbol("LookingGlassXRWebGLLayer");class pe extends ce.default{constructor(i,e,n){super(i,e,n);const t=k(),a=e.canvas,r=document.createElement("canvas");r.tabIndex=0;const f=r.getContext("2d",{alpha:!1});r.addEventListener("dblclick",function(){this.requestFullscreen()});const b=he(r,a),v=this[Y.PRIVATE].config,p=e.createTexture();let F,C;const s=e.createFramebuffer(),d=e.enable.bind(e),c=e.disable.bind(e),m=e.getExtension("OES_vertex_array_object"),y=34229,T=m?m.bindVertexArrayOES.bind(m):e.bindVertexArray.bind(e);(v.depth||v.stencil)&&(v.depth&&v.stencil?C={format:e.DEPTH_STENCIL,attachment:e.DEPTH_STENCIL_ATTACHMENT}:v.depth?C={format:e.DEPTH_COMPONENT16,attachment:e.DEPTH_ATTACHMENT}:v.stencil&&(C={format:e.STENCIL_INDEX8,attachment:e.STENCIL_ATTACHMENT}),F=e.createRenderbuffer());const u=()=>{const R=e.getParameter(e.TEXTURE_BINDING_2D);if(e.bindTexture(e.TEXTURE_2D,p),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t.framebufferWidth,t.framebufferHeight,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.bindTexture(e.TEXTURE_2D,R),F){const M=e.getParameter(e.RENDERBUFFER_BINDING);e.bindRenderbuffer(e.RENDERBUFFER,F),e.renderbufferStorage(e.RENDERBUFFER,C.format,t.framebufferWidth,t.framebufferHeight),e.bindRenderbuffer(e.RENDERBUFFER,M)}};u(),t.addEventListener("on-config-changed",u);const h=e.getParameter(e.FRAMEBUFFER_BINDING);e.bindFramebuffer(e.FRAMEBUFFER,s),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,p,0),(v.depth||v.stencil)&&e.framebufferRenderbuffer(e.FRAMEBUFFER,C.attachment,e.RENDERBUFFER,F),e.bindFramebuffer(e.FRAMEBUFFER,h);const l=e.createProgram(),L=e.createShader(e.VERTEX_SHADER),P=e.createShader(e.FRAGMENT_SHADER);if(l===null||L===null||P===null){console.error("there was a problem with shader construction");return}e.attachShader(l,L),e.attachShader(l,P);{const R=`
       attribute vec2 a_position;
       varying vec2 v_texcoord;
       void main() {
         gl_Position = vec4(a_position * 2.0 - 1.0, 0.0, 1.0);
         v_texcoord = a_position;
       }
     `;e.shaderSource(L,R),e.compileShader(L),e.getShaderParameter(L,e.COMPILE_STATUS)||console.warn(e.getShaderInfoLog(L))}let A,g,_;const Z=()=>{const R=q.Shader(t);if(R===A)return;if(A=R,e.shaderSource(P,R),e.compileShader(P),!e.getShaderParameter(P,e.COMPILE_STATUS)){console.warn(e.getShaderInfoLog(P));return}if(e.linkProgram(l),!e.getProgramParameter(l,e.LINK_STATUS)){console.warn(e.getProgramInfoLog(l));return}g=e.getAttribLocation(l,"a_position"),_=e.getUniformLocation(l,"u_viewType");const M=e.getUniformLocation(l,"u_texture"),B=e.getParameter(e.CURRENT_PROGRAM);e.useProgram(l),e.uniform1i(M,0),e.useProgram(B)};t.addEventListener("on-config-changed",Z);const Q=m?m.createVertexArrayOES():e.createVertexArray(),Re=e.createBuffer(),Te=e.getParameter(e.ARRAY_BUFFER_BINDING),Le=e.getParameter(y);T(Q),e.bindBuffer(e.ARRAY_BUFFER,Re),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW),e.enableVertexAttribArray(g),e.vertexAttribPointer(g,2,e.FLOAT,!1,0,0),T(Le),e.bindBuffer(e.ARRAY_BUFFER,Te);const xe=()=>{console.assert(this[D].LookingGlassEnabled),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer);const R=e.getParameter(e.COLOR_CLEAR_VALUE),M=e.getParameter(e.DEPTH_CLEAR_VALUE),B=e.getParameter(e.STENCIL_CLEAR_VALUE);e.clearColor(0,0,0,0),e.clearDepth(1),e.clearStencil(0),e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT|e.STENCIL_BUFFER_BIT),e.clearColor(R[0],R[1],R[2],R[3]),e.clearDepth(M),e.clearStencil(B)};let J,ee;const _e=()=>{if(!this[D].LookingGlassEnabled)return;(a.width!==t.framebufferWidth||a.height!==t.framebufferHeight)&&(J=a.width,ee=a.height,a.width=t.framebufferWidth,a.height=t.framebufferHeight);const R=e.getParameter(y),M=e.getParameter(e.CULL_FACE),B=e.getParameter(e.BLEND),G=e.getParameter(e.DEPTH_TEST),Ce=e.getParameter(e.STENCIL_TEST),Pe=e.getParameter(e.SCISSOR_TEST),W=e.getParameter(e.VIEWPORT),Fe=e.getParameter(e.FRAMEBUFFER_BINDING),ke=e.getParameter(e.RENDERBUFFER_BINDING),Me=e.getParameter(e.CURRENT_PROGRAM),De=e.getParameter(e.ACTIVE_TEXTURE);{const Ae=e.getParameter(e.TEXTURE_BINDING_2D);e.bindFramebuffer(e.FRAMEBUFFER,null),e.useProgram(l),T(Q),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,p),e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.STENCIL_TEST),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),e.uniform1i(_,0),e.drawArrays(e.TRIANGLES,0,6),f==null||f.clearRect(0,0,r.width,r.height),f==null||f.drawImage(a,0,0,t.framebufferWidth,t.framebufferHeight,0,0,t.calibration.screenW.value,t.calibration.screenH.value),t.inlineView!==0&&(t.capturing&&a.width!==t.framebufferWidth&&(a.width=t.framebufferWidth,a.height=t.framebufferHeight,e.viewport(0,0,t.framebufferHeight,t.framebufferWidth)),e.uniform1i(_,t.inlineView),e.drawArrays(e.TRIANGLES,0,6)),e.bindTexture(e.TEXTURE_2D,Ae)}e.activeTexture(De),e.useProgram(Me),e.bindRenderbuffer(e.RENDERBUFFER,ke),e.bindFramebuffer(e.FRAMEBUFFER,Fe),e.viewport(W[0],W[1],W[2],W[3]),(Pe?d:c)(e.SCISSOR_TEST),(Ce?d:c)(e.STENCIL_TEST),(G?d:c)(e.DEPTH_TEST),(B?d:c)(e.BLEND),(M?d:c)(e.CULL_FACE),T(R)};window.addEventListener("unload",()=>{t.popup&&t.popup.close(),t.popup=null});const Se=(R,M)=>{var B;if(!!t.popup!=R)if(R){Z(),r.style.position="fixed",r.style.bottom="0",r.style.left="0",r.width=t.calibration.screenW.value,r.height=t.calibration.screenH.value,document.body.appendChild(b);const G="getScreenDetails"in window;console.log(G,"Screen placement API exists"),G?fe(r,t,R,M):K(t,r,M)}else(B=b.parentElement)==null||B.removeChild(b),a.width=J,a.height=ee,t.popup&&(t.popup.onbeforeunload=null,t.popup.close(),t.popup=null)};this[D]={LookingGlassEnabled:!1,framebuffer:s,clearFramebuffer:xe,blitTextureToDefaultFramebufferIfNeeded:_e,moveCanvasToWindow:Se}}get framebuffer(){return this[D].LookingGlassEnabled?this[D].framebuffer:null}get framebufferWidth(){return k().framebufferWidth}get framebufferHeight(){return k().framebufferHeight}}class me extends ae.default{constructor(i){super(i),this.sessions=new Map,this.viewSpaces=[],this.basePoseMatrix=E.mat4.create(),this.inlineProjectionMatrix=E.mat4.create(),this.inlineInverseViewMatrix=E.mat4.create(),this.LookingGlassProjectionMatrices=[],this.LookingGlassInverseViewMatrices=[]}onBaseLayerSet(i,e){const n=this.sessions.get(i);n.baseLayer=e;const t=k(),a=e[D];a.LookingGlassEnabled=n.immersive,n.immersive&&(t.XRSession=this.sessions.get(i),a.moveCanvasToWindow(!0,()=>{this.endSession(i)}))}isSessionSupported(i){return i==="inline"||i==="immersive-vr"}isFeatureSupported(i){switch(i){case"viewer":return!0;case"local":return!0;case"local-floor":return!0;case"bounded-floor":return!1;case"unbounded":return!1;default:return console.warn("LookingGlassXRDevice.isFeatureSupported: feature not understood:",i),!1}}async requestSession(i,e){if(!this.isSessionSupported(i))return Promise.reject();const n=i!=="inline",t=new we(i,e);return this.sessions.set(t.id,t),n&&this.dispatchEvent("@@webxr-polyfill/vr-present-start",t.id),Promise.resolve(t.id)}requestAnimationFrame(i){return this.global.requestAnimationFrame(i)}cancelAnimationFrame(i){this.global.cancelAnimationFrame(i)}onFrameStart(i,e){const n=this.sessions.get(i),t=k();if(n.immersive){const a=Math.tan(.5*t.fovy),r=.5*t.targetDiam/a,f=r-t.targetDiam,b=this.basePoseMatrix;E.mat4.fromTranslation(b,[t.targetX,t.targetY,t.targetZ]),E.mat4.rotate(b,b,t.trackballX,[0,1,0]),E.mat4.rotate(b,b,-t.trackballY,[1,0,0]),E.mat4.translate(b,b,[0,0,r]);for(let p=0;p<t.numViews;++p){const F=(p+.5)/t.numViews-.5,C=Math.tan(t.viewCone*F),s=r*C,d=this.LookingGlassInverseViewMatrices[p]=this.LookingGlassInverseViewMatrices[p]||E.mat4.create();E.mat4.translate(d,b,[s,0,0]),E.mat4.invert(d,d);const c=Math.max(f+e.depthNear,.01),m=f+e.depthFar,y=c*a,T=y,u=-y,h=c*-C,l=t.aspect*y,L=h+l,P=h-l,A=this.LookingGlassProjectionMatrices[p]=this.LookingGlassProjectionMatrices[p]||E.mat4.create();E.mat4.set(A,2*c/(L-P),0,0,0,0,2*c/(T-u),0,0,(L+P)/(L-P),(T+u)/(T-u),-(m+c)/(m-c),-1,0,0,-2*m*c/(m-c),0)}n.baseLayer[D].clearFramebuffer()}else{const a=n.baseLayer.context,r=a.drawingBufferWidth/a.drawingBufferHeight;E.mat4.perspective(this.inlineProjectionMatrix,e.inlineVerticalFieldOfView,r,e.depthNear,e.depthFar),E.mat4.fromTranslation(this.basePoseMatrix,[0,U,0]),E.mat4.invert(this.inlineInverseViewMatrix,this.basePoseMatrix)}}onFrameEnd(i){this.sessions.get(i).baseLayer[D].blitTextureToDefaultFramebufferIfNeeded()}async requestFrameOfReferenceTransform(i,e){const n=E.mat4.create();switch(i){case"viewer":case"local":return E.mat4.fromTranslation(n,[0,-U,0]),n;case"local-floor":return n;default:throw new Error("XRReferenceSpaceType not understood")}}endSession(i){const e=this.sessions.get(i);e.immersive&&e.baseLayer&&(e.baseLayer[D].moveCanvasToWindow(!1),this.dispatchEvent("@@webxr-polyfill/vr-present-end",i)),e.ended=!0}doesSessionSupportReferenceSpace(i,e){const n=this.sessions.get(i);return n.ended?!1:n.enabledFeatures.has(e)}getViewSpaces(i){if(i==="immersive-vr"){const e=k();for(let n=this.viewSpaces.length;n<e.numViews;++n)this.viewSpaces[n]=new ve(n);return this.viewSpaces.length=e.numViews,this.viewSpaces}}getViewport(i,e,n,t,a){if(a===void 0){const f=this.sessions.get(i).baseLayer.context;t.x=0,t.y=0,t.width=f.drawingBufferWidth,t.height=f.drawingBufferHeight}else{const r=k(),f=a%r.quiltWidth,b=Math.floor(a/r.quiltWidth);t.x=r.tileWidth*f,t.y=r.tileHeight*b,t.width=r.tileWidth,t.height=r.tileHeight}return!0}getProjectionMatrix(i,e){return e===void 0?this.inlineProjectionMatrix:this.LookingGlassProjectionMatrices[e]||E.mat4.create()}getBasePoseMatrix(){return this.basePoseMatrix}getBaseViewMatrix(){return this.inlineInverseViewMatrix}_getViewMatrixByIndex(i){return this.LookingGlassInverseViewMatrices[i]=this.LookingGlassInverseViewMatrices[i]||E.mat4.create()}getInputSources(){return[]}getInputPose(i,e,n){return null}onWindowResize(){}}let be=0;class we{constructor(i,e){x(this,"mode");x(this,"immersive");x(this,"id");x(this,"baseLayer");x(this,"inlineVerticalFieldOfView");x(this,"ended");x(this,"enabledFeatures");this.mode=i,this.immersive=i==="immersive-vr"||i==="immersive-ar",this.id=++be,this.baseLayer=null,this.inlineVerticalFieldOfView=Math.PI*.5,this.ended=!1,this.enabledFeatures=e}}class ve extends le.default{constructor(e){super();x(this,"viewIndex");this.viewIndex=e}get eye(){return"none"}_onPoseUpdate(e){this._inverseBaseMatrix=e._getViewMatrixByIndex(this.viewIndex)}}class O extends se.default{constructor(e){super();x(this,"vrButton");x(this,"device");x(this,"isPresenting",!1);$(e),this.loadPolyfill()}static async init(e){new O(e)}static async detectLookingGlassDevice(){return new Promise(e=>{new z.Client(async n=>{console.log(n,"message from core"),n.devices.length>0?e(!0):e(!1)})})}async loadPolyfill(){this.overrideDefaultVRButton(),console.warn('Looking Glass WebXR "polyfill" overriding native WebXR API.');for(const e in j.default)this.global[e]=j.default[e];this.global.XRWebGLLayer=pe,this.injected=!0,this.device=new me(this.global),this.xr=new re.default(Promise.resolve(this.device)),Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})}async overrideDefaultVRButton(){this.vrButton=await ye("VRButton"),this.vrButton&&this.device&&(this.device.addEventListener("@@webxr-polyfill/vr-present-start",()=>{this.isPresenting=!0,this.updateVRButtonUI()}),this.device.addEventListener("@@webxr-polyfill/vr-present-end",()=>{this.isPresenting=!1,this.updateVRButtonUI()}),this.vrButton.addEventListener("click",e=>{this.updateVRButtonUI()}),this.updateVRButtonUI())}async updateVRButtonUI(){if(this.vrButton){await ge(100),this.isPresenting?this.vrButton.innerHTML="EXIT LOOKING GLASS":this.vrButton.innerHTML="ENTER LOOKING GLASS";const e=220;this.vrButton.style.width=`${e}px`,this.vrButton.style.left=`calc(50% - ${e/2}px)`}}update(e){$(e)}}async function ye(o){return new Promise((i,e)=>{const n=new MutationObserver(function(t){t.forEach(function(a){a.addedNodes.forEach(function(r){const f=r;f.id==o&&(i(f),n.disconnect())})})});n.observe(document.body,{subtree:!1,childList:!0}),setTimeout(()=>{n.disconnect(),e(`id:${o} not found`)},5e3)})}function ge(o){return new Promise(i=>setTimeout(i,o))}const Ee=k();w.LookingGlassConfig=Ee,w.LookingGlassWebXRPolyfill=O,Object.defineProperties(w,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
