(function(v,P){typeof exports=="object"&&typeof module<"u"?P(exports,require("@lookingglass/webxr-polyfill/src/api/index"),require("@lookingglass/webxr-polyfill/src/api/XRSystem"),require("@lookingglass/webxr-polyfill/src/WebXRPolyfill"),require("holoplay-core"),require("@lookingglass/webxr-polyfill/src/devices/XRDevice"),require("@lookingglass/webxr-polyfill/src/api/XRSpace"),require("gl-matrix"),require("@lookingglass/webxr-polyfill/src/api/XRWebGLLayer")):typeof define=="function"&&define.amd?define(["exports","@lookingglass/webxr-polyfill/src/api/index","@lookingglass/webxr-polyfill/src/api/XRSystem","@lookingglass/webxr-polyfill/src/WebXRPolyfill","holoplay-core","@lookingglass/webxr-polyfill/src/devices/XRDevice","@lookingglass/webxr-polyfill/src/api/XRSpace","gl-matrix","@lookingglass/webxr-polyfill/src/api/XRWebGLLayer"],P):(v=typeof globalThis<"u"?globalThis:v||self,P(v["Looking Glass WebXR"]={},v["@lookingglass/webxr-polyfill/src/api/index"],v["@lookingglass/webxr-polyfill/src/api/XRSystem"],v["@lookingglass/webxr-polyfill/src/WebXRPolyfill"],v.holoPlayCore,v["@lookingglass/webxr-polyfill/src/devices/XRDevice"],v["@lookingglass/webxr-polyfill/src/api/XRSpace"],v.glMatrix,v["@lookingglass/webxr-polyfill/src/api/XRWebGLLayer"]))})(this,function(v,P,A,ee,j,te,ne,g,q){"use strict";var De=Object.defineProperty;var Me=(v,P,A)=>P in v?De(v,P,{enumerable:!0,configurable:!0,writable:!0,value:A}):v[P]=A;var _=(v,P,A)=>(Me(v,typeof P!="symbol"?P+"":P,A),A);const V=a=>a&&typeof a=="object"&&"default"in a?a:{default:a};function ie(a){if(a&&a.__esModule)return a;const n=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(a){for(const e in a)if(e!=="default"){const o=Object.getOwnPropertyDescriptor(a,e);Object.defineProperty(n,e,o.get?o:{enumerable:!0,get:()=>a[e]})}}return n.default=a,Object.freeze(n)}const z=V(P),oe=V(A),re=V(ee),K=ie(j),ae=V(te),se=V(ne),ce=V(q),O=1.6;let N=3360;var H;(function(a){a[a.Swizzled=0]="Swizzled",a[a.Center=1]="Center",a[a.Quilt=2]="Quilt"})(H||(H={}));class le extends EventTarget{constructor(e){super();_(this,"_calibration",{configVersion:"1.0",pitch:{value:45},slope:{value:-5},center:{value:-.5},viewCone:{value:40},invView:{value:1},verticalAngle:{value:0},DPI:{value:338},screenW:{value:250},screenH:{value:250},flipImageX:{value:0},flipImageY:{value:0},flipSubp:{value:0},serial:"LKG-DEFAULT-#####"});_(this,"_viewControls",{tileHeight:512,numViews:45,trackballX:0,trackballY:0,targetX:0,targetY:O,targetZ:-.5,targetDiam:2,fovy:13/180*Math.PI,depthiness:1.25,inlineView:H.Center,capturing:!1,popup:null});_(this,"LookingGlassDetected");this._viewControls={...this._viewControls,...e},this.syncCalibration()}syncCalibration(){new K.Client(e=>{if(e.devices.length<1){console.log("No Looking Glass devices found");return}e.devices.length>1&&console.log("More than one Looking Glass device found... using the first one"),this.calibration=e.devices[0].calibration})}addEventListener(e,o,t){super.addEventListener(e,o,t)}onConfigChange(){this.dispatchEvent(new Event("on-config-changed"))}get calibration(){return this._calibration}set calibration(e){this._calibration={...this._calibration,...e},this.onConfigChange()}updateViewControls(e){e!=null&&(this._viewControls={...this._viewControls,...e},this.onConfigChange())}get tileHeight(){return N/6}get numViews(){return 48}get targetX(){return this._viewControls.targetX}set targetX(e){this.updateViewControls({targetX:e})}get targetY(){return this._viewControls.targetY}set targetY(e){this.updateViewControls({targetY:e})}get targetZ(){return this._viewControls.targetZ}set targetZ(e){this.updateViewControls({targetZ:e})}get trackballX(){return this._viewControls.trackballX}set trackballX(e){this.updateViewControls({trackballX:e})}get trackballY(){return this._viewControls.trackballY}set trackballY(e){this.updateViewControls({trackballY:e})}get targetDiam(){return this._viewControls.targetDiam}set targetDiam(e){this.updateViewControls({targetDiam:e})}get fovy(){return this._viewControls.fovy}set fovy(e){this.updateViewControls({fovy:e})}get depthiness(){return this._viewControls.depthiness}set depthiness(e){this.updateViewControls({depthiness:e})}get inlineView(){return this._viewControls.inlineView}set inlineView(e){this.updateViewControls({inlineView:e})}get capturing(){return this._viewControls.capturing}set capturing(e){this.updateViewControls({capturing:e})}get popup(){return this._viewControls.popup}set popup(e){this.updateViewControls({popup:e})}get aspect(){return .75}get tileWidth(){return N/8}get framebufferWidth(){return this._calibration.screenW.value<8e3?N:8192}get quiltWidth(){return 8}get quiltHeight(){return 6}get framebufferHeight(){return this._calibration.screenW.value<8e3?N:8192}get viewCone(){return this._calibration.viewCone.value*this.depthiness/180*Math.PI}get tilt(){return this._calibration.screenH.value/(this._calibration.screenW.value*this._calibration.slope.value)*(this._calibration.flipImageX.value?-1:1)}get subp(){return 1/(this._calibration.screenW.value*3)}get pitch(){const e=this._calibration.screenW.value/this._calibration.DPI.value;return this._calibration.pitch.value*e*Math.cos(Math.atan(1/this._calibration.slope.value))}}let Y=null;function D(){return Y==null&&(Y=new le),Y}function $(a){const n=D();a!=null&&n.updateViewControls(a)}function de(a,n){const e=new MediaSource;e.addEventListener("sourceopen",F,!1);let o,t,c,r;const h=document.getElementById("looking-glass-video"),f=document.getElementById("recordbutton"),x=document.getElementById("downloadbutton"),y=document.getElementById("screenshotbutton");f.onclick=S,x.onclick=u,y.onclick=l;function F(s){console.log("MediaSource opened"),c=e.addSourceBuffer('video/webm; codecs="h264"'),console.log("Source buffer: ",c)}function C(s){s.data&&s.data.size>0&&t.push(s.data)}function E(s){console.log("Recorder stopped: ",s);const p=new Blob(t,{type:"video/webm"});h.src=window.URL.createObjectURL(p)}function S(){r==null?(r=a.captureStream(),console.log("Started stream capture from canvas element: ",r)):(r=null,console.log("theoretically set stream to null and stop capture",r)),f.textContent==="Record"?(n.capturing=!0,n.inlineView!=2&&(n.inlineView=2),R()):(i(),n.capturing=!1,f.textContent="Record",x.disabled=!1)}function R(){let s={mimeType:"video/webm"};t=[];try{o=new MediaRecorder(r,s)}catch(p){console.log("Unable to create MediaRecorder with options Object: ",p);try{s={mimeType:"video/webm,codecs=h264"},o=new MediaRecorder(r,s)}catch(d){console.log("Unable to create MediaRecorder with options Object: ",d);try{s={mimeType:"video/h264"},o=new MediaRecorder(r,s)}catch(m){alert(`MediaRecorder is not supported by this browser.

Try Firefox 29 or later, or Chrome 47 or later, with Enable experimental Web Platform features enabled from chrome://flags.`),console.error("Exception while creating MediaRecorder:",m);return}}}console.log("Created MediaRecorder",o,"with options",s),f.textContent="Stop Recording",x.disabled=!0,o.onstop=E,o.ondataavailable=C,o.start(100),console.log("MediaRecorder started",o)}function i(){o.stop(),console.log("Recorded Blobs: ",t),h.controls=!0}function u(){const s=new Blob(t,{type:"video/webm"}),p=window.URL.createObjectURL(s),d=document.createElement("a");d.style.display="none",d.href=p,d.download="hologram_qs8x6a0.75.webm",document.body.appendChild(d),d.click(),setTimeout(()=>{document.body.removeChild(d),window.URL.revokeObjectURL(p)},100)}function l(){n.capturing=!0;let s=n.inlineView;n.inlineView!=2&&(n.inlineView=2),setTimeout(()=>{a.toBlob(p=>{const d=window.URL.createObjectURL(p),m=document.createElement("a");m.style.display="none",m.href=d,m.download="hologram_qs8x6a0.75.png",document.body.appendChild(m),m.click(),document.body.removeChild(m),window.URL.revokeObjectURL(d)},"image/png"),n.inlineView=s,n.capturing=!1},250)}}function ue(a,n){var R;const e=D(),o=document.createElement("style");document.head.appendChild(o),(R=o.sheet)==null||R.insertRule("#LookingGlassWebXRControls * { all: revert; font-family: sans-serif }");const t=document.createElement("div");t.id="LookingGlassWebXRControls",t.style.position="fixed",t.style.zIndex="1000",t.style.padding="15px",t.style.width="320px",t.style.maxWidth="calc(100vw - 18px)",t.style.maxHeight="calc(100vh - 18px)",t.style.whiteSpace="nowrap",t.style.background="rgba(0, 0, 0, 0.6)",t.style.color="white",t.style.borderRadius="10px",t.style.right="15px",t.style.bottom="15px",t.style.flex="row";const c=document.createElement("div");t.appendChild(c),c.style.width="100%",c.style.textAlign="center",c.style.fontWeight="bold",c.innerText="Looking Glass Controls";const r=document.createElement("button");r.innerText="Record",t.appendChild(r),r.id="recordbutton";const h=document.createElement("button");h.innerText="Download Video",t.appendChild(h),h.id="downloadbutton";const f=document.createElement("video");t.appendChild(f),f.id="looking-glass-video",f.width=240,f.height=320,f.style.backgroundColor="black",f.style.display="none";const x=document.createElement("button");x.id="screenshotbutton",t.appendChild(x),x.innerText="Take Screenshot";const y=document.createElement("div");t.appendChild(y),y.style.width="100%",y.style.whiteSpace="normal",y.style.color="rgba(255,255,255,0.7)",y.style.fontSize="14px",y.style.margin="5px 0",y.innerHTML="Click the popup and use WASD, mouse left/right drag, and scroll.";const F=document.createElement("div");t.appendChild(F);const C=(i,u,l)=>{const s=l.stringify,p=document.createElement("div");p.style.marginBottom="8px",F.appendChild(p);const d=i,m=e[i],b=document.createElement("label");p.appendChild(b),b.innerText=l.label,b.setAttribute("for",d),b.style.width="100px",b.style.display="inline-block",b.style.textDecoration="dotted underline 1px",b.style.fontFamily='"Courier New"',b.style.fontSize="13px",b.style.fontWeight="bold",b.title=l.title;const w=document.createElement("input");p.appendChild(w),Object.assign(w,u),w.id=d,w.title=l.title,w.value=u.value!==void 0?u.value:m;const X=T=>{e[i]=T,U(T)};w.oninput=()=>{const T=u.type==="range"?parseFloat(w.value):u.type==="checkbox"?w.checked:w.value;X(T)};const G=T=>{let k=T(e[i]);l.fixRange&&(k=l.fixRange(k),w.max=Math.max(parseFloat(w.max),k).toString(),w.min=Math.min(parseFloat(w.min),k).toString()),w.value=k,X(k)};u.type==="range"&&(w.style.width="110px",w.style.height="8px",w.onwheel=T=>{G(k=>k+Math.sign(T.deltaX-T.deltaY)*u.step)});let U=T=>{};if(s){const T=document.createElement("span");T.style.fontFamily='"Courier New"',T.style.fontSize="13px",T.style.marginLeft="3px",p.appendChild(T),U=k=>{T.innerHTML=s(k)},U(m)}return G};C("fovy",{type:"range",min:1/180*Math.PI,max:120.1/180*Math.PI,step:1/180*Math.PI},{label:"fov",title:"perspective fov (degrades stereo effect)",fixRange:i=>Math.max(1/180*Math.PI,Math.min(i,120.1/180*Math.PI)),stringify:i=>{const u=i/Math.PI*180,l=Math.atan(Math.tan(i/2)*e.aspect)*2/Math.PI*180;return`${u.toFixed()}&deg;&times;${l.toFixed()}&deg;`}}),C("depthiness",{type:"range",min:0,max:2,step:.01},{label:"depthiness",title:'exaggerates depth by multiplying the width of the view cone (as reported by the firmware) - can somewhat compensate for depthiness lost using higher fov. 1.25 seems to be most physically accurate on Looking Glass 8.9".',fixRange:i=>Math.max(0,i),stringify:i=>`${i.toFixed(2)}x`}),C("inlineView",{type:"range",min:0,max:2,step:1},{label:"inline view",title:"what to show inline on the original canvas (swizzled = no overwrite)",fixRange:i=>Math.max(0,Math.min(i,2)),stringify:i=>i===0?"swizzled":i===1?"center":i===2?"quilt":"?"}),a.oncontextmenu=i=>{i.preventDefault()},a.addEventListener("wheel",i=>{const u=e.targetDiam,l=1.1,s=Math.log(u)/Math.log(l);return e.targetDiam=Math.pow(l,s+i.deltaY*.01)}),a.addEventListener("mousemove",i=>{const u=i.movementX,l=-i.movementY;if(i.buttons&2||i.buttons&1&&(i.shiftKey||i.ctrlKey)){const s=e.trackballX,p=e.trackballY,d=-Math.cos(s)*u+Math.sin(s)*Math.sin(p)*l,m=-Math.cos(p)*l,b=Math.sin(s)*u+Math.cos(s)*Math.sin(p)*l;e.targetX=e.targetX+d*e.targetDiam*.001,e.targetY=e.targetY+m*e.targetDiam*.001,e.targetZ=e.targetZ+b*e.targetDiam*.001}else i.buttons&1&&(e.trackballX=e.trackballX-u*.01,e.trackballY=e.trackballY-l*.01)});const E={w:0,a:0,s:0,d:0};a.addEventListener("keydown",i=>{switch(i.code){case"KeyW":E.w=1;break;case"KeyA":E.a=1;break;case"KeyS":E.s=1;break;case"KeyD":E.d=1;break}}),a.addEventListener("keyup",i=>{switch(i.code){case"KeyW":E.w=0;break;case"KeyA":E.a=0;break;case"KeyS":E.s=0;break;case"KeyD":E.d=0;break}}),requestAnimationFrame(S);function S(){let i=E.d-E.a,u=E.w-E.s;i&&u&&(i*=Math.sqrt(.5),u*=Math.sqrt(.5));const l=e.trackballX,s=e.trackballY,p=Math.cos(l)*i-Math.sin(l)*Math.cos(s)*u,d=-Math.sin(s)*u,m=-Math.sin(l)*i-Math.cos(l)*Math.cos(s)*u;e.targetX=e.targetX+p*e.targetDiam*.03,e.targetY=e.targetY+d*e.targetDiam*.03,e.targetZ=e.targetZ+m*e.targetDiam*.03,requestAnimationFrame(S)}return setTimeout(()=>{de(n,e)},1e3),t}const M=Symbol("LookingGlassXRWebGLLayer");class fe extends ce.default{constructor(n,e,o){super(n,e,o);const t=D(),c=e.canvas,r=document.createElement("canvas");r.tabIndex=0;const h=r.getContext("2d",{alpha:!1});r.addEventListener("dblclick",function(){this.requestFullscreen()});const f=ue(r,c),x=this[q.PRIVATE].config,y=e.createTexture();let F,C;const E=e.createFramebuffer(),S=e.enable.bind(e),R=e.disable.bind(e),i=e.getExtension("OES_vertex_array_object"),u=34229,l=i?i.bindVertexArrayOES.bind(i):e.bindVertexArray.bind(e);(x.depth||x.stencil)&&(x.depth&&x.stencil?C={format:e.DEPTH_STENCIL,attachment:e.DEPTH_STENCIL_ATTACHMENT}:x.depth?C={format:e.DEPTH_COMPONENT16,attachment:e.DEPTH_ATTACHMENT}:x.stencil&&(C={format:e.STENCIL_INDEX8,attachment:e.STENCIL_ATTACHMENT}),F=e.createRenderbuffer());const s=()=>{const L=e.getParameter(e.TEXTURE_BINDING_2D);if(e.bindTexture(e.TEXTURE_2D,y),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t.framebufferWidth,t.framebufferHeight,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.bindTexture(e.TEXTURE_2D,L),F){const B=e.getParameter(e.RENDERBUFFER_BINDING);e.bindRenderbuffer(e.RENDERBUFFER,F),e.renderbufferStorage(e.RENDERBUFFER,C.format,t.framebufferWidth,t.framebufferHeight),e.bindRenderbuffer(e.RENDERBUFFER,B)}};s(),t.addEventListener("on-config-changed",s);const p=e.getParameter(e.FRAMEBUFFER_BINDING);e.bindFramebuffer(e.FRAMEBUFFER,E),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,y,0),(x.depth||x.stencil)&&e.framebufferRenderbuffer(e.FRAMEBUFFER,C.attachment,e.RENDERBUFFER,F),e.bindFramebuffer(e.FRAMEBUFFER,p);const d=e.createProgram(),m=e.createShader(e.VERTEX_SHADER);e.attachShader(d,m);const b=e.createShader(e.FRAGMENT_SHADER);e.attachShader(d,b);{const L=`
       attribute vec2 a_position;
       varying vec2 v_texcoord;
       void main() {
         gl_Position = vec4(a_position * 2.0 - 1.0, 0.0, 1.0);
         v_texcoord = a_position;
       }
     `;e.shaderSource(m,L),e.compileShader(m),e.getShaderParameter(m,e.COMPILE_STATUS)||console.warn(e.getShaderInfoLog(m))}let w,X,G;const U=()=>{const L=j.Shader(t);if(L===w)return;if(w=L,e.shaderSource(b,L),e.compileShader(b),!e.getShaderParameter(b,e.COMPILE_STATUS)){console.warn(e.getShaderInfoLog(b));return}if(e.linkProgram(d),!e.getProgramParameter(d,e.LINK_STATUS)){console.warn(e.getProgramInfoLog(d));return}X=e.getAttribLocation(d,"a_position"),G=e.getUniformLocation(d,"u_viewType");const B=e.getUniformLocation(d,"u_texture"),I=e.getParameter(e.CURRENT_PROGRAM);e.useProgram(d),e.uniform1i(B,0),e.useProgram(I)};t.addEventListener("on-config-changed",U);const T=i?i.createVertexArrayOES():e.createVertexArray(),k=e.createBuffer(),ge=e.getParameter(e.ARRAY_BUFFER_BINDING),Ee=e.getParameter(u);l(T),e.bindBuffer(e.ARRAY_BUFFER,k),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW),e.enableVertexAttribArray(X),e.vertexAttribPointer(X,2,e.FLOAT,!1,0,0),l(Ee),e.bindBuffer(e.ARRAY_BUFFER,ge);const Re=()=>{console.assert(this[M].LookingGlassEnabled),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer);const L=e.getParameter(e.COLOR_CLEAR_VALUE),B=e.getParameter(e.DEPTH_CLEAR_VALUE),I=e.getParameter(e.STENCIL_CLEAR_VALUE);e.clearColor(0,0,0,0),e.clearDepth(1),e.clearStencil(0),e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT|e.STENCIL_BUFFER_BIT),e.clearColor(L[0],L[1],L[2],L[3]),e.clearDepth(B),e.clearStencil(I)};let Z,Q;const Te=()=>{if(!this[M].LookingGlassEnabled)return;(c.width!==t.calibration.screenW.value||c.height!==t.calibration.screenH.value)&&!t.capturing&&(Z=c.width,Q=c.height,c.width=t.calibration.screenW.value,c.height=t.calibration.screenH.value);const L=e.getParameter(u),B=e.getParameter(e.CULL_FACE),I=e.getParameter(e.BLEND),J=e.getParameter(e.DEPTH_TEST),xe=e.getParameter(e.STENCIL_TEST),_e=e.getParameter(e.SCISSOR_TEST),Ce=e.getParameter(e.VIEWPORT),Se=e.getParameter(e.FRAMEBUFFER_BINDING),Pe=e.getParameter(e.RENDERBUFFER_BINDING),ke=e.getParameter(e.CURRENT_PROGRAM),Fe=e.getParameter(e.ACTIVE_TEXTURE);{const Be=e.getParameter(e.TEXTURE_BINDING_2D);e.bindFramebuffer(e.FRAMEBUFFER,null),e.useProgram(d),l(T),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,y),e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.STENCIL_TEST),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),e.uniform1i(G,0),e.drawArrays(e.TRIANGLES,0,6),h==null||h.clearRect(0,0,r.width,r.height),t.capturing||h==null||h.drawImage(c,0,0,1536,2048,0,0,1536,2048),t.inlineView!==0&&(t.capturing&&c.width!==t.framebufferWidth&&(c.width=t.framebufferWidth,c.height=t.framebufferHeight,e.viewport(0,0,t.framebufferHeight,t.framebufferWidth)),e.uniform1i(G,t.inlineView),e.drawArrays(e.TRIANGLES,0,6)),e.bindTexture(e.TEXTURE_2D,Be)}e.activeTexture(Fe),e.useProgram(ke),e.bindRenderbuffer(e.RENDERBUFFER,Pe),e.bindFramebuffer(e.FRAMEBUFFER,Se),e.viewport(...Ce),(_e?S:R)(e.SCISSOR_TEST),(xe?S:R)(e.STENCIL_TEST),(J?S:R)(e.DEPTH_TEST),(I?S:R)(e.BLEND),(B?S:R)(e.CULL_FACE),l(L)};window.addEventListener("unload",()=>{t.popup&&t.popup.close(),t.popup=void 0});const Le=(L,B)=>{var I;!!t.popup!=L&&(L?(U(),r.style.position="fixed",r.style.bottom="0",r.style.left="0",r.width=t.calibration.screenW.value,r.height=t.calibration.screenH.value,document.body.appendChild(f),"getScreenDetails"in window?this.placeWindow(r,t,L,B):(t.popup=window.open("",void 0,"width=640,height=360"),t.popup.document.title="Looking Glass Window (fullscreen me on Looking Glass!)",t.popup.document.body.style.background="black",t.popup.document.body.appendChild(r),console.assert(B),t.popup.onbeforeunload=B)):((I=f.parentElement)==null||I.removeChild(f),c.width=Z,c.height=Q,t.popup.onbeforeunload=void 0,t.popup.close(),t.popup=void 0))};this[M]={LookingGlassEnabled:!1,framebuffer:E,clearFramebuffer:Re,blitTextureToDefaultFramebufferIfNeeded:Te,moveCanvasToWindow:Le}}async placeWindow(n,e,o,t){const r=(await window.getScreenDetails()).screens.filter(f=>f.label.includes("LKG"))[0];console.log("monitor ID",r.label,"serial number",e._calibration.serial);const h=[`left=${r.left}`,`top=${r.top}`,`width=${r.width}`,`height=${r.height}`,"menubar=no","toolbar=no","location=no","status=no","resizable=yes","scrollbars=no","fullscreenEnabled=true"].join(",");e.popup=window.open("","new",h),e.popup.document.body.style.background="black",e.popup.document.body.appendChild(n),console.assert(t),e.popup.onbeforeunload=t}get framebuffer(){return this[M].LookingGlassEnabled?this[M].framebuffer:null}get framebufferWidth(){return D().framebufferWidth}get framebufferHeight(){return D().framebufferHeight}}class he extends ae.default{constructor(n){super(n),this.sessions=new Map,this.viewSpaces=[],this.basePoseMatrix=g.mat4.create(),this.inlineProjectionMatrix=g.mat4.create(),this.inlineInverseViewMatrix=g.mat4.create(),this.LookingGlassProjectionMatrices=[],this.LookingGlassInverseViewMatrices=[]}onBaseLayerSet(n,e){const o=this.sessions.get(n);o.baseLayer=e;const t=e[M];t.LookingGlassEnabled=o.immersive,o.immersive&&t.moveCanvasToWindow(!0,()=>{this.endSession(n)})}isSessionSupported(n){return n==="inline"||n==="immersive-vr"}isFeatureSupported(n){switch(n){case"viewer":return!0;case"local":return!0;case"local-floor":return!0;case"bounded-floor":return!1;case"unbounded":return!1;default:return console.warn("LookingGlassXRDevice.isFeatureSupported: feature not understood:",n),!1}}async requestSession(n,e){if(!this.isSessionSupported(n))return Promise.reject();const o=n!=="inline",t=new me(n,e);return this.sessions.set(t.id,t),o&&this.dispatchEvent("@@webxr-polyfill/vr-present-start",t.id),Promise.resolve(t.id)}requestAnimationFrame(n){return this.global.requestAnimationFrame(n)}cancelAnimationFrame(n){this.global.cancelAnimationFrame(n)}onFrameStart(n,e){const o=this.sessions.get(n),t=D();if(o.immersive){const c=Math.tan(.5*t.fovy),r=.5*t.targetDiam/c,h=r-t.targetDiam,f=this.basePoseMatrix;g.mat4.fromTranslation(f,[t.targetX,t.targetY,t.targetZ]),g.mat4.rotate(f,f,t.trackballX,[0,1,0]),g.mat4.rotate(f,f,-t.trackballY,[1,0,0]),g.mat4.translate(f,f,[0,0,r]);for(let y=0;y<t.numViews;++y){const F=(y+.5)/t.numViews-.5,C=Math.tan(t.viewCone*F),E=r*C,S=this.LookingGlassInverseViewMatrices[y]=this.LookingGlassInverseViewMatrices[y]||g.mat4.create();g.mat4.translate(S,f,[E,0,0]),g.mat4.invert(S,S);const R=Math.max(h+e.depthNear,.01),i=h+e.depthFar,u=R*c,l=u,s=-u,p=R*-C,d=t.aspect*u,m=p+d,b=p-d,w=this.LookingGlassProjectionMatrices[y]=this.LookingGlassProjectionMatrices[y]||g.mat4.create();g.mat4.set(w,2*R/(m-b),0,0,0,0,2*R/(l-s),0,0,(m+b)/(m-b),(l+s)/(l-s),-(i+R)/(i-R),-1,0,0,-2*i*R/(i-R),0)}o.baseLayer[M].clearFramebuffer()}else{const c=o.baseLayer.context,r=c.drawingBufferWidth/c.drawingBufferHeight;g.mat4.perspective(this.inlineProjectionMatrix,e.inlineVerticalFieldOfView,r,e.depthNear,e.depthFar),g.mat4.fromTranslation(this.basePoseMatrix,[0,O,0]),g.mat4.invert(this.inlineInverseViewMatrix,this.basePoseMatrix)}}onFrameEnd(n){this.sessions.get(n).baseLayer[M].blitTextureToDefaultFramebufferIfNeeded()}async requestFrameOfReferenceTransform(n,e){const o=g.mat4.create();switch(n){case"viewer":case"local":return g.mat4.fromTranslation(o,[0,-O,0]),o;case"local-floor":return o;default:throw new Error("XRReferenceSpaceType not understood")}}endSession(n){const e=this.sessions.get(n);e.immersive&&e.baseLayer&&(e.baseLayer[M].moveCanvasToWindow(!1),this.dispatchEvent("@@webxr-polyfill/vr-present-end",n)),e.ended=!0}doesSessionSupportReferenceSpace(n,e){const o=this.sessions.get(n);return o.ended?!1:o.enabledFeatures.has(e)}getViewSpaces(n){if(n==="immersive-vr"){const e=D();for(let o=this.viewSpaces.length;o<e.numViews;++o)this.viewSpaces[o]=new be(o);return this.viewSpaces.length=e.numViews,this.viewSpaces}}getViewport(n,e,o,t,c){if(c===void 0){const h=this.sessions.get(n).baseLayer.context;t.x=0,t.y=0,t.width=h.drawingBufferWidth,t.height=h.drawingBufferHeight}else{const r=D(),h=c%r.quiltWidth,f=Math.floor(c/r.quiltWidth);t.x=r.tileWidth*h,t.y=r.tileHeight*f,t.width=r.tileWidth,t.height=r.tileHeight}return!0}getProjectionMatrix(n,e){return e===void 0?this.inlineProjectionMatrix:this.LookingGlassProjectionMatrices[e]||g.mat4.create()}getBasePoseMatrix(){return this.basePoseMatrix}getBaseViewMatrix(){return this.inlineInverseViewMatrix}_getViewMatrixByIndex(n){return this.LookingGlassInverseViewMatrices[n]=this.LookingGlassInverseViewMatrices[n]||g.mat4.create()}getInputSources(){return[]}getInputPose(n,e,o){return null}onWindowResize(){}}let pe=0;class me{constructor(n,e){_(this,"mode");_(this,"immersive");_(this,"id");_(this,"baseLayer");_(this,"inlineVerticalFieldOfView");_(this,"ended");_(this,"enabledFeatures");this.mode=n,this.immersive=n==="immersive-vr"||n==="immersive-ar",this.id=++pe,this.baseLayer=null,this.inlineVerticalFieldOfView=Math.PI*.5,this.ended=!1,this.enabledFeatures=e}}class be extends se.default{constructor(e){super();_(this,"viewIndex");this.viewIndex=e}get eye(){return"none"}_onPoseUpdate(e){this._inverseBaseMatrix=e._getViewMatrixByIndex(this.viewIndex)}}class W extends re.default{constructor(e){super();_(this,"vrButton");_(this,"device");_(this,"isPresenting",!1);$(e),this.loadPolyfill()}static async init(e){await W.detectLookingGlassDevice()&&new W(e)}static async detectLookingGlassDevice(){return new Promise(e=>{new K.Client(async o=>{console.log(o,"message from core"),o.devices.length>0?e(!0):e(!1)})})}async loadPolyfill(){this.overrideDefaultVRButton(),console.warn('Looking Glass WebXR "polyfill" overriding native WebXR API.');for(const e in z.default)this.global[e]=z.default[e];this.global.XRWebGLLayer=fe,this.injected=!0,this.device=new he(this.global),this.xr=new oe.default(Promise.resolve(this.device)),Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})}async overrideDefaultVRButton(){this.vrButton=await we("VRButton"),this.vrButton&&this.device&&(this.device.addEventListener("@@webxr-polyfill/vr-present-start",()=>{this.isPresenting=!0,this.updateVRButtonUI()}),this.device.addEventListener("@@webxr-polyfill/vr-present-end",()=>{this.isPresenting=!1,this.updateVRButtonUI()}),this.vrButton.addEventListener("click",e=>{this.updateVRButtonUI()}),this.updateVRButtonUI())}async updateVRButtonUI(){if(this.vrButton){await ve(100),this.isPresenting?this.vrButton.innerHTML="EXIT LOOKING GLASS":this.vrButton.innerHTML="ENTER LOOKING GLASS";const e=220;this.vrButton.style.width=`${e}px`,this.vrButton.style.left=`calc(50% - ${e/2}px)`}}update(e){$(e)}}async function we(a){return new Promise((n,e)=>{const o=new MutationObserver(function(t){t.forEach(function(c){c.addedNodes.forEach(function(r){const h=r;h.id==a&&(n(h),o.disconnect())})})});o.observe(document.body,{subtree:!1,childList:!0}),setTimeout(()=>{o.disconnect(),e(`id:${a} not found`)},5e3)})}function ve(a){return new Promise(n=>setTimeout(n,a))}const ye=D();v.LookingGlassConfig=ye,v.LookingGlassWebXRPolyfill=W,Object.defineProperties(v,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
