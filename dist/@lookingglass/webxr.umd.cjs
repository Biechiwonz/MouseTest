(function(R,V){typeof exports=="object"&&typeof module<"u"?V(exports,require("@lookingglass/webxr-polyfill/src/WebXRPolyfill"),require("@lookingglass/webxr-polyfill/src/api/XRSystem"),require("@lookingglass/webxr-polyfill/src/api/index"),require("@lookingglass/webxr-polyfill/src/devices/XRDevice"),require("@lookingglass/webxr-polyfill/src/api/XRSpace"),require("gl-matrix"),require("@lookingglass/webxr-polyfill/src/api/XRWebGLLayer"),require("holoplay-core/dist/holoplaycore.module.js"),require("holoplay-core")):typeof define=="function"&&define.amd?define(["exports","@lookingglass/webxr-polyfill/src/WebXRPolyfill","@lookingglass/webxr-polyfill/src/api/XRSystem","@lookingglass/webxr-polyfill/src/api/index","@lookingglass/webxr-polyfill/src/devices/XRDevice","@lookingglass/webxr-polyfill/src/api/XRSpace","gl-matrix","@lookingglass/webxr-polyfill/src/api/XRWebGLLayer","holoplay-core/dist/holoplaycore.module.js","holoplay-core"],V):(R=typeof globalThis<"u"?globalThis:R||self,V(R["Looking Glass WebXR"]={},R["@lookingglass/webxr-polyfill/src/WebXRPolyfill"],R["@lookingglass/webxr-polyfill/src/api/XRSystem"],R["@lookingglass/webxr-polyfill/src/api/index"],R["@lookingglass/webxr-polyfill/src/devices/XRDevice"],R["@lookingglass/webxr-polyfill/src/api/XRSpace"],R.glMatrix,R["@lookingglass/webxr-polyfill/src/api/XRWebGLLayer"],R.holoPlayCore,R.holoPlayCore))})(this,function(R,V,z,K,Z,$,g,H,J,Q){"use strict";const A=n=>n&&typeof n=="object"&&"default"in n?n:{default:n};function ee(n){if(n&&n.__esModule)return n;const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(n){for(const e in n)if(e!=="default"){const a=Object.getOwnPropertyDescriptor(n,e);Object.defineProperty(t,e,a.get?a:{enumerable:!0,get:()=>n[e]})}}return t.default=n,Object.freeze(t)}const te=A(V),ie=A(z),O=A(K),ne=A(Z),ae=A($),se=A(H),re=ee(J),W=1.6;let U;function S(){return U===void 0&&(U=ce()),U}const oe={configVersion:"1.0",pitch:{value:45},slope:{value:-5},center:{value:-.5},viewCone:{value:40},invView:{value:1},verticalAngle:{value:0},DPI:{value:338},screenW:{value:250},screenH:{value:250},flipImageX:{value:0},flipImageY:{value:0},flipSubp:{value:0}},ce=()=>new class extends EventTarget{constructor(){super();const n=t=>{t&&this.dispatchEvent(new Event("on-config-changed")),new Promise(a=>{this._ensureConfigChangeEvent=a}).then(()=>n(!0))};n(!1),this.calibration=oe,new re.Client(t=>{if(t.devices.length<1){console.error("No Looking Glass devices found!");return}t.devices.length>1&&console.warn("More than one Looking Glass device found... using the first one"),this.calibration=t.devices[0].calibration},t=>{console.error("Error creating Looking Glass client:",t)}),this.tileHeight=512,this.numViews=45,this.trackballX=0,this.trackballY=0,this.targetX=0,this.targetY=W,this.targetZ=-.5,this.targetDiam=2,this.fovy=13/180*Math.PI,this.depthiness=1.25,this.inlineView=1}get calibration(){return this._calibration}set calibration(n){this._calibration=Y(n),this._ensureConfigChangeEvent()}get tileHeight(){return this._tileHeight}set tileHeight(n){this._tileHeight=n,this._ensureConfigChangeEvent()}get numViews(){return this._numViews}set numViews(n){this._numViews=n,this._ensureConfigChangeEvent()}get targetX(){return this._targetX}set targetX(n){this._targetX=n,this._ensureConfigChangeEvent()}get targetY(){return this._targetY}set targetY(n){this._targetY=n,this._ensureConfigChangeEvent()}get targetZ(){return this._targetZ}set targetZ(n){this._targetZ=n,this._ensureConfigChangeEvent()}get trackballX(){return this._trackballX}set trackballX(n){this._trackballX=n,this._ensureConfigChangeEvent()}get trackballY(){return this._trackballY}set trackballY(n){this._trackballY=n,this._ensureConfigChangeEvent()}get targetDiam(){return this._targetDiam}set targetDiam(n){this._targetDiam=n,this._ensureConfigChangeEvent()}get fovy(){return this._fovy}set fovy(n){this._fovy=n,this._ensureConfigChangeEvent()}get depthiness(){return this._depthiness}set depthiness(n){this._depthiness=n,this._ensureConfigChangeEvent()}get inlineView(){return this._inlineView}set inlineView(n){this._inlineView=n,this._ensureConfigChangeEvent()}get aspect(){return this.calibration.screenW.value/this.calibration.screenH.value}get tileWidth(){return Math.round(this.tileHeight*this.aspect)}get framebufferWidth(){const n=this.tileWidth*this.tileHeight*this.numViews;return 2**Math.ceil(Math.log2(Math.max(Math.sqrt(n),this.tileWidth)))}get quiltWidth(){return Math.floor(this.framebufferWidth/this.tileWidth)}get quiltHeight(){return Math.ceil(this.numViews/this.quiltWidth)}get framebufferHeight(){return 2**Math.ceil(Math.log2(this.quiltHeight*this.tileHeight))}get viewCone(){return this.calibration.viewCone.value*this.depthiness/180*Math.PI}get tilt(){return this.calibration.screenH.value/(this.calibration.screenW.value*this.calibration.slope.value)*(this.calibration.flipImageX.value?-1:1)}get subp(){return 1/(this.calibration.screenW.value*3)}get pitch(){const n=this.calibration.screenW.value/this.calibration.DPI.value;return this.calibration.pitch.value*n*Math.cos(Math.atan(1/this.calibration.slope.value))}};function Y(n){return Object.freeze(n),n===void 0||Object.getOwnPropertyNames(n).forEach(function(t){n[t]!==null&&(typeof n[t]=="object"||typeof n[t]=="function")&&!Object.isFrozen(n[t])&&Y(n[t])}),n}function le(n){const t=S(),e=document.createElement("style");document.head.appendChild(e),e.sheet.insertRule("#LookingGlassWebXRControls * { all: revert; font-family: sans-serif }");const a=document.createElement("div");a.id="LookingGlassWebXRControls",a.style.position="fixed",a.style.zIndex=1e3,a.style.padding="4px",a.style.width="315px",a.style.height="360px",a.style.maxWidth="calc(100vw - 18px)",a.style.maxHeight="calc(100vh - 18px)",a.style.whiteSpace="nowrap",a.style.overflowY="scroll",a.style.scrollbarWidth="thin",a.style.scrollbarColor="thistle transparent",a.style.background="rgba(0, 0, 0, 0.6)",a.style.color="white",a.style.padding="2px",a.style.border="3px solid black",a.style.right="6px",a.style.bottom="6px";const s=document.createElement("div");a.appendChild(s),s.style.width="100%",s.style.textAlign="center",s.style.fontWeight="bold",s.innerText="LookingGlass View Controls ";const y=document.createElement("div");a.appendChild(y),y.style.width="100%",y.style.whiteSpace="normal",y.style.textAlign="center",y.innerHTML="Camera: click popup and use WASD, mouse left/right drag, and scroll.";const h=document.createElement("input");s.appendChild(h),h.type="button",h.value="\u2190",h._otherValue="\u2192",h.onclick=()=>{[a.style.right,a.style.left]=[a.style.left,a.style.right],[h.value,h._otherValue]=[h._otherValue,h.value]};const u=document.createElement("div");a.appendChild(u);const c=(i,r,l)=>{const f=l.stringify,d=document.createElement("div");u.appendChild(d);const x=i,v=t[i],b=document.createElement("label");if(d.appendChild(b),b.innerText=l.label,b.setAttribute("for",x),b.style.width="80px",b.style.display="inline-block",b.style.textDecoration="dotted underline 1px",b.title=l.title,r.type!=="checkbox"){const p=document.createElement("input");d.appendChild(p),p.type="button",p.value="\u238C",p.alt="reset",p.title="Reset value to default",p.style.padding="0 4px",p.onclick=()=>{o.value=v,o.oninput()}}const o=document.createElement("input");d.appendChild(o),Object.assign(o,r),o.id=x,o.title=l.title,o.value=r.value!==void 0?r.value:v;const X=p=>{t[i]=p,B(p)};o.oninput=()=>{const p=r.type==="range"?parseFloat(o.value):r.type==="checkbox"?o.checked:o.value;X(p)};const N=p=>{let T=p(t[i]);l.fixRange&&(T=l.fixRange(T),o.max=Math.max(parseFloat(o.max),T),o.min=Math.min(parseFloat(o.min),T)),o.value=T,X(T)};r.type==="range"&&(o.style.width="110px",o.style.height="16px",o.onwheel=p=>{N(T=>T+Math.sign(p.deltaX-p.deltaY)*r.step)});let B=()=>{};if(f){const p=document.createElement("span");d.appendChild(p),B=T=>{p.innerHTML=f(T)},B(v)}return N};c("tileHeight",{type:"range",min:160,max:455,step:1},{label:"resolution",title:"resolution of each view",stringify:i=>`${(i*t.aspect).toFixed()}&times;${i.toFixed()}`}),c("numViews",{type:"range",min:1,max:145,step:1},{label:"# views",title:"number of different viewing angles to render",stringify:i=>i.toFixed()});const D=c("trackballX",{type:"range",min:-Math.PI,max:1.0001*Math.PI,step:.5/180*Math.PI},{label:"trackball x",title:"camera trackball x",fixRange:i=>(i+Math.PI*3)%(Math.PI*2)-Math.PI,stringify:i=>`${(i/Math.PI*180).toFixed()}&deg;`}),_=c("trackballY",{type:"range",min:-.5*Math.PI,max:.5001*Math.PI,step:1/180*Math.PI},{label:"trackball y",title:"camera trackball y",fixRange:i=>Math.max(-.5*Math.PI,Math.min(i,.5*Math.PI)),stringify:i=>`${(i/Math.PI*180).toFixed()}&deg;`}),L=c("targetX",{type:"range",min:-20,max:20,step:.1},{label:"target x",title:"target position x",fixRange:i=>i,stringify:i=>i.toFixed(2)+" m"}),I=c("targetY",{type:"range",min:-20,max:20,step:.1},{label:"target y",title:"target position y",fixRange:i=>i,stringify:i=>i.toFixed(2)+" m"}),F=c("targetZ",{type:"range",min:-20,max:20,step:.1},{label:"target z",title:"target position z",fixRange:i=>i,stringify:i=>i.toFixed(2)+" m"});c("fovy",{type:"range",min:1/180*Math.PI,max:120.1/180*Math.PI,step:1/180*Math.PI},{label:"fov",title:"perspective fov (degrades stereo effect)",fixRange:i=>Math.max(1/180*Math.PI,Math.min(i,120.1/180*Math.PI)),stringify:i=>{const r=i/Math.PI*180,l=Math.atan(Math.tan(i/2)*t.aspect)*2/Math.PI*180;return`${r.toFixed()}&deg;&times;${l.toFixed()}&deg;`}}),c("depthiness",{type:"range",min:0,max:2,step:.01},{label:"depthiness",title:'exaggerates depth by multiplying the width of the view cone (as reported by the firmware) - can somewhat compensate for depthiness lost using higher fov. 1.25 seems to be most physically accurate on Looking Glass 8.9".',fixRange:i=>Math.max(0,i),stringify:i=>`${i.toFixed(2)}x`}),c("inlineView",{type:"range",min:0,max:2,step:1},{label:"inline view",title:"what to show inline on the original canvas (swizzled = no overwrite)",fixRange:i=>Math.max(0,Math.min(i,2)),stringify:i=>i===0?"swizzled":i===1?"center":i===2?"quilt":"?"}),n.oncontextmenu=i=>{i.preventDefault()},n.addEventListener("wheel",i=>{const r=t.targetDiam,l=1.1,f=Math.log(r)/Math.log(l);return t.targetDiam=Math.pow(l,f+i.deltaY*.01)}),n.addEventListener("mousemove",i=>{const r=i.movementX,l=-i.movementY;if(i.buttons&2||i.buttons&1&&(i.shiftKey||i.ctrlKey)){const f=t.trackballX,d=t.trackballY,x=-Math.cos(f)*r+Math.sin(f)*Math.sin(d)*l,v=-Math.cos(d)*l,b=Math.sin(f)*r+Math.cos(f)*Math.sin(d)*l;L(o=>o+x*t.targetDiam*.001),I(o=>o+v*t.targetDiam*.001),F(o=>o+b*t.targetDiam*.001)}else i.buttons&1&&(D(f=>f-r*.01),_(f=>f-l*.01))});const m={w:0,a:0,s:0,d:0};n.addEventListener("keydown",i=>{switch(i.code){case"KeyW":m.w=1;break;case"KeyA":m.a=1;break;case"KeyS":m.s=1;break;case"KeyD":m.d=1;break}}),n.addEventListener("keyup",i=>{switch(i.code){case"KeyW":m.w=0;break;case"KeyA":m.a=0;break;case"KeyS":m.s=0;break;case"KeyD":m.d=0;break}}),requestAnimationFrame(E);function E(){let i=m.d-m.a,r=m.w-m.s;i&&r&&(i*=Math.sqrt(.5),r*=Math.sqrt(.5));const l=t.trackballX,f=t.trackballY,d=Math.cos(l)*i-Math.sin(l)*Math.cos(f)*r,x=-Math.sin(f)*r,v=-Math.sin(l)*i-Math.cos(l)*Math.cos(f)*r;L(b=>b+d*t.targetDiam*.03),I(b=>b+x*t.targetDiam*.03),F(b=>b+v*t.targetDiam*.03),requestAnimationFrame(E)}return a}const M=Symbol("LookingGlassXRWebGLLayer");class he extends se.default{constructor(t,e,a){super(t,e,a);const s=document.createElement("canvas");s.tabIndex=0;const y=s.getContext("2d",{alpha:!1});s.addEventListener("dblclick",function(){this.requestFullscreen()});const h=le(s),u=S(),c=this[H.PRIVATE].config,D=e.createTexture();let _,L;const I=e.createFramebuffer(),F=e.enable.bind(e),m=e.disable.bind(e),E=e.getExtension("OES_vertex_array_object"),i=34229,r=E?E.bindVertexArrayOES.bind(E):e.bindVertexArray.bind(e),l=()=>{const w=e.getParameter(e.TEXTURE_BINDING_2D);if(e.bindTexture(e.TEXTURE_2D,D),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,u.framebufferWidth,u.framebufferHeight,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.bindTexture(e.TEXTURE_2D,w),_){const C=e.getParameter(e.RENDERBUFFER_BINDING);e.bindRenderbuffer(e.RENDERBUFFER,_),e.renderbufferStorage(e.RENDERBUFFER,L.format,u.framebufferWidth,u.framebufferHeight),e.bindRenderbuffer(e.RENDERBUFFER,C)}};(c.depth||c.stencil)&&(c.depth&&c.stencil?L={format:e.DEPTH_STENCIL,attachment:e.DEPTH_STENCIL_ATTACHMENT}:c.depth?L={format:e.DEPTH_COMPONENT16,attachment:e.DEPTH_ATTACHMENT}:c.stencil&&(L={format:e.STENCIL_INDEX8,attachment:e.STENCIL_ATTACHMENT}),_=e.createRenderbuffer()),l(),u.addEventListener("on-config-changed",l);const f=e.getParameter(e.FRAMEBUFFER_BINDING);e.bindFramebuffer(e.FRAMEBUFFER,I),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,D,0),(c.depth||c.stencil)&&e.framebufferRenderbuffer(e.FRAMEBUFFER,L.attachment,e.RENDERBUFFER,_),e.bindFramebuffer(e.FRAMEBUFFER,f);const d=e.createProgram(),x=e.createShader(e.VERTEX_SHADER);e.attachShader(d,x);const v=e.createShader(e.FRAGMENT_SHADER);e.attachShader(d,v);{const w=`
       attribute vec2 a_position;
       varying vec2 v_texcoord;
       void main() {
         gl_Position = vec4(a_position * 2.0 - 1.0, 0.0, 1.0);
         v_texcoord = a_position;
       }
     `;e.shaderSource(x,w),e.compileShader(x),e.getShaderParameter(x,e.COMPILE_STATUS)||console.warn(e.getShaderInfoLog(x))}let b,o,X;const N=()=>{const w=Q.Shader(u);if(w===b)return;if(b=w,e.shaderSource(v,w),e.compileShader(v),!e.getShaderParameter(v,e.COMPILE_STATUS)){console.warn(e.getShaderInfoLog(v));return}if(e.linkProgram(d),!e.getProgramParameter(d,e.LINK_STATUS)){console.warn(e.getProgramInfoLog(d));return}o=e.getAttribLocation(d,"a_position"),X=e.getUniformLocation(d,"u_viewType");const C=e.getUniformLocation(d,"u_texture"),G=e.getParameter(e.CURRENT_PROGRAM);e.useProgram(d),e.uniform1i(C,0),e.useProgram(G)};u.addEventListener("on-config-changed",N);const B=E?E.createVertexArrayOES():e.createVertexArray(),p=e.createBuffer(),T=e.getParameter(e.ARRAY_BUFFER_BINDING),ge=e.getParameter(i);r(B),e.bindBuffer(e.ARRAY_BUFFER,p),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW),e.enableVertexAttribArray(o),e.vertexAttribPointer(o,2,e.FLOAT,!1,0,0),r(ge),e.bindBuffer(e.ARRAY_BUFFER,T);const ye=()=>{console.assert(this[M].LookingGlassEnabled),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer);const w=e.getParameter(e.COLOR_CLEAR_VALUE),C=e.getParameter(e.DEPTH_CLEAR_VALUE),G=e.getParameter(e.STENCIL_CLEAR_VALUE);e.clearColor(0,0,0,0),e.clearDepth(1),e.clearStencil(0),e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT|e.STENCIL_BUFFER_BIT),e.clearColor(w[0],w[1],w[2],w[3]),e.clearDepth(C),e.clearStencil(G)},k=e.canvas;let j,q;const Ee=()=>{if(!this[M].LookingGlassEnabled)return;(k.width!==u.calibration.screenW.value||k.height!==u.calibration.screenH.value)&&(j=k.width,q=k.height,k.width=u.calibration.screenW.value,k.height=u.calibration.screenH.value);const w=e.getParameter(i),C=e.getParameter(e.CULL_FACE),G=e.getParameter(e.BLEND),we=e.getParameter(e.DEPTH_TEST),Re=e.getParameter(e.STENCIL_TEST),xe=e.getParameter(e.SCISSOR_TEST),_e=e.getParameter(e.VIEWPORT),Te=e.getParameter(e.FRAMEBUFFER_BINDING),Pe=e.getParameter(e.RENDERBUFFER_BINDING),Le=e.getParameter(e.CURRENT_PROGRAM),Fe=e.getParameter(e.ACTIVE_TEXTURE);{const Ce=e.getParameter(e.TEXTURE_BINDING_2D);e.bindFramebuffer(e.FRAMEBUFFER,null),e.useProgram(d),r(B),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,D),e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.STENCIL_TEST),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),e.uniform1i(X,0),e.drawArrays(e.TRIANGLES,0,6),y.clearRect(0,0,s.width,s.height),y.drawImage(k,0,0),u.inlineView!==0&&(e.uniform1i(X,u.inlineView),e.drawArrays(e.TRIANGLES,0,6)),e.bindTexture(e.TEXTURE_2D,Ce)}e.activeTexture(Fe),e.useProgram(Le),e.bindRenderbuffer(e.RENDERBUFFER,Pe),e.bindFramebuffer(e.FRAMEBUFFER,Te),e.viewport(..._e),(xe?F:m)(e.SCISSOR_TEST),(Re?F:m)(e.STENCIL_TEST),(we?F:m)(e.DEPTH_TEST),(G?F:m)(e.BLEND),(C?F:m)(e.CULL_FACE),r(w)};let P;window.addEventListener("unload",()=>{P&&P.close(),P=void 0});const ve=(w,C)=>{!!P!=w&&(w?(N(),s.style.position="fixed",s.style.top="0",s.style.left="0",s.style.width="100%",s.style.height="100%",s.width=u.calibration.screenW.value,s.height=u.calibration.screenH.value,document.body.appendChild(h),P=window.open("",void 0,"width=640,height=360"),P.document.title="Looking Glass Window (fullscreen me on Looking Glass!)",P.document.body.style.background="black",P.document.body.appendChild(s),console.assert(C),P.onbeforeunload=C):(h.parentElement.removeChild(h),k.width=j,k.height=q,P.onbeforeunload=void 0,P.close(),P=void 0))};this[M]={LookingGlassEnabled:!1,framebuffer:I,clearFramebuffer:ye,blitTextureToDefaultFramebufferIfNeeded:Ee,moveCanvasToWindow:ve}}get framebuffer(){return this[M].LookingGlassEnabled?this[M].framebuffer:null}get framebufferWidth(){return S().framebufferWidth}get framebufferHeight(){return S().framebufferHeight}}class ue extends ne.default{constructor(t){super(t),this.sessions=new Map,this.viewSpaces=[],this.basePoseMatrix=g.mat4.create(),this.inlineProjectionMatrix=g.mat4.create(),this.inlineInverseViewMatrix=g.mat4.create(),this.LookingGlassProjectionMatrices=[],this.LookingGlassInverseViewMatrices=[]}onBaseLayerSet(t,e){const a=this.sessions.get(t);a.baseLayer=e;const s=e[M];s.LookingGlassEnabled=a.immersive,a.immersive&&s.moveCanvasToWindow(!0,()=>{this.endSession(t)})}isSessionSupported(t){return t==="inline"||t==="immersive-vr"}isFeatureSupported(t){switch(t){case"viewer":return!0;case"local":return!0;case"local-floor":return!0;case"bounded-floor":return!1;case"unbounded":return!1;default:return console.warn("LookingGlassXRDevice.isFeatureSupported: feature not understood:",t),!1}}async requestSession(t,e){if(!this.isSessionSupported(t))return Promise.reject();const a=t!=="inline",s=new fe(t,e);return this.sessions.set(s.id,s),a&&this.dispatchEvent("@@webxr-polyfill/vr-present-start",s.id),Promise.resolve(s.id)}requestAnimationFrame(t){return this.global.requestAnimationFrame(t)}cancelAnimationFrame(t){this.global.cancelAnimationFrame(t)}onFrameStart(t,e){const a=this.sessions.get(t),s=S();if(a.immersive){const y=Math.tan(.5*s.fovy),h=.5*s.targetDiam/y,u=h-s.targetDiam,c=this.basePoseMatrix;g.mat4.fromTranslation(c,[s.targetX,s.targetY,s.targetZ]),g.mat4.rotate(c,c,s.trackballX,[0,1,0]),g.mat4.rotate(c,c,-s.trackballY,[1,0,0]),g.mat4.translate(c,c,[0,0,h]);for(let _=0;_<s.numViews;++_){const L=(_+.5)/s.numViews-.5,I=Math.tan(s.viewCone*L),F=h*I,m=this.LookingGlassInverseViewMatrices[_]=this.LookingGlassInverseViewMatrices[_]||g.mat4.create();g.mat4.translate(m,c,[F,0,0]),g.mat4.invert(m,m);const E=Math.max(u+e.depthNear,.01),i=u+e.depthFar,r=E*y,l=r,f=-r,d=E*-I,x=s.aspect*r,v=d+x,b=d-x,o=this.LookingGlassProjectionMatrices[_]=this.LookingGlassProjectionMatrices[_]||g.mat4.create();g.mat4.set(o,2*E/(v-b),0,0,0,0,2*E/(l-f),0,0,(v+b)/(v-b),(l+f)/(l-f),-(i+E)/(i-E),-1,0,0,-2*i*E/(i-E),0)}a.baseLayer[M].clearFramebuffer()}else{const y=a.baseLayer.context,h=y.drawingBufferWidth/y.drawingBufferHeight;g.mat4.perspective(this.inlineProjectionMatrix,e.inlineVerticalFieldOfView,h,e.depthNear,e.depthFar),g.mat4.fromTranslation(this.basePoseMatrix,[0,W,0]),g.mat4.invert(this.inlineInverseViewMatrix,this.basePoseMatrix)}}onFrameEnd(t){this.sessions.get(t).baseLayer[M].blitTextureToDefaultFramebufferIfNeeded()}async requestFrameOfReferenceTransform(t,e){const a=g.mat4.create();switch(t){case"viewer":case"local":return g.mat4.fromTranslation(a,[0,-W,0]),a;case"local-floor":return a;default:throw new Error("XRReferenceSpaceType not understood")}}endSession(t){const e=this.sessions.get(t);e.immersive&&e.baseLayer&&(e.baseLayer[M].moveCanvasToWindow(!1),this.dispatchEvent("@@webxr-polyfill/vr-present-end",t)),e.ended=!0}doesSessionSupportReferenceSpace(t,e){const a=this.sessions.get(t);return a.ended?!1:a.enabledFeatures.has(e)}getViewSpaces(t){if(t==="immersive-vr"){const e=S();for(let a=this.viewSpaces.length;a<e.numViews;++a)this.viewSpaces[a]=new me(a);return this.viewSpaces.length=e.numViews,this.viewSpaces}}getViewport(t,e,a,s,y){if(y===void 0){const u=this.sessions.get(t).baseLayer.context;s.x=0,s.y=0,s.width=u.drawingBufferWidth,s.height=u.drawingBufferHeight}else{const h=S(),u=y%h.quiltWidth,c=Math.floor(y/h.quiltWidth);s.x=h.tileWidth*u,s.y=h.tileHeight*c,s.width=h.tileWidth,s.height=h.tileHeight}return!0}getProjectionMatrix(t,e){return e===void 0?this.inlineProjectionMatrix:this.LookingGlassProjectionMatrices[e]||g.mat4.create()}getBasePoseMatrix(){return this.basePoseMatrix}getBaseViewMatrix(){return this.inlineInverseViewMatrix}_getViewMatrixByIndex(t){return this.LookingGlassInverseViewMatrices[t]=this.LookingGlassInverseViewMatrices[t]||g.mat4.create()}getInputSources(){return[]}getInputPose(t,e,a){return null}onWindowResize(){}}let de=0;class fe{constructor(t,e){this.mode=t,this.immersive=t==="immersive-vr"||t==="immersive-ar",this.id=++de,this.baseLayer=null,this.inlineVerticalFieldOfView=Math.PI*.5,this.ended=!1,this.enabledFeatures=e}}class me extends ae.default{constructor(t){super(),this.viewIndex=t}get eye(){return"none"}_onPoseUpdate(t){this._inverseBaseMatrix=t._getViewMatrixByIndex(this.viewIndex)}}class be extends te.default{constructor(t){super(),console.warn(t||'Looking Glass WebXR "polyfill" overriding native WebXR API.');for(const a in O.default)this.global[a]=O.default[a];this.global.XRWebGLLayer=he,this.injected=!0;const e=Promise.resolve(new ue(this.global));this.xr=new ie.default(e),Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})}}const pe=S();R.LookingGlassConfig=pe,R.LookingGlassWebXRPolyfill=be,Object.defineProperties(R,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
