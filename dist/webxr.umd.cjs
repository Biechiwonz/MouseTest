(function(v,S){typeof exports=="object"&&typeof module<"u"?S(exports,require("@lookingglass/webxr-polyfill/src/api/index"),require("@lookingglass/webxr-polyfill/src/api/XRSystem"),require("@lookingglass/webxr-polyfill/src/WebXRPolyfill"),require("holoplay-core"),require("@lookingglass/webxr-polyfill/src/devices/XRDevice"),require("@lookingglass/webxr-polyfill/src/api/XRSpace"),require("gl-matrix"),require("@lookingglass/webxr-polyfill/src/api/XRWebGLLayer")):typeof define=="function"&&define.amd?define(["exports","@lookingglass/webxr-polyfill/src/api/index","@lookingglass/webxr-polyfill/src/api/XRSystem","@lookingglass/webxr-polyfill/src/WebXRPolyfill","holoplay-core","@lookingglass/webxr-polyfill/src/devices/XRDevice","@lookingglass/webxr-polyfill/src/api/XRSpace","gl-matrix","@lookingglass/webxr-polyfill/src/api/XRWebGLLayer"],S):(v=typeof globalThis<"u"?globalThis:v||self,S(v["Looking Glass WebXR"]={},v["@lookingglass/webxr-polyfill/src/api/index"],v["@lookingglass/webxr-polyfill/src/api/XRSystem"],v["@lookingglass/webxr-polyfill/src/WebXRPolyfill"],v.holoPlayCore,v["@lookingglass/webxr-polyfill/src/devices/XRDevice"],v["@lookingglass/webxr-polyfill/src/api/XRSpace"],v.glMatrix,v["@lookingglass/webxr-polyfill/src/api/XRWebGLLayer"]))})(this,function(v,S,A,ne,Q,re,oe,E,ee){"use strict";var Be=Object.defineProperty;var Ie=(v,S,A)=>S in v?Be(v,S,{enumerable:!0,configurable:!0,writable:!0,value:A}):v[S]=A;var L=(v,S,A)=>(Ie(v,typeof S!="symbol"?S+"":S,A),A);const B=t=>t&&typeof t=="object"&&"default"in t?t:{default:t};function le(t){if(t&&t.__esModule)return t;const i=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(t){for(const e in t)if(e!=="default"){const n=Object.getOwnPropertyDescriptor(t,e);Object.defineProperty(i,e,n.get?n:{enumerable:!0,get:()=>t[e]})}}return i.default=t,Object.freeze(i)}const te=B(S),ce=B(A),ue=B(ne),he=le(Q),de=B(re),fe=B(oe),pe=B(ee),j=1.6;var z;(function(t){t[t.Swizzled=0]="Swizzled",t[t.Center=1]="Center",t[t.Quilt=2]="Quilt"})(z||(z={}));class me extends EventTarget{constructor(e){super();L(this,"_calibration",{configVersion:"1.0",pitch:{value:45},slope:{value:-5},center:{value:-.5},viewCone:{value:40},invView:{value:1},verticalAngle:{value:0},DPI:{value:338},screenW:{value:3840},screenH:{value:2160},flipImageX:{value:0},flipImageY:{value:0},flipSubp:{value:0},serial:"",subpixelCells:[],CellPatternMode:{value:0}});L(this,"_viewControls",{tileHeight:512,numViews:48,trackballX:0,trackballY:0,targetX:0,targetY:j,targetZ:-.5,targetDiam:2,fovy:14/180*Math.PI,depthiness:1.25,inlineView:z.Center,capturing:!1,quiltResolution:null,columns:null,rows:null,popup:null,XRSession:null,lkgCanvas:null,appCanvas:null,subpixelMode:1,filterMode:1,gaussianSigma:.01});L(this,"LookingGlassDetected");this._viewControls={...this._viewControls,...e},this.syncCalibration()}syncCalibration(){new he.Client(e=>{if(e.devices.length<1){console.log("No Looking Glass devices found");return}e.devices.length>1&&console.log("More than one Looking Glass device found... using the first one"),this.calibration=e.devices[0].calibration})}addEventListener(e,n,s){super.addEventListener(e,n,s)}onConfigChange(){this.dispatchEvent(new Event("on-config-changed"))}get calibration(){return this._calibration}set calibration(e){this._calibration={...this._calibration,...e},this.onConfigChange()}updateViewControls(e){e!=null&&(this._viewControls={...this._viewControls,...e},this.onConfigChange())}get tileHeight(){return Math.round(this.framebufferHeight/this.quiltHeight)}get quiltResolution(){if(this._viewControls.quiltResolution!=null)return{width:this._viewControls.quiltResolution.width,height:this._viewControls.quiltResolution.height};{const e=this._calibration.serial;switch(!0){case e.startsWith("LKG-2K"):return{width:4096,height:4096};case e.startsWith("LKG-4K"):return{width:4096,height:4096};case e.startsWith("LKG-8K"):return{width:8192,height:8192};case e.startsWith("LKG-P"):return{width:3360,height:3360};case e.startsWith("LKG-A"):return{width:4096,height:4096};case e.startsWith("LKG-B"):return{width:8192,height:8192};case e.startsWith("LKG-D"):return{width:8192,height:8192};case e.startsWith("LKG-F"):return{width:3360,height:3360};case e.startsWith("LKG-E"):return{width:4092,height:4092};case e.startsWith("LKG-H"):return{width:5995,height:6e3};case e.startsWith("LKG-J"):return{width:5999,height:5999};case e.startsWith("LKG-K"):return{width:8184,height:8184};case e.startsWith("LKG-L"):return{width:8190,height:8190};default:return{width:4096,height:4096}}}}set quiltResolution(e){this.updateViewControls({quiltResolution:e})}get numViews(){return this.quiltWidth*this.quiltHeight}get targetX(){return this._viewControls.targetX}set targetX(e){this.updateViewControls({targetX:e})}get targetY(){return this._viewControls.targetY}set targetY(e){this.updateViewControls({targetY:e})}get targetZ(){return this._viewControls.targetZ}set targetZ(e){this.updateViewControls({targetZ:e})}get trackballX(){return this._viewControls.trackballX}set trackballX(e){this.updateViewControls({trackballX:e})}get trackballY(){return this._viewControls.trackballY}set trackballY(e){this.updateViewControls({trackballY:e})}get targetDiam(){return this._viewControls.targetDiam}set targetDiam(e){this.updateViewControls({targetDiam:e})}get fovy(){return this._viewControls.fovy}set fovy(e){this.updateViewControls({fovy:e})}get depthiness(){return this._viewControls.depthiness}set depthiness(e){this.updateViewControls({depthiness:e})}get inlineView(){return this._viewControls.inlineView}set inlineView(e){this.updateViewControls({inlineView:e})}get capturing(){return this._viewControls.capturing}set capturing(e){this.updateViewControls({capturing:e})}get subpixelMode(){return this._viewControls.subpixelMode}set subpixelMode(e){this.updateViewControls({subpixelMode:e})}get filterMode(){return this._viewControls.filterMode}set filterMode(e){this.updateViewControls({filterMode:e})}get gaussianSigma(){return this._viewControls.gaussianSigma}set gaussianSigma(e){this.updateViewControls({gaussianSigma:e})}get popup(){return this._viewControls.popup}set popup(e){this.updateViewControls({popup:e})}get XRSession(){return this._viewControls.XRSession}set XRSession(e){this.updateViewControls({XRSession:e})}get lkgCanvas(){return this._viewControls.lkgCanvas}set lkgCanvas(e){this.updateViewControls({lkgCanvas:e})}get appCanvas(){return this._viewControls.appCanvas}set appCanvas(e){this.updateViewControls({appCanvas:e})}get columns(){return this._viewControls.columns}set columns(e){this.updateViewControls({columns:e})}get rows(){return this._viewControls.rows}set rows(e){this.updateViewControls({rows:e})}get aspect(){return this._calibration.screenW.value/this._calibration.screenH.value}get tileWidth(){return Math.round(this.framebufferWidth/this.quiltWidth)}get framebufferWidth(){return this.quiltResolution.width}get quiltWidth(){if(this._viewControls.columns!=null)return this._viewControls.columns;const e=this._calibration.serial;switch(!0){case e.startsWith("LKG-2K"):return 5;case e.startsWith("LKG-4K"):return 5;case e.startsWith("LKG-8K"):return 5;case e.startsWith("LKG-P"):return 8;case e.startsWith("LKG-A"):return 5;case e.startsWith("LKG-B"):return 5;case e.startsWith("LKG-D"):return 8;case e.startsWith("LKG-F"):return 8;case e.startsWith("LKG-E"):return 11;case e.startsWith("LKG-H"):return 11;case e.startsWith("LKG-J"):return 7;case e.startsWith("LKG-K"):return 11;case e.startsWith("LKG-L"):return 7;default:return 1}}get quiltHeight(){if(this._viewControls.rows!=null)return this._viewControls.rows;const e=this._calibration.serial;switch(!0){case e.startsWith("LKG-2K"):return 9;case e.startsWith("LKG-4K"):return 9;case e.startsWith("LKG-8K"):return 9;case e.startsWith("LKG-P"):return 6;case e.startsWith("LKG-A"):return 9;case e.startsWith("LKG-B"):return 9;case e.startsWith("LKG-D"):return 9;case e.startsWith("LKG-F"):return 6;case e.startsWith("LKG-E"):return 6;case e.startsWith("LKG-H"):return 6;case e.startsWith("LKG-J"):return 7;case e.startsWith("LKG-K"):return 6;case e.startsWith("LKG-L"):return 7;default:return 1}}get framebufferHeight(){return this.quiltResolution.height}get viewCone(){return this._calibration.viewCone.value*this.depthiness/180*Math.PI}get tilt(){return this._calibration.screenH.value/(this._calibration.screenW.value*this._calibration.slope.value)*(this._calibration.flipImageX.value?-1:1)}get subp(){return 1/(this._calibration.screenW.value*3)*(this._calibration.flipImageX.value?-1:1)}get pitch(){return this._calibration.pitch.value*this._calibration.screenW.value/this._calibration.DPI.value*Math.cos(Math.atan(1/this._calibration.slope.value))}get subpixelCells(){const e=new Float32Array(6*this._calibration.subpixelCells.length);return this._calibration.subpixelCells.forEach((n,s)=>{n.ROffsetX/=this.calibration.screenW.value,n.ROffsetY/=this.calibration.screenH.value,n.GOffsetX/=this.calibration.screenW.value,n.GOffsetY/=this.calibration.screenH.value,n.BOffsetX/=this.calibration.screenW.value,n.BOffsetY/=this.calibration.screenH.value,e[s*6+0]=n.ROffsetX,e[s*6+1]=n.ROffsetY,e[s*6+2]=n.GOffsetX,e[s*6+3]=n.GOffsetY,e[s*6+4]=n.BOffsetX,e[s*6+5]=n.BOffsetY}),e}}let Z=null;function M(){return Z==null&&(Z=new me),Z}function ie(t){const i=M();t!=null&&i.updateViewControls(t)}async function be(){const t=M();let i=2;async function e(){if(t.appCanvas!=null)try{t.capturing=!0,await new Promise(u=>{requestAnimationFrame(u)}),t.appCanvas.width=t.quiltResolution.width,t.appCanvas.height=t.quiltResolution.height;let s=t.appCanvas.toDataURL();const l=document.createElement("a");l.style.display="none",l.href=s,l.download=`hologram_qs${t.quiltWidth}x${t.quiltHeight}a${t.aspect}.png`,document.body.appendChild(l),l.click(),document.body.removeChild(l),window.URL.revokeObjectURL(s)}catch(s){console.error("Error while capturing canvas data:",s),t.capturing=!1}finally{t.inlineView=i,t.capturing=!1,t.appCanvas.width=t.calibration.screenW.value,t.appCanvas.height=t.calibration.screenH.value}}const n=document.getElementById("screenshotbutton");n&&n.addEventListener("click",()=>{i=t.inlineView;const s=I.getInstance();if(!s){console.warn("LookingGlassXRDevice not initialized");return}t.inlineView=2,s.captureScreenshot=!0,setTimeout(()=>{s.screenshotCallback=e},100)})}function ve(){var e,n,s,l,u;const t=M();if(t.lkgCanvas==null)console.warn("window placement called without a valid XR Session!");else{const m=document.createElement("style");document.head.appendChild(m),(e=m.sheet)==null||e.insertRule("#LookingGlassWebXRControls * { all: revert; font-family: sans-serif }");const o=document.createElement("div");o.id="LookingGlassWebXRControls",o.style.position="fixed",o.style.zIndex="1000",o.style.padding="15px",o.style.width="320px",o.style.maxWidth="calc(100vw - 18px)",o.style.maxHeight="calc(100vh - 18px)",o.style.whiteSpace="nowrap",o.style.background="rgba(0, 0, 0, 0.6)",o.style.color="white",o.style.borderRadius="10px",o.style.right="15px",o.style.bottom="15px",o.style.flex="row";const p=document.createElement("div");o.appendChild(p),p.style.width="100%",p.style.textAlign="center",p.style.fontWeight="bold",p.style.marginBottom="8px",p.innerText="Looking Glass Controls";const h=document.createElement("button");h.style.display="block",h.style.margin="auto",h.style.width="100%",h.style.height="35px",h.style.padding="4px",h.style.marginBottom="8px",h.style.borderRadius="8px",h.id="screenshotbutton",o.appendChild(h),h.innerText="Save Hologram",t.quiltResolution.height*t.quiltResolution.width>33177600?(h.style.backgroundColor="#ccc",h.style.color="#999",h.style.cursor="not-allowed",h.title="Button is disabled because the quilt resolution is too large."):(h.style.backgroundColor="",h.style.color="",h.style.cursor="",h.title="");const w=document.createElement("button");w.style.display="block",w.style.margin="auto",w.style.width="100%",w.style.height="35px",w.style.padding="4px",w.style.marginBottom="8px",w.style.borderRadius="8px",w.id="copybutton",o.appendChild(w),w.innerText="Copy Config",w.addEventListener("click",()=>{we(t)});const g=document.createElement("div");o.appendChild(g),g.style.width="290px",g.style.whiteSpace="normal",g.style.color="rgba(255,255,255,0.7)",g.style.fontSize="14px",g.style.margin="5px 0",g.innerHTML="mousetest23 Click the popup and use WASD, mouse left/right drag, and scroll.";const x=document.createElement("div");o.appendChild(x);const _=(a,d,r)=>{const f=r.stringify,b=document.createElement("div");b.style.marginBottom="8px",x.appendChild(b);const P=a,k=t[a],y=document.createElement("label");b.appendChild(y),y.innerText=r.label,y.setAttribute("for",P),y.style.width="100px",y.style.display="inline-block",y.style.textDecoration="dotted underline 1px",y.style.fontFamily='"Courier New"',y.style.fontSize="13px",y.style.fontWeight="bold",y.title=r.title;const C=document.createElement("input");b.appendChild(C),Object.assign(C,d),C.id=P,C.title=r.title,C.value=d.value!==void 0?d.value:k;const N=R=>{t[a]=R,K(R)};C.oninput=()=>{const R=d.type==="range"?parseFloat(C.value):d.type==="checkbox"?C.checked:C.value;N(R)};const q=R=>{let F=R(t[a]);r.fixRange&&(F=r.fixRange(F),C.max=Math.max(parseFloat(C.max),F).toString(),C.min=Math.min(parseFloat(C.min),F).toString()),C.value=F,N(F)};d.type==="range"&&(C.style.width="110px",C.style.height="8px",C.onwheel=R=>{q(F=>F+Math.sign(R.deltaX-R.deltaY)*d.step)});let K=R=>{};if(f){const R=document.createElement("span");R.style.fontFamily='"Courier New"',R.style.fontSize="13px",R.style.marginLeft="3px",b.appendChild(R),K=F=>{R.innerHTML=f(F)},K(k)}return q};_("fovy",{type:"range",min:1/180*Math.PI,max:120.1/180*Math.PI,step:1/180*Math.PI},{label:"fov",title:"perspective fov (degrades stereo effect)",fixRange:a=>Math.max(1/180*Math.PI,Math.min(a,120.1/180*Math.PI)),stringify:a=>{const d=a/Math.PI*180,r=Math.atan(Math.tan(a/2)*t.aspect)*2/Math.PI*180;return`${d.toFixed()}&deg;&times;${r.toFixed()}&deg;`}}),_("depthiness",{type:"range",min:0,max:2,step:.01},{label:"depthiness",title:"exaggerates depth by multiplying the width of the view cone (as reported by the firmware) - can somewhat compensate for depthiness lost using higher fov.",fixRange:a=>Math.max(0,a),stringify:a=>`${a.toFixed(2)}x`}),_("inlineView",{type:"range",min:0,max:2,step:1},{label:"inline view",title:"what to show inline on the original canvas (swizzled = no overwrite)",fixRange:a=>Math.max(0,Math.min(a,2)),stringify:a=>a===0?"swizzled":a===1?"center":a===2?"quilt":"?"}),_("filterMode",{type:"range",min:0,max:3,step:1},{label:"view filtering mode",title:"controls the method used for view blending",fixRange:a=>Math.max(0,Math.min(a,2)),stringify:a=>a===0?"old, studio style":a===1?"2 view":a===2?"gaussian":a===3?"10 view gaussian":"?"}),_("gaussianSigma",{type:"range",min:-1,max:1,step:.01},{label:"gaussian sigma",title:"control view blending",fixRange:a=>Math.max(-1,Math.min(a,1)),stringify:a=>a}),t.lkgCanvas.oncontextmenu=a=>{a.preventDefault()},t.lkgCanvas.addEventListener("wheel",a=>{const d=t.targetDiam,r=1.1,f=Math.log(d)/Math.log(r);return t.targetDiam=Math.pow(r,f+a.deltaY*.01)},{passive:!1}),t.lkgCanvas.addEventListener("mousemove",a=>{const d=a.movementX,r=-a.movementY;if(a.buttons&1&&a.ctrlKey){const f=t.trackballX,b=t.trackballY,P=-Math.cos(f)*d+Math.sin(f)*Math.sin(b)*r,k=-Math.cos(b)*r,y=Math.sin(f)*d+Math.cos(f)*Math.sin(b)*r;t.targetX=t.targetX+P*t.targetDiam*.001,t.targetY=t.targetY+k*t.targetDiam*.001,t.targetZ=t.targetZ+y*t.targetDiam*.001}else t.trackballY=t.trackballY-r*.01,t.trackballX=t.trackballX-d*.01}),t.lkgCanvas.addEventListener("keydown",a=>{switch(a.code){}}),t.lkgCanvas.addEventListener("keyup",a=>{switch(a.code){}}),(n=t.appCanvas)==null||n.addEventListener("wheel",a=>{const d=t.targetDiam,r=1.1,f=Math.log(d)/Math.log(r);return t.targetDiam=Math.pow(r,f+a.deltaY*.01)},{passive:!1}),(s=t.appCanvas)==null||s.addEventListener("mousemove",a=>{const d=a.movementX,r=-a.movementY;if(a.buttons&1&&a.ctrlKey){const f=t.trackballX,b=t.trackballY,P=-Math.cos(f)*d+Math.sin(f)*Math.sin(b)*r,k=-Math.cos(b)*r,y=Math.sin(f)*d+Math.cos(f)*Math.sin(b)*r;t.targetX=t.targetX+P*t.targetDiam*.001,t.targetY=t.targetY+k*t.targetDiam*.001,t.targetZ=t.targetZ+y*t.targetDiam*.001}else g.innerHTML=t.trackballY.toString(),-.5<=t.trackballY&&t.trackballY<=.5&&(t.trackballY=t.trackballY-r*.01,t.trackballX=t.trackballX-d*.01)})}(l=t.appCanvas)==null||l.addEventListener("keydown",m=>{switch(m.code){case"KeyW":keys.w=1;break;case"KeyA":keys.a=1;break;case"KeyS":keys.s=1;break;case"KeyD":keys.d=1;break}}),(u=t.appCanvas)==null||u.addEventListener("keyup",m=>{switch(m.code){case"KeyW":keys.w=0;break;case"KeyA":keys.a=0;break;case"KeyS":keys.s=0;break;case"KeyD":keys.d=0;break}}),requestAnimationFrame(i);function i(){let m=keys.d-keys.a,o=keys.w-keys.s;m&&o&&(m*=Math.sqrt(.5),o*=Math.sqrt(.5));const p=t.trackballX,h=t.trackballY,W=Math.cos(p)*m-Math.sin(p)*Math.cos(h)*o,w=-Math.sin(h)*o,g=-Math.sin(p)*m-Math.cos(p)*Math.cos(h)*o;t.targetX=t.targetX+W*t.targetDiam*.03,t.targetY=t.targetY+w*t.targetDiam*.03,t.targetZ=t.targetZ+g*t.targetDiam*.03,requestAnimationFrame(i)}return setTimeout(()=>{be()},1e3),c}function we(t){const i={targetX:t.targetX,targetY:t.targetY,targetZ:t.targetZ,fovy:`${Math.round(t.fovy/Math.PI*180)} * Math.PI / 180`,targetDiam:t.targetDiam,trackballX:t.trackballX,trackballY:t.trackballY,depthiness:t.depthiness};let e=JSON.stringify(i,null,4).replace(/"/g,"").replace(/{/g,"").replace(/}/g,"");navigator.clipboard.writeText(e)}let Y;const ge=(t,i)=>{const e=M();if(e.lkgCanvas==null){console.warn("window placement called without a valid XR Session!");return}else t==!1?Ee(e,Y):(Y==null&&(Y=ve()),e.lkgCanvas.style.position="fixed",e.lkgCanvas.style.bottom="0",e.lkgCanvas.style.left="0",e.lkgCanvas.width=e.calibration.screenW.value,e.lkgCanvas.height=e.calibration.screenH.value,document.body.appendChild(Y),"getScreenDetails"in window?ye(e.lkgCanvas,e,i):se(e,e.lkgCanvas,i))};async function ye(t,i,e){const s=(await window.getScreenDetails()).screens.filter(l=>l.label.includes("LKG"))[0];if(s===void 0){console.log("no Looking Glass monitor detected - manually opening popup window"),se(i,t,e);return}else{const l=[`left=${s.left}`,`top=${s.top}`,`width=${s.width}`,`height=${s.height}`,"menubar=no","toolbar=no","location=no","status=no","resizable=yes","scrollbars=no","fullscreenEnabled=true"].join(",");i.popup=window.open("","new",l),i.popup&&(i.popup.document.body.style.background="black",i.popup.document.body.style.transform="1.0",ae(i),i.popup.document.body.appendChild(t),console.assert(e),i.popup.onbeforeunload=e)}}function se(t,i,e){t.popup=window.open("",void 0,"width=640,height=360"),t.popup&&(t.popup.document.title="Looking Glass Window (fullscreen me on Looking Glass!)",t.popup.document.body.style.background="black",t.popup.document.body.style.transform="1.0",ae(t),t.popup.document.body.appendChild(i),console.assert(e),t.popup.onbeforeunload=e)}function Ee(t,i){var e;(e=i.parentElement)==null||e.removeChild(i),t.popup&&(t.popup.onbeforeunload=null,t.popup.close(),t.popup=null)}function ae(t){t.popup&&t.popup.document.addEventListener("keydown",i=>{i.ctrlKey&&(i.key==="="||i.key==="-"||i.key==="+")&&i.preventDefault()})}const D=Symbol("LookingGlassXRWebGLLayer");class Ce extends pe.default{constructor(i,e,n){super(i,e,n);const s=M();s.appCanvas=e.canvas,s.lkgCanvas=document.createElement("canvas"),s.lkgCanvas.tabIndex=0;const l=s.lkgCanvas.getContext("2d",{alpha:!1});s.lkgCanvas.addEventListener("dblclick",function(){this.requestFullscreen()});const u=this[ee.PRIVATE].config,m=e.createTexture();let o,p;const h=e.createFramebuffer(),W=e.enable.bind(e),w=e.disable.bind(e),g=e.getExtension("OES_vertex_array_object"),x=34229,_=g?g.bindVertexArrayOES.bind(g):e.bindVertexArray.bind(e),a=()=>{const T=e.getParameter(e.TEXTURE_BINDING_2D);if(e.bindTexture(e.TEXTURE_2D,m),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,s.framebufferWidth,s.framebufferHeight,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_BASE_LEVEL,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAX_LEVEL,0),e.bindTexture(e.TEXTURE_2D,T),o){const X=e.getParameter(e.RENDERBUFFER_BINDING);e.bindRenderbuffer(e.RENDERBUFFER,o),e.renderbufferStorage(e.RENDERBUFFER,p.format,s.framebufferWidth,s.framebufferHeight),e.bindRenderbuffer(e.RENDERBUFFER,X)}};(u.depth||u.stencil)&&(u.depth&&u.stencil?p={format:e.DEPTH_STENCIL,attachment:e.DEPTH_STENCIL_ATTACHMENT}:u.depth?p={format:e.DEPTH_COMPONENT16,attachment:e.DEPTH_ATTACHMENT}:u.stencil&&(p={format:e.STENCIL_INDEX8,attachment:e.STENCIL_ATTACHMENT}),o=e.createRenderbuffer()),a(),s.addEventListener("on-config-changed",a);const d=e.getParameter(e.FRAMEBUFFER_BINDING);e.bindFramebuffer(e.FRAMEBUFFER,h),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,m,0),(u.depth||u.stencil)&&e.framebufferRenderbuffer(e.FRAMEBUFFER,p.attachment,e.RENDERBUFFER,o),e.bindFramebuffer(e.FRAMEBUFFER,d);const r=e.createProgram();if(!r)return;const f=e.createShader(e.VERTEX_SHADER);if(!f)return;e.attachShader(r,f);const b=e.createShader(e.FRAGMENT_SHADER);if(!b)return;e.attachShader(r,b);{const T=`#version 300 es
			in vec2 a_position;
			out vec2 v_texcoord;
			void main() {
			  gl_Position = vec4(a_position * 2.0 - 1.0, 0.0, 1.0);
			  v_texcoord = a_position;
			}
		  `;e.shaderSource(f,T),e.compileShader(f),e.getShaderParameter(f,e.COMPILE_STATUS)||console.warn(e.getShaderInfoLog(f))}let P,k,y;const C=()=>{const T=Q.Shader(s);if(T===P||(P=T,!b))return;if(e.shaderSource(b,T),e.compileShader(b),!e.getShaderParameter(b,e.COMPILE_STATUS)){console.warn(e.getShaderInfoLog(b));return}if(!r)return;if(e.linkProgram(r),!e.getProgramParameter(r,e.LINK_STATUS)){console.warn(e.getProgramInfoLog(r));return}k=e.getAttribLocation(r,"a_position"),y=e.getUniformLocation(r,"u_viewType");const X=e.getUniformLocation(r,"u_texture"),O=e.getUniformLocation(r,"subpixelData"),J=e.getParameter(e.CURRENT_PROGRAM);e.useProgram(r),e.uniform1i(X,0),e.uniform1fv(O,s.subpixelCells),e.useProgram(J)};s.addEventListener("on-config-changed",C);const N=g?g.createVertexArrayOES():e.createVertexArray(),q=e.createBuffer(),K=e.getParameter(e.ARRAY_BUFFER_BINDING),R=e.getParameter(x);_(N),e.bindBuffer(e.ARRAY_BUFFER,q),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW),e.enableVertexAttribArray(k),e.vertexAttribPointer(k,2,e.FLOAT,!1,0,0),_(R),e.bindBuffer(e.ARRAY_BUFFER,K);const F=()=>{console.assert(this[D].LookingGlassEnabled),e.bindFramebuffer(e.FRAMEBUFFER,h);const T=e.getParameter(e.COLOR_CLEAR_VALUE),X=e.getParameter(e.DEPTH_CLEAR_VALUE),O=e.getParameter(e.STENCIL_CLEAR_VALUE);e.clearColor(0,0,0,0),e.clearDepth(1),e.clearStencil(0),e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT|e.STENCIL_BUFFER_BIT),e.clearColor(T[0],T[1],T[2],T[3]),e.clearDepth(X),e.clearStencil(O)},G=e.canvas;let U,H;const Se=()=>{if(!this[D].LookingGlassEnabled)return;(G.width!==s.calibration.screenW.value||G.height!==s.calibration.screenH.value)&&s.capturing===!1?(U=G.width,H=G.height,G.width=s.calibration.screenW.value,G.height=s.calibration.screenH.value):s.capturing===!0&&(U=G.width,H=G.height,G.width=s.framebufferWidth,G.height=s.framebufferHeight);const T=e.getParameter(x),X=e.getParameter(e.CULL_FACE),O=e.getParameter(e.BLEND),J=e.getParameter(e.DEPTH_TEST),Me=e.getParameter(e.STENCIL_TEST),Pe=e.getParameter(e.SCISSOR_TEST),Ge=e.getParameter(e.VIEWPORT),Fe=e.getParameter(e.FRAMEBUFFER_BINDING),De=e.getParameter(e.RENDERBUFFER_BINDING),We=e.getParameter(e.CURRENT_PROGRAM),Ae=e.getParameter(e.ACTIVE_TEXTURE);{const Xe=e.getParameter(e.TEXTURE_BINDING_2D);e.bindFramebuffer(e.FRAMEBUFFER,null),e.useProgram(r),_(N),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,m),e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.STENCIL_TEST),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),e.uniform1i(y,0),e.drawArrays(e.TRIANGLES,0,6),l==null||l.clearRect(0,0,s.calibration.screenW.value,s.calibration.screenH.value),l==null||l.drawImage(G,0,0),s.inlineView!==0&&(e.uniform1i(y,s.inlineView),e.drawArrays(e.TRIANGLES,0,6)),e.bindTexture(e.TEXTURE_2D,Xe)}e.activeTexture(Ae),e.useProgram(We),e.bindRenderbuffer(e.RENDERBUFFER,De),e.bindFramebuffer(e.FRAMEBUFFER,Fe),e.viewport(...Ge),(Pe?W:w)(e.SCISSOR_TEST),(Me?W:w)(e.STENCIL_TEST),(J?W:w)(e.DEPTH_TEST),(O?W:w)(e.BLEND),(X?W:w)(e.CULL_FACE),_(T)};this[D]={LookingGlassEnabled:!1,framebuffer:h,clearFramebuffer:F,blitTextureToDefaultFramebufferIfNeeded:Se,moveCanvasToWindow:ge,restoreOriginalCanvasDimensions:()=>{U&&H&&(G.width=U,G.height=H,U=H=void 0)}}}get framebuffer(){return this[D].LookingGlassEnabled?this[D].framebuffer:null}get framebufferWidth(){return M().framebufferWidth}get framebufferHeight(){return M().framebufferHeight}}const V=class extends de.default{constructor(i){super(i),this.sessions=new Map,this.viewSpaces=[],this.basePoseMatrix=E.mat4.create(),this.inlineProjectionMatrix=E.mat4.create(),this.inlineInverseViewMatrix=E.mat4.create(),this.LookingGlassProjectionMatrices=[],this.LookingGlassInverseViewMatrices=[],this.captureScreenshot=!1,this.screenshotCallback=null,V.instance||(V.instance=this)}static getInstance(){return V.instance}onBaseLayerSet(i,e){const n=this.sessions.get(i);n.baseLayer=e;const s=M(),l=e[D];l.LookingGlassEnabled=n.immersive,n.immersive&&(s.XRSession=this.sessions.get(i),s.popup==null?l.moveCanvasToWindow(!0,()=>{this.endSession(i)}):console.warn("attempted to assign baselayer twice?"))}isSessionSupported(i){return i==="inline"||i==="immersive-vr"}isFeatureSupported(i){switch(i){case"viewer":return!0;case"local":return!0;case"local-floor":return!0;case"bounded-floor":return!1;case"unbounded":return!1;default:return console.warn("LookingGlassXRDevice.isFeatureSupported: feature not understood:",i),!1}}async requestSession(i,e){if(!this.isSessionSupported(i))return Promise.reject();const n=i!=="inline",s=new Le(i,e),l=M();return this.sessions.set(s.id,s),n&&(this.dispatchEvent("@@webxr-polyfill/vr-present-start",s.id),window.addEventListener("unload",()=>{l.popup&&l.popup.close(),l.popup=null})),Promise.resolve(s.id)}requestAnimationFrame(i){return this.global.requestAnimationFrame(i)}cancelAnimationFrame(i){this.global.cancelAnimationFrame(i)}onFrameStart(i,e){const n=this.sessions.get(i),s=M();if(n.immersive){const l=Math.tan(.5*s.fovy),u=.5*s.targetDiam/l,m=u-s.targetDiam,o=this.basePoseMatrix;E.mat4.fromTranslation(o,[s.targetX,s.targetY,s.targetZ]),E.mat4.rotate(o,o,s.trackballX,[0,1,0]),E.mat4.rotate(o,o,-s.trackballY,[1,0,0]),E.mat4.translate(o,o,[0,0,u]);for(let p=0;p<s.numViews;++p){const h=(p+.5)/s.numViews-.5,W=Math.tan(s.viewCone*h),w=u*W,g=this.LookingGlassInverseViewMatrices[p]=this.LookingGlassInverseViewMatrices[p]||E.mat4.create();E.mat4.translate(g,o,[w,0,0]),E.mat4.invert(g,g);const x=Math.max(m+e.depthNear,.01),_=m+e.depthFar,a=x*l,d=a,r=-a,f=x*-W,b=s.aspect*a,P=f+b,k=f-b,y=this.LookingGlassProjectionMatrices[p]=this.LookingGlassProjectionMatrices[p]||E.mat4.create();E.mat4.set(y,2*x/(P-k),0,0,0,0,2*x/(d-r),0,0,(P+k)/(P-k),(d+r)/(d-r),-(_+x)/(_-x),-1,0,0,-2*_*x/(_-x),0)}}else{const l=n.baseLayer.context,u=l.drawingBufferWidth/l.drawingBufferHeight;E.mat4.perspective(this.inlineProjectionMatrix,e.inlineVerticalFieldOfView,u,e.depthNear,e.depthFar),E.mat4.fromTranslation(this.basePoseMatrix,[0,j,0]),E.mat4.invert(this.inlineInverseViewMatrix,this.basePoseMatrix),n.baseLayer[D].clearFramebuffer()}}onFrameEnd(i){this.sessions.get(i).baseLayer[D].blitTextureToDefaultFramebufferIfNeeded(),this.captureScreenshot&&this.screenshotCallback&&(this.screenshotCallback(),this.captureScreenshot=!1)}async requestFrameOfReferenceTransform(i,e){const n=E.mat4.create();switch(i){case"viewer":case"local":return E.mat4.fromTranslation(n,[0,-j,0]),n;case"local-floor":return n;default:throw new Error("XRReferenceSpaceType not understood")}}endSession(i){const e=this.sessions.get(i);e.immersive&&e.baseLayer&&(e.baseLayer[D].moveCanvasToWindow(!1),e.baseLayer[D].LookingGlassEnabled=!1,e.baseLayer[D].restoreOriginalCanvasDimensions(),this.dispatchEvent("@@webxr-polyfill/vr-present-end",i)),e.ended=!0}doesSessionSupportReferenceSpace(i,e){const n=this.sessions.get(i);return n.ended?!1:n.enabledFeatures.has(e)}getViewSpaces(i){if(i==="immersive-vr"){const e=M();for(let n=this.viewSpaces.length;n<e.numViews;++n)this.viewSpaces[n]=new _e(n);return this.viewSpaces.length=e.numViews,this.viewSpaces}}getViewport(i,e,n,s,l){if(l===void 0){const m=this.sessions.get(i).baseLayer.context;s.x=0,s.y=0,s.width=m.drawingBufferWidth,s.height=m.drawingBufferHeight}else{const u=M(),m=l%u.quiltWidth,o=Math.floor(l/u.quiltWidth);s.x=u.framebufferWidth/u.quiltWidth*m,s.y=u.framebufferHeight/u.quiltHeight*o,s.width=u.framebufferWidth/u.quiltWidth,s.height=u.framebufferHeight/u.quiltHeight}return!0}getProjectionMatrix(i,e){return e===void 0?this.inlineProjectionMatrix:this.LookingGlassProjectionMatrices[e]||E.mat4.create()}getBasePoseMatrix(){return this.basePoseMatrix}getBaseViewMatrix(){return this.inlineInverseViewMatrix}_getViewMatrixByIndex(i){return this.LookingGlassInverseViewMatrices[i]=this.LookingGlassInverseViewMatrices[i]||E.mat4.create()}getInputSources(){return[]}getInputPose(i,e,n){return null}onWindowResize(){}};let I=V;L(I,"instance",null);let Re=0;class Le{constructor(i,e){L(this,"mode");L(this,"immersive");L(this,"id");L(this,"baseLayer");L(this,"inlineVerticalFieldOfView");L(this,"ended");L(this,"enabledFeatures");this.mode=i,this.immersive=i==="immersive-vr"||i==="immersive-ar",this.id=++Re,this.baseLayer=null,this.inlineVerticalFieldOfView=Math.PI*.5,this.ended=!1,this.enabledFeatures=e}}class _e extends fe.default{constructor(e){super();L(this,"viewIndex");this.viewIndex=e}get eye(){return"none"}_onPoseUpdate(e){this._inverseBaseMatrix=e._getViewMatrixByIndex(this.viewIndex)}}class $ extends ue.default{constructor(e){super();L(this,"vrButton");L(this,"device");L(this,"isPresenting",!1);ie(e),this.loadPolyfill()}static async init(e){new $(e)}async loadPolyfill(){this.overrideDefaultVRButton(),console.warn('Looking Glass WebXR "polyfill" overriding native WebXR API.');for(const e in te.default)this.global[e]=te.default[e];this.global.XRWebGLLayer=Ce,this.injected=!0,this.device=new I(this.global),this.xr=new ce.default(Promise.resolve(this.device)),Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})}async overrideDefaultVRButton(){this.vrButton=await xe("VRButton"),this.vrButton&&this.device?(this.device.addEventListener("@@webxr-polyfill/vr-present-start",()=>{this.isPresenting=!0,this.updateVRButtonUI()}),this.device.addEventListener("@@webxr-polyfill/vr-present-end",()=>{this.isPresenting=!1,this.updateVRButtonUI()}),this.vrButton.addEventListener("click",e=>{this.updateVRButtonUI()}),this.updateVRButtonUI()):console.warn("Unable to find VRButton")}async updateVRButtonUI(){if(this.vrButton){await ke(100),this.isPresenting?this.vrButton.innerHTML="EXIT LOOKING GLASS":this.vrButton.innerHTML="ENTER LOOKING GLASS";const e=220;this.vrButton.style.width=`${e}px`,this.vrButton.style.left=`calc(50% - ${e/2}px)`}}update(e){ie(e)}}async function xe(t){return new Promise(i=>{const e=new MutationObserver(function(n){n.forEach(function(s){s.addedNodes.forEach(function(l){const u=l;u.id===t&&(i(u),e.disconnect())})})});e.observe(document.body,{subtree:!1,childList:!0}),setTimeout(()=>{e.disconnect(),i(null)},5e3)})}function ke(t){return new Promise(i=>setTimeout(i,t))}const Te=M();v.LookingGlassConfig=Te,v.LookingGlassWebXRPolyfill=$,Object.defineProperties(v,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
